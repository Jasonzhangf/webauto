# 🚨 系统安全规则 - 最高优先级

## ⚠️ **最重要的安全规则**

### **规则 #1: 访问错误时立即停止**
当访问网页链接时发生**任何错误**，必须**立即停止所有操作**，不得继续尝试。

#### **错误类型包括：**
- ❌ HTTP 403 (Forbidden)
- ❌ HTTP 404 (Not Found)
- ❌ HTTP 429 (Too Many Requests)
- ❌ HTTP 503 (Service Unavailable)
- ❌ 连接超时 (Timeout)
- ❌ DNS 解析失败
- ❌ SSL/TLS 证书错误
- ❌ 页面加载失败
- ❌ 元素查找失败
- ❌ Cookie 认证失败

#### **立即停止的操作：**
1. 🛑 **停止所有页面访问**
2. 🛑 **停止所有滚动操作**
3. 🛑 **停止所有数据提取**
4. 🛑 **停止所有重试机制**
5. 🛑 **记录错误日志**
6. 🛑 **等待人工干预**

## 🛡️ **防拉黑机制**

### **访问频率控制**
- ⏰ **最小访问间隔**: 3-5秒
- ⏰ **页面加载等待**: 2-3秒
- ⏰ **错误后冷却时间**: 30-60秒

### **重试限制**
- 🔄 **最大重试次数**: 1次
- 🔄 **重试间隔**: 指数退避
- 🔄 **连续错误后**: 立即停止

### **User-Agent 轮换**
- 🔄 **使用真实浏览器UA**
- 🔄 **定期更换UA字符串**
- 🔄 **避免自动化工具特征**

## 📋 **错误处理流程**

### **Step 1: 错误检测**
```javascript
if (error occurs) {
  console.error('🚨 访问错误:', error.message);
  return false; // 立即返回
}
```

### **Step 2: 立即停止**
```javascript
async function safePageAccess(page, url) {
  try {
    const response = await page.goto(url, {
      timeout: 10000,
      waitUntil: 'domcontentloaded'
    });

    if (response.status() >= 400) {
      console.error(`🚨 HTTP ${response.status()}: ${url}`);
      return false;
    }

    return true;
  } catch (error) {
    console.error(`🚨 访问失败: ${url}`, error.message);
    return false;
  }
}
```

### **Step 3: 错误后处理**
```javascript
if (!accessSuccess) {
  // 1. 记录错误
  logError(url, error);

  // 2. 等待冷却
  await new Promise(resolve => setTimeout(resolve, 30000));

  // 3. 返回失败
  return { success: false, reason: 'ACCESS_ERROR' };
}
```

## 🔍 **风险信号监控**

### **高风险信号**
- 🚨 连续3次访问失败
- 🚨 HTTP 429错误
- 🚨 验证码页面
- 🚨 登录页面重定向
- 🚨 空内容返回

### **中风险信号**
- ⚠️ 页面加载缓慢 (>10秒)
- ⚠️ 元素查找失败
- ⚠️ Cookie失效
- ⚠️ 频率限制警告

### **应对措施**
1. **高风险**: 立即停止所有操作，等待6小时
2. **中风险**: 降低访问频率，增加等待时间

## 📊 **安全监控指标**

### **必须监控的指标**
- ✅ 访问成功率
- ✅ 错误类型分布
- ✅ 平均响应时间
- ✅ 访问频率
- ✅ IP信誉状态

### **安全阈值**
- 📉 **最低成功率**: 80%
- 📈 **最高错误率**: 20%
- ⏱️ **最短访问间隔**: 3秒
- 🔄 **最大重试次数**: 1次

## 🎯 **实施要求**

### **代码层面**
1. **所有页面访问**必须使用try-catch
2. **所有HTTP错误**必须立即处理
3. **所有超时**必须设置合理值
4. **所有重试**必须有限制

### **配置层面**
1. **设置合理的超时时间**
2. **启用自动重试限制**
3. **配置访问频率控制**
4. **启用错误日志记录**

### **监控层面**
1. **实时监控访问状态**
2. **定期检查错误日志**
3. **分析访问模式**
4. **调整安全策略**

## 🚨 **违反规则的后果**

### **短期后果**
- ❌ IP地址被临时封锁
- ❌ 账号被限制访问
- ❌ 验证码频繁出现

### **长期后果**
- ❌ IP地址被永久拉黑
- ❌ 账号被冻结
- ❌ 法律风险

### **系统影响**
- ❌ 数据采集失败
- ❌ 服务不可用
- ❌ 信誉损失

---

**⚠️ 重要提醒**: 这些规则是系统的**最高优先级**，任何情况下都不能违反。安全比数据更重要！