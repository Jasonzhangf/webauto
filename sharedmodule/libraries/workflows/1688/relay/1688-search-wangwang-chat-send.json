{
  "name": "1688 搜索-旺旺-聊天接力(发送)",
  "description": "预登录 → GBK关键词搜索 → 选定索引 → 打开聊天页 → 真实发送消息 → 关闭Tab切回搜索",
  "version": "1.0.0",
  "variables": { "keyword": "钢化膜", "startIndex": 0, "chatMessage": "你好" },
  "preflows": ["1688-login-preflow"],
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "开始", "next": ["attach"] },
    { "id": "attach", "type": "AttachSessionNode", "name": "会话接力", "config": {}, "next": ["attach_search"] },
    { "id": "attach_search", "type": "AttachHostPageNode", "name": "附着搜索页", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["set_index"] },
    { "id": "build_gbk_url", "type": "GBKURLBuilderNode", "name": "GBK编码搜索URL", "config": { "baseUrl": "https://s.1688.com/selloffer/offer_search.htm", "paramName": "keywords", "keywordVar": "keyword", "extraParams": { "n": "y" } }, "next": ["navigate_search"] },
    { "id": "navigate_search", "type": "NavigationNode", "name": "导航到搜索页", "config": { "url": "{targetUrl}", "waitUntil": "domcontentloaded", "timeout": 30000 }, "next": ["prefer_web_variant"] },
    { "id": "prefer_web_variant", "type": "EventDrivenOptionalClickNode", "name": "优先使用网页版(事件驱动)", "config": { "selectors": [".next-btn","button","[role=button]","a"], "textIncludes": ["优先使用网页","使用网页版","继续使用网页版","仍使用网页","留在网页","仅使用网页版"], "excludeTexts": ["下载","客户端","安装"], "maxWaitMs": 15000, "pollIntervalMs": 400, "highlight": true, "persistHighlight": true, "highlightColor": "#ff2d55", "click": true, "method": "mouse", "mouseMoveSteps": 12, "hoverMs": 60 }, "next": ["wait_search"] },
    { "id": "wait_search", "type": "WaitNode", "name": "等待搜索结果加载", "config": { "minMs": 2500, "maxMs": 4000 }, "next": ["set_index"] },
    { "id": "set_index", "type": "DevEvalNode", "name": "设置候选索引", "config": { "inlineScript": "(()=>{ try{ window.__wwClickIndex = Number('{startIndex}')||0; return { variables:{ chosenIndex: Number('{startIndex}')||0 } }; }catch(e){ return { error:String(e) }; } })();" }, "next": ["search_anchor"] },
    { "id": "search_anchor", "type": "AnchorPointNode", "name": "搜索结果锚点", "config": { "selectors": [".sm-offer-list",".sm-offer","#offer-list",".offer-list",".sm-offer-item",".input-button .input-button-text","span.input-button-text","#img-search-upload","input#img-search-upload"], "requireVisible": true, "maxWaitMs": 6000, "pollIntervalMs": 500, "highlight": true, "persistHighlight": true }, "next": ["highlight_candidates"] },
    { "id": "highlight_candidates", "type": "DevEvalNode", "name": "高亮候选(按索引)", "config": { "filePath": "local-dev/1688-mark-candidate-by-index.js" }, "next": ["resolve_contact_key"] },
    { "id": "resolve_contact_key", "type": "DevEvalNode", "name": "解析候选身份", "config": { "filePath": "local-dev/1688-resolve-contact-selected.js" }, "next": ["check_history"] },
    { "id": "check_history", "type": "ContactHistoryNode", "name": "历史去重检查", "config": { "action": "check", "site": "1688", "keyVarName": "companyName" }, "next": ["dedup_condition"] },
    { "id": "dedup_condition", "type": "ConditionNode", "name": "是否已发送", "config": { "mode": "variable", "varName": "alreadySent", "operator": "==", "value": true }, "next": ["skip_open"], "error": ["snapshot_before_open_chat"] },
    { "id": "skip_open", "type": "GateOverlayNode", "name": "跳过已发送对象", "config": { "title": "跳过已发送", "message": "已发送：{companyName}", "block": false }, "next": ["inter_wait"] },
    { "id": "snapshot_before_open_chat", "type": "PageSnapshotNode", "name": "打开聊天前快照", "config": { "maxHtmlLength": 500000 }, "next": ["open_chat"] },
    { "id": "open_chat", "type": "DevEvalNode", "name": "点击旺旺链接", "config": { "filePath": "local-dev/1688-open-selected-ww.js" }, "next": ["wait_chat"] },
    { "id": "wait_chat", "type": "WaitNode", "name": "等待聊天页加载", "config": { "minMs": 2000, "maxMs": 3000 }, "next": ["attach_chat"] },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "air\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["compose"] },
    { "id": "compose", "type": "ChatComposeNode", "name": "输入并发送", "config": { "hostFilter": "air.1688.com", "message": "{chatMessage}", "send": true, "sendViaEnter": false, "stabilizeMs": 1800, "highlightMs": 5000, "persistSendHighlight": false, "sendHighlightColor": "#ff2d55", "sendHighlightLabel": "SEND", "inputSelectors": ["[data-webauto-input='1']","pre.edit[contenteditable=true]",".im-chat-input [contenteditable]",".msg-input [contenteditable]","div[contenteditable=true]","div[contenteditable]","textarea","[role=textbox]"], "sendSelectors": ["[data-webauto-send='1']", ".im-chat-send-btn", ".send-btn", ".next-btn", "button:has-text(发送)", "a:has-text(发送)", "[role=button]", "button[type=submit]"] }, "next": ["record_contact"] },
    { "id": "record_contact", "type": "ContactHistoryNode", "name": "记录发送对象", "config": { "action": "add", "site": "1688", "keyVarName": "companyName" }, "next": ["close_chat_tab"] },
    { "id": "close_chat_tab", "type": "CloseHostPageNode", "name": "关闭聊天Tab", "config": { "hostIncludes": "air.1688.com", "closeAll": false }, "next": ["attach_back_search"] },
    { "id": "attach_back_search", "type": "AttachHostPageNode", "name": "切回搜索结果", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 10000 }, "next": ["inter_wait"] },
    { "id": "inter_wait", "type": "WaitNode", "name": "间隔等待", "config": { "minMs": 1000, "maxMs": 5000 }, "next": ["end"] },
    { "id": "end", "type": "EndNode", "name": "结束", "config": { "cleanup": false, "saveLogs": true } }
  ],
  "globalConfig": { "logLevel": "info", "timeout": 600000 }
}
