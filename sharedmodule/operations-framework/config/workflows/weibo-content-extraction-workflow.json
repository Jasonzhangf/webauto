{
  "name": "weibo-content-extraction-workflow",
  "description": "微博内容提取工作流 - 从指定微博链接批量提取内容",
  "version": "1.0.0",
  "enabled": true,
  "variables": [
    {
      "name": "sourceUrls",
      "type": "array",
      "value": "${input.urls || []}",
      "scope": "workflow",
      "description": "要提取的微博URL列表"
    },
    {
      "name": "sourceFile",
      "type": "string",
      "value": "${input.sourceFile || ''}",
      "scope": "workflow",
      "description": "包含URL列表的源文件"
    },
    {
      "name": "outputDir",
      "type": "string",
      "value": "${input.outputDir || './output/weibo-extraction'}",
      "scope": "workflow",
      "description": "输出目录"
    },
    {
      "name": "extractImages",
      "type": "boolean",
      "value": "${input.extractImages || true}",
      "scope": "workflow",
      "description": "是否提取图片"
    },
    {
      "name": "extractComments",
      "type": "boolean",
      "value": "${input.extractComments || true}",
      "scope": "workflow",
      "description": "是否提取评论"
    },
    {
      "name": "enableOCR",
      "type": "boolean",
      "value": "${input.enableOCR || false}",
      "scope": "workflow",
      "description": "是否启用OCR处理图片"
    },
    {
      "name": "maxConcurrency",
      "type": "number",
      "value": "${input.maxConcurrency || 3}",
      "scope": "workflow",
      "description": "最大并发数"
    }
  ],
  "steps": [
    {
      "id": "load_urls",
      "name": "加载URL列表",
      "operation": "conditional",
      "params": {
        "operation": "if",
        "condition": {
          "type": "exists",
          "condition": "sourceFile",
          "config": {
            "checkEmpty": true
          }
        },
        "thenSteps": [
          {
            "id": "read_urls_from_file",
            "name": "从文件读取URL",
            "operation": "data-processor",
            "params": {
              "operation": "readFile",
              "filePath": "${sourceFile}",
              "format": "json"
            },
            "outputVariable": "fileUrls"
          }
        ],
        "elseSteps": [
          {
            "id": "use_input_urls",
            "name": "使用输入URL",
            "operation": "data-processor",
            "params": {
              "operation": "transform",
              "inputData": "${sourceUrls}",
              "transformations": [
                {
                  "type": "filter",
                  "condition": "url && url.trim() && url.startsWith('http')"
                }
              ]
            },
            "outputVariable": "filteredUrls"
          }
        ]
      },
      "outputVariable": "targetUrls"
    },
    {
      "id": "validate_urls",
      "name": "验证URL",
      "operation": "data-processor",
      "params": {
        "operation": "validate",
        "inputData": "${targetUrls}",
        "validations": [
          {
            "name": "url_format",
            "type": "pattern",
            "pattern": "https://weibo\\.com/.+",
            "message": "必须是有效的微博URL"
          },
          {
            "name": "not_empty",
            "type": "exists",
            "condition": "url",
            "message": "URL不能为空"
          }
        ]
      },
      "outputVariable": "validUrls",
      "condition": {
        "type": "exists",
        "condition": "targetUrls",
        "config": {
          "checkEmpty": true
        }
      }
    },
    {
      "id": "batch_content_extraction",
      "name": "批量内容提取",
      "operation": "web-scraper",
      "params": {
        "operation": "batch",
        "urls": "${validUrls}",
        "selectors": [
          {
            "name": "post_title",
            "type": "text",
            "selector": ".Feed_body_3R0rO h1, .Feed_body_3R0rO h2"
          },
          {
            "name": "post_content",
            "type": "text",
            "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
          },
          {
            "name": "author_info",
            "type": "text",
            "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
          },
          {
            "name": "post_time",
            "type": "text",
            "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
          },
          {
            "name": "interaction_stats",
            "type": "text",
            "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
          },
          {
            "name": "hashtags",
            "type": "text",
            "selector": ".Feed_body_3R0rO a[href*='#']"
          },
          {
            "name": "mentions",
            "type": "text",
            "selector": ".Feed_body_3R0rO a[href*='/']"
          }
        ],
        "outputFormat": "json",
        "outputDir": "${outputDir}",
        "fileName": "weibo_content",
        "maxConcurrency": "${maxConcurrency}",
        "delayBetweenRequests": 1500,
        "browserConfig": {
          "headless": false,
          "timeout": 45000,
          "viewport": { "width": 1920, "height": 1080 }
        }
      },
      "outputVariable": "extractedContent",
      "retry": {
        "maxRetries": 3,
        "delay": 2000,
        "backoffFactor": 2
      },
      "condition": {
        "type": "exists",
        "condition": "validUrls",
        "config": {
          "checkEmpty": true
        }
      }
    },
    {
      "id": "image_extraction",
      "name": "图片提取",
      "operation": "conditional",
      "params": {
        "operation": "if",
        "condition": {
          "type": "expression",
          "condition": "extractImages === true"
        },
        "thenSteps": [
          {
            "id": "extract_post_images",
            "name": "提取帖子图片",
            "operation": "web-scraper",
            "params": {
              "operation": "batch",
              "urls": "${validUrls}",
              "selectors": [
                {
                  "name": "post_images",
                  "type": "image",
                  "selector": ".Feed_body_3R0rO img",
                  "attribute": "src"
                }
              ],
              "outputFormat": "json",
              "outputDir": "${outputDir}/images",
              "fileName": "weibo_images",
              "maxConcurrency": "${maxConcurrency}",
              "delayBetweenRequests": 1000
            },
            "outputVariable": "extractedImages"
          },
          {
            "id": "download_images",
            "name": "下载图片",
            "operation": "data-processor",
            "params": {
              "operation": "download",
              "urls": "${extractedImages}",
              "outputDir": "${outputDir}/images",
              "maxConcurrency": 5
            },
            "outputVariable": "downloadedImages"
          }
        ]
      },
      "outputVariable": "imageResults"
    },
    {
      "id": "comment_extraction",
      "name": "评论提取",
      "operation": "conditional",
      "params": {
        "operation": "if",
        "condition": {
          "type": "expression",
          "condition": "extractComments === true"
        },
        "thenSteps": [
          {
            "id": "extract_comments",
            "name": "提取评论",
            "operation": "web-scraper",
            "params": {
              "operation": "batch",
              "urls": "${validUrls}",
              "selectors": [
                {
                  "name": "comments_section",
                  "type": "text",
                  "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
                },
                {
                  "name": "comment_authors",
                  "type": "text",
                  "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
                },
                {
                  "name": "comment_times",
                  "type": "text",
                  "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
                },
                {
                  "name": "comment_likes",
                  "type": "text",
                  "selector": ".Feed_body_3R0rO .Feed_body_3R0rO"
                }
              ],
              "outputFormat": "json",
              "outputDir": "${outputDir}/comments",
              "fileName": "weibo_comments",
              "maxConcurrency": "${maxConcurrency}",
              "delayBetweenRequests": 2000
            },
            "outputVariable": "extractedComments"
          }
        ]
      },
      "outputVariable": "commentResults"
    },
    {
      "id": "ocr_processing",
      "name": "OCR处理",
      "operation": "conditional",
      "params": {
        "operation": "if",
        "condition": {
          "type": "expression",
          "condition": "enableOCR === true && extractImages === true"
        },
        "thenSteps": [
          {
            "id": "process_images_ocr",
            "name": "OCR图片处理",
            "operation": "ai-service",
            "params": {
              "operation": "ocr",
              "imageDir": "${outputDir}/images",
              "outputDir": "${outputDir}/ocr-results",
              "language": "zh-CN",
              "confidence": 0.8
            },
            "outputVariable": "ocrResults"
          },
          {
            "id": "merge_ocr_results",
            "name": "合并OCR结果",
            "operation": "data-processor",
            "params": {
              "operation": "merge",
              "inputData": ["${extractedContent}", "${ocrResults}"],
              "mergeStrategy": "combine",
              "outputFormat": "json",
              "outputFile": "${outputDir}/content_with_ocr.json"
            },
            "outputVariable": "contentWithOCR"
          }
        ]
      },
      "outputVariable": "ocrProcessingResults"
    },
    {
      "id": "content_organization",
      "name": "内容整理",
      "operation": "file-organizer",
      "params": {
        "operation": "intelligentOrganize",
        "sourceDirectory": "${outputDir}",
        "targetDirectory": "${outputDir}/organized",
        "strategy": "content-type",
        "createSummary": true,
        "backup": false
      },
      "outputVariable": "organizedContent"
    },
    {
      "id": "generate_summary",
      "name": "生成总结报告",
      "operation": "data-processor",
      "params": {
        "operation": "summarize",
        "inputData": {
          "extractedPosts": "${extractedContent}",
          "extractedImages": "${imageResults}",
          "extractedComments": "${commentResults}",
          "ocrResults": "${ocrProcessingResults}"
        },
        "summaryTemplate": {
          "totalPosts": "extractedPosts.length",
          "totalImages": "extractedImages ? extractedImages.length : 0",
          "totalComments": "extractedComments ? extractedComments.length : 0",
          "extractionDate": "${new Date().toISOString()}",
          "outputDirectory": "${outputDir}"
        },
        "outputFormat": "json",
        "outputFile": "${outputDir}/extraction_summary.json"
      },
      "outputVariable": "summaryReport"
    },
    {
      "id": "final_merge",
      "name": "最终合并",
      "operation": "data-processor",
      "params": {
        "operation": "merge",
        "inputData": [
          "${extractedContent}",
          "${imageResults}",
          "${commentResults}",
          "${ocrProcessingResults}",
          "${organizedContent}",
          "${summaryReport}"
        ],
        "mergeStrategy": "comprehensive",
        "outputFormat": "json",
        "outputFile": "${outputDir}/final_extraction_results.json"
      },
      "outputVariable": "finalResults"
    }
  ],
  "metadata": {
    "author": "WebAuto Team",
    "created": "2024-01-01T00:00:00Z",
    "updated": "2024-01-01T00:00:00Z",
    "tags": ["weibo", "content-extraction", "batch-processing", "social-media"],
    "category": "web-scraping",
    "complexity": "high",
    "estimatedTime": "10-30 minutes",
    "dependencies": [
      "web-scraper",
      "data-processor",
      "file-organizer",
      "ai-service"
    ]
  }
}