{
  "name": "weibo-search-workflow",
  "description": "微博搜索和内容捕获工作流",
  "version": "1.0.0",
  "author": "WebAuto Team",
  "created": "2025-09-15",
  "settings": {
    "maxRetries": 3,
    "timeout": 300000,
    "parallelExecution": false,
    "continueOnError": false,
    "saveResults": true,
    "resultFormat": "json"
  },
  "context": {
    "container": {
      "type": "weibo-search-page",
      "platform": "weibo",
      "language": "zh"
    },
    "browser": {
      "headless": false,
      "autoInjectCookies": true,
      "waitForLogin": true,
      "targetDomain": "weibo.com",
      "defaultTimeout": 15000
    },
    "save": {
      "rootDir": "~/.webauto",
      "format": "markdown",
      "includeImages": true,
      "includeMetadata": true
    }
  },
  "steps": [
    {
      "id": "initialize-browser",
      "name": "初始化浏览器",
      "abstractCategory": "navigate-page",
      "description": "初始化浏览器并登录微博",
      "config": {
        "url": "https://weibo.com",
        "waitForSelector": ".card-wrap, .card-feed, .wbs-feed",
        "timeout": 30000,
        "screenshot": true
      },
      "expectedOutput": ["browserContext", "page"],
      "forceOperation": "PageNavigationOperation"
    },
    {
      "id": "search-keyword",
      "name": "搜索关键字",
      "abstractCategory": "search-keyword",
      "description": "在微博搜索指定关键字",
      "config": {
        "keyword": "${keyword}",
        "searchType": "weibo-search",
        "resultCount": 50,
        "timeRange": "all",
        "sortBy": "relevant",
        "count": 50
      },
      "expectedOutput": ["searchResults", "searchUrl"],
      "forceOperation": "WeiboSearchOperation"
    },
    {
      "id": "extract-search-results",
      "name": "提取搜索结果",
      "abstractCategory": "extract-content",
      "description": "从搜索结果页面提取帖子信息",
      "config": {
        "source": "${searchResults}",
        "maxItems": 50,
        "includeFields": ["id", "username", "content", "time", "stats", "images", "links"],
        "filter": {
          "minContentLength": 10,
          "excludeUsers": ["官方", "广告", "推广"]
        }
      },
      "expectedOutput": ["posts"],
      "forceOperation": "ContentExtractorOperation"
    },
    {
      "id": "extract-links",
      "name": "提取帖子链接",
      "abstractCategory": "extract-links",
      "description": "从搜索结果中提取帖子详情链接",
      "config": {
        "source": "${posts}",
        "maxLinks": 50,
        "includeMetadata": true,
        "filter": {
          "domain": "weibo.com",
          "excludePatterns": ["login", "register", "search"]
        }
      },
      "expectedOutput": ["postLinks"],
      "forceOperation": "LinkExtractorOperation"
    },
    {
      "id": "batch-extract-details",
      "name": "批量提取帖子详情",
      "abstractCategory": "extract-content",
      "description": "批量打开帖子链接并提取详细信息",
      "config": {
        "links": "${postLinks}",
        "batchSize": 10,
        "delayBetweenRequests": 2000,
        "includeComments": true,
        "includeImages": true,
        "timeout": 15000
      },
      "expectedOutput": ["detailedPosts"],
      "forceOperation": "ContentExtractorOperation"
    },
    {
      "id": "merge-data",
      "name": "合并数据",
      "abstractCategory": "merge-data",
      "description": "合并搜索结果和详细提取的数据",
      "config": {
        "sources": ["${posts}", "${detailedPosts}"],
        "mergeStrategy": "enrich",
        "keyField": "id",
        "conflictResolution": "detailed"
      },
      "expectedOutput": ["mergedPosts"],
      "forceOperation": "DataMergerOperation"
    },
    {
      "id": "filter-content",
      "name": "过滤内容",
      "abstractCategory": "filter-data",
      "description": "过滤和清理内容数据",
      "config": {
        "data": "${mergedPosts}",
        "rules": [
          {
            "field": "content",
            "operator": "length",
            "value": 5,
            "condition": "greaterThan"
          },
          {
            "field": "username",
            "operator": "notContains",
            "value": ["广告", "推广", "官方"]
          }
        ],
        "sortBy": "time",
        "sortOrder": "desc"
      },
      "expectedOutput": ["filteredPosts"],
      "forceOperation": "DataFilterOperation"
    },
    {
      "id": "convert-to-markdown",
      "name": "转换为Markdown",
      "abstractCategory": "convert-markdown",
      "description": "将处理后的数据转换为Markdown格式",
      "config": {
        "data": "${filteredPosts}",
        "template": "weibo-post",
        "includeImages": true,
        "includeStats": true,
        "includeMetadata": true
      },
      "expectedOutput": ["markdownContent"],
      "forceOperation": "MarkdownConverterOperation"
    },
    {
      "id": "save-results",
      "name": "保存结果",
      "abstractCategory": "save-file",
      "description": "保存搜索结果到本地文件",
      "config": {
        "data": {
          "keyword": "${keyword}",
          "searchTime": "${timestamp}",
          "totalPosts": "${filteredPosts.length}",
          "posts": "${filteredPosts}",
          "markdown": "${markdownContent}"
        },
        "filePath": "${saveDir}/weibo-search-${keyword}-${timestamp}.json",
        "format": "json",
        "backup": true,
        "metadata": {
          "source": "weibo-search",
          "version": "1.0.0",
          "generatedBy": "operations-framework"
        }
      },
      "expectedOutput": ["savedFilePath"],
      "forceOperation": "JsonFileSaverOperation"
    },
    {
      "id": "save-markdown",
      "name": "保存Markdown文件",
      "abstractCategory": "save-file",
      "description": "保存Markdown格式的汇总文件",
      "config": {
        "data": "${markdownContent}",
        "filePath": "${saveDir}/weibo-search-${keyword}-${timestamp}.md",
        "format": "markdown",
        "backup": true
      },
      "expectedOutput": ["markdownFilePath"],
      "forceOperation": "MarkdownFileSaverOperation"
    }
  ],
  "output": {
    "success": {
      "message": "微博搜索完成",
      "files": ["${savedFilePath}", "${markdownFilePath}"],
      "statistics": {
        "totalPosts": "${filteredPosts.length}",
        "searchTime": "${timestamp}",
        "keyword": "${keyword}"
      }
    },
    "error": {
      "message": "微博搜索失败",
      "retry": true,
      "maxRetries": 3
    }
  },
  "parameters": {
    "keyword": {
      "type": "string",
      "required": true,
      "description": "搜索关键字"
    },
    "count": {
      "type": "number",
      "required": false,
      "default": 50,
      "description": "要获取的帖子数量"
    },
    "saveDir": {
      "type": "string",
      "required": false,
      "default": "~/.webauto/${date}/${keyword}",
      "description": "保存目录"
    }
  }
}