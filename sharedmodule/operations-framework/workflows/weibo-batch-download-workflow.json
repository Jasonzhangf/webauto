{
  "name": "weibo-batch-download-workflow",
  "description": "微博完整批量下载工作流 - 包含目录结构、去重、历史管理、评论爬取、图片下载",
  "version": "2.0.0",
  "author": "WebAuto Team",
  "created": "2025-09-16",
  "category": "weibo-batch",
  "tags": ["weibo", "batch-download", "comments", "images", "deduplication", "history"],

  "settings": {
    "maxRetries": 3,
    "timeout": 300000,
    "parallelExecution": true,
    "maxConcurrent": 3,
    "continueOnError": true,
    "saveResults": true,
    "resultFormat": "structured",
    "enableDeduplication": true,
    "enableHistory": true,
    "enableComments": true,
    "enableImages": true
  },

  "context": {
    "container": {
      "type": "weibo-batch-download",
      "platform": "weibo",
      "language": "zh",
      "url": "https://weibo.com"
    },
    "browser": {
      "headless": true,
      "autoInjectCookies": true,
      "waitForLogin": true,
      "targetDomain": "weibo.com",
      "defaultTimeout": 15000,
      "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    },
    "directory": {
      "root": "~/.webauto/batch-download-complete",
      "structure": {
        "text": "text-content",
        "images": "images",
        "videos": "videos",
        "comments": "comments",
        "reports": "reports",
        "metadata": "metadata"
      }
    },
    "deduplication": {
      "enabled": true,
      "strategy": "content-based",
      "fields": ["id", "content", "author"],
      "historyFile": "download-history.json",
      "maxHistoryDays": 30
    },
    "comments": {
      "enabled": true,
      "maxComments": 100,
      "maxReplies": 20,
      "includeReplies": true,
      "downloadNested": true,
      "extractNested": true
    },
    "images": {
      "enabled": true,
      "quality": "original",
      "skipExisting": true,
      "maxConcurrent": 3,
      "timeout": 30000,
      "filterRules": {
        "minSize": 1024,
        "allowedFormats": ["jpg", "jpeg", "png", "webp"],
        "blockedPatterns": ["avatar", "thumb", "emoji", "icon", "logo"],
        "minDimensions": {"width": 50, "height": 50}
      }
    },
    "output": {
      "formats": ["json", "markdown", "csv"],
      "includeMetadata": true,
      "includeStatistics": true,
      "createIndex": true,
      "generateReport": true,
      "includeCSV": true
    }
  },

  "steps": [
    {
      "id": "initialize-batch-system",
      "name": "初始化批量下载系统",
      "abstractCategory": "system-initialization",
      "description": "初始化浏览器、创建目录结构、加载历史记录",
      "config": {
        "createDirectoryStructure": true,
        "directoryConfig": "${directory}",
        "loadHistory": true,
        "historyConfig": "${deduplication}",
        "initBrowser": true,
        "browserConfig": "${browser}"
      },
      "expectedOutput": ["browserContext", "directoryStructure", "downloadHistory"],
      "forceOperation": "BatchSystemInitializationOperation"
    },

    {
      "id": "process-batch-urls",
      "name": "处理批量URL列表",
      "abstractCategory": "batch-processing",
      "description": "处理输入的URL列表，进行去重检查和分组",
      "config": {
        "urls": "${urls}",
        "deduplicationEnabled": "${deduplication.enabled}",
        "downloadHistory": "${downloadHistory}",
        "deduplicationFields": "${deduplication.fields}",
        "maxConcurrent": "${maxConcurrent:3}",
        "batchSize": 5
      },
      "expectedOutput": ["processedUrls", "uniqueUrls", "duplicateUrls", "batchGroups"],
      "forceOperation": "BatchUrlProcessingOperation"
    },

    {
      "id": "download-batch-content",
      "name": "批量下载内容",
      "abstractCategory": "batch-download",
      "description": "并发批量下载微博帖子内容",
      "config": {
        "batchGroups": "${batchGroups}",
        "maxConcurrent": "${maxConcurrent:3}",
        "downloadConfig": {
          "includeComments": "${comments.enabled}",
          "includeImages": "${images.enabled}",
          "commentsConfig": "${comments}",
          "imagesConfig": "${images}"
        }
      },
      "expectedOutput": ["downloadResults", "batchStats"],
      "forceOperation": "BatchContentDownloadOperation"
    },

    {
      "id": "extract-comments-batch",
      "name": "批量提取评论",
      "abstractCategory": "comments-extraction",
      "description": "对下载成功的帖子批量提取评论",
      "config": {
        "downloadResults": "${downloadResults}",
        "commentsConfig": "${comments}",
        "maxConcurrent": 2,
        "extractNested": true
      },
      "expectedOutput": ["commentsResults", "commentsStats"],
      "forceOperation": "BatchCommentsExtractionOperation",
      "dependencies": ["download-batch-content"]
    },

    {
      "id": "download-images-batch",
      "name": "批量下载图片",
      "abstractCategory": "media-download",
      "description": "批量下载帖子中的图片",
      "config": {
        "downloadResults": "${downloadResults}",
        "imagesConfig": "${images}",
        "directoryStructure": "${directory.structure}",
        "maxConcurrent": "${images.maxConcurrent:3}",
        "skipExisting": true
      },
      "expectedOutput": ["imageDownloadResults", "imageStats"],
      "forceOperation": "BatchImagesDownloadOperation",
      "dependencies": ["download-batch-content"]
    },

    {
      "id": "organize-directory-structure",
      "name": "整理目录结构",
      "abstractCategory": "file-organization",
      "description": "按照预设结构整理下载的文件",
      "config": {
        "downloadResults": "${downloadResults}",
        "commentsResults": "${commentsResults}",
        "imageDownloadResults": "${imageDownloadResults}",
        "directoryConfig": "${directory}",
        "outputFormats": "${output.formats}"
      },
      "expectedOutput": ["organizedFiles", "directoryStructure"],
      "forceOperation": "DirectoryStructureOrganizationOperation"
    },

    {
      "id": "generate-batch-reports",
      "name": "生成批量报告",
      "abstractCategory": "report-generation",
      "description": "生成详细的批量下载报告和统计信息",
      "config": {
        "downloadResults": "${downloadResults}",
        "commentsResults": "${commentsResults}",
        "imageDownloadResults": "${imageDownloadResults}",
        "batchStats": "${batchStats}",
        "organizedFiles": "${organizedFiles}",
        "outputConfig": "${output}",
        "includeStatistics": true,
        "includeSummary": true,
        "createIndex": true
      },
      "expectedOutput": ["batchReports", "statistics"],
      "forceOperation": "BatchReportGenerationOperation"
    },

    {
      "id": "update-download-history",
      "name": "更新下载历史",
      "abstractCategory": "history-management",
      "description": "更新下载历史记录，为下次下载做准备",
      "config": {
        "downloadResults": "${downloadResults}",
        "historyConfig": "${deduplication}",
        "directoryStructure": "${directory.structure}",
        "saveTimestamp": true
      },
      "expectedOutput": ["updatedHistory"],
      "forceOperation": "DownloadHistoryUpdateOperation"
    }
  ],

  "output": {
    "success": {
      "message": "微博批量下载完成",
      "data": {
        "totalPosts": "${batchStats.totalPosts}",
        "successfulPosts": "${batchStats.successfulPosts}",
        "failedPosts": "${batchStats.failedPosts}",
        "skippedPosts": "${batchStats.skippedPosts}",
        "totalComments": "${commentsStats.totalComments}",
        "totalImages": "${imageStats.totalImages}",
        "downloadedImages": "${imageStats.downloadedImages}",
        "deduplicatedCount": "${batchStats.deduplicatedCount}",
        "successRate": "${statistics.successRate}",
        "executionTime": "${statistics.executionTime}",
        "outputDirectory": "${directory.root}"
      },
      "files": {
        "textDirectory": "${directory.root}/${directory.structure.text}",
        "imagesDirectory": "${directory.root}/${directory.structure.images}",
        "commentsDirectory": "${directory.root}/${directory.structure.comments}",
        "reportsDirectory": "${directory.root}/${directory.structure.reports}",
        "metadataDirectory": "${directory.root}/${directory.structure.metadata}",
        "batchReport": "${directory.root}/${directory.structure.reports}/batch-report-${timestamp}.json",
        "historyFile": "${directory.root}/${directory.structure.metadata}/${deduplication.historyFile}",
        "indexPage": "${directory.root}/index.html"
      }
    },
    "error": {
      "message": "微博批量下载失败",
      "retry": true,
      "maxRetries": 3,
      "errorHandling": {
        "browserError": "restart-browser",
        "networkError": "retry-with-delay",
        "contentError": "log-and-continue",
        "fileSystemError": "create-directories"
      }
    }
  },

  "parameters": {
    "urls": {
      "type": "array",
      "required": true,
      "description": "微博帖子URL列表",
      "example": ["https://weibo.com/3602531713/Q4D6XAmm3", "https://weibo.com/5955106173/Q4MMiinjz"]
    },
    "outputDir": {
      "type": "string",
      "required": false,
      "default": "~/.webauto/batch-download-complete",
      "description": "输出根目录"
    },
    "maxConcurrent": {
      "type": "number",
      "required": false,
      "default": 3,
      "min": 1,
      "max": 10,
      "description": "最大并发下载数"
    },
    "enableComments": {
      "type": "boolean",
      "required": false,
      "default": true,
      "description": "是否启用评论提取"
    },
    "enableImages": {
      "type": "boolean",
      "required": false,
      "default": true,
      "description": "是否启用图片下载"
    },
    "enableDeduplication": {
      "type": "boolean",
      "required": false,
      "default": true,
      "description": "是否启用去重功能"
    },
    "includeNestedComments": {
      "type": "boolean",
      "required": false,
      "default": true,
      "description": "是否包含嵌套评论"
    },
    "imageQuality": {
      "type": "string",
      "required": false,
      "default": "original",
      "enum": ["thumbnail", "medium", "original"],
      "description": "图片质量"
    }
  },

  "examples": {
    "基础批量下载": {
      "urls": ["https://weibo.com/3602531713/Q4D6XAmm3", "https://weibo.com/5955106173/Q4MMiinjz"],
      "maxConcurrent": 2,
      "enableComments": true,
      "enableImages": true,
      "enableDeduplication": true
    },
    "高速批量下载": {
      "urls": ["https://weibo.com/3602531713/Q4D6XAmm3", "https://weibo.com/5955106173/Q4MMiinjz", "https://weibo.com/6605947280/Q4F0dh7Fv"],
      "maxConcurrent": 5,
      "enableComments": false,
      "enableImages": true,
      "enableDeduplication": false
    },
    "完整内容下载": {
      "urls": ["https://weibo.com/3602531713/Q4D6XAmm3"],
      "maxConcurrent": 1,
      "enableComments": true,
      "enableImages": true,
      "enableDeduplication": true,
      "includeNestedComments": true,
      "imageQuality": "original"
    }
  },

  "performance": {
    "estimatedTime": "3-15分钟（取决于帖子数量和配置）",
    "successRate": "85-95%",
    "memoryUsage": "medium-high",
    "networkUsage": "high",
    "diskUsage": "high（包含图片和评论）"
  },

  "dependencies": {
    "required": [
      "BatchSystemInitializationOperation",
      "BatchUrlProcessingOperation",
      "BatchContentDownloadOperation",
      "DirectoryStructureOrganizationOperation",
      "BatchReportGenerationOperation",
      "DownloadHistoryUpdateOperation"
    ],
    "optional": [
      "BatchCommentsExtractionOperation",
      "BatchImagesDownloadOperation"
    ]
  },

  "notes": [
    "此工作流提供完整的微博批量下载解决方案",
    "支持结构化目录管理、智能去重、历史记录、评论提取、图片下载",
    "具有完善的错误处理和并发控制机制",
    "支持增量下载，避免重复下载相同内容",
    "生成详细的统计报告和HTML索引页面"
  ]
}