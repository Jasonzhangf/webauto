/**
 * Smart Reply Simulation Test
 * 使用真实下载的帖子和评论测试智能回复
 */
import { readFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));

// 示例帖子内容（简化）
const SAMPLE_NOTE = `这是一篇关于手机壳的分享笔记。
作者分享了自己的使用体验，提到了透明壳的质量问题，
以及与其他品牌壳的对比。评论区有网友询问购买渠道，
也有用户分享自己的使用经历和看法。`;

// 真实评论样本（从实际数据中提取）
const SAMPLE_COMMENTS = [
  {
    user: "我的名字",
    text: "优思顿影响了这条文的可信度毕竟我也买过"
  },
  {
    user: "幸运小玉",
    text: "确实 不如排拼多多几块钱的"
  },
  {
    user: "纪贝灵",
    text: "啊~在路上两个"
  },
  {
    user: "皮皮妈",
    text: "benifit质量稀烂，而且有些实际拿到手丑到爆了"
  }
];

// 风格预设
const STYLE_PRESETS = {
  friendly: "语气友好、亲切、像普通用户聊天。",
  professional: "语气专业、清晰，但不生硬。",
  humorous: "语气轻松幽默，允许少量口语化表达。",
  concise: "语气简洁，优先短句直达重点。",
};

function buildPrompt(noteContent, commentText, style) {
  const styleText = STYLE_PRESETS[style] || STYLE_PRESETS.friendly;
  return [
    `你是一个真实的小红书用户，擅长自然、简短、友好的中文互动。`,
    ``,
    `【帖子内容】`,
    noteContent.slice(0, 300),
    ``,
    `【目标评论】`,
    `@${commentText}`,
    ``,
    `【回复风格】${styleText}`,
    ``,
    `【要求】`,
    `- 回复必须是中文`,
    `- 不超过 20 字`,
    `- 不要营销、不要引流`,
    `- 不要留链接或联系方式`,
    `- 不要复述原评论内容`,
    `- 优先回应评论中的具体问题`,
    ``,
    `请直接输出最终回复文本，不要解释。`
  ].join('\n');
}

function loadConfig() {
  // 从 routecodex 读取配置
  try {
    const configPath = '/Users/fanzhang/.routecodex/config.json';
    const configText = readFileSync(configPath, 'utf8');
    const routeCodex = JSON.parse(configText);
    
    if (routeCodex.httpserver) {
      const host = routeCodex.httpserver.host === '0.0.0.0' 
        ? '127.0.0.1' 
        : routeCodex.httpserver.host;
      
      return {
        baseUrl: `http://${host}:${routeCodex.httpserver.port}`,
        apiKey: routeCodex.httpserver.apikey || '',
        model: 'glm.glm-4.7',
      };
    }
  } catch (e) {
    console.log('[WARN] Failed to load routecodex config:', e?.message);
  }
  
  return {
    baseUrl: 'http://127.0.0.1:5520',
    apiKey: 'sk-user-01a741881a24856eb910f38e',
    model: 'glm.glm-4.7',
  };
}

async function callModel(baseUrl, apiKey, model, prompt) {
  const res = await fetch(`${baseUrl}/v1/chat/completions`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model,
      messages: [
        { role: 'user', content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 120,
    }),
    signal: AbortSignal.timeout(60000),
  });
  
  const json = await res.json();
  if (!res.ok) {
    throw new Error(json?.error?.message || `HTTP ${res.status}`);
  }
  
  return json?.choices?.[0]?.message?.content || '';
}

async function main() {
  console.log('=== Smart Reply Simulation Test ===\n');
  
  const config = loadConfig();
  console.log('[CONFIG]');
  console.log(`  - Base URL: ${config.baseUrl}`);
  console.log(`  - Model: ${config.model}`);
  console.log(`  - API Key: ${config.apiKey ? '***' : '(empty)'}\n`);
  
  const styles = ['friendly', 'professional', 'humorous', 'concise'];
  
  // 测试前3条评论
  for (let i = 0; i < Math.min(3, SAMPLE_COMMENTS.length); i++) {
    const comment = SAMPLE_COMMENTS[i];
    console.log(`--- Comment ${i + 1}: @${comment.user} ---`);
    console.log(`"${comment.text}"`);
    console.log('');
    
    for (const style of styles) {
      try {
        const prompt = buildPrompt(SAMPLE_NOTE, comment.text, style);
        const start = Date.now();
        const reply = await callModel(config.baseUrl, config.apiKey, config.model, prompt);
        const latency = Date.now() - start;
        
        console.log(`[${style}] ${latency}ms`);
        console.log(`"${reply?.slice(0, 50)}..."`);
      } catch (e) {
        console.error(`[${style}] ERROR: ${e.message}`);
      }
      console.log('');
    }
    
    if (i < 2) await new Promise(r => setTimeout(r, 2000)); // 避免请求过快
  }
  
  console.log('=== Test Complete ===');
}

main().catch(e => {
  console.error('[FATAL]', e);
  process.exit(1);
});
