{
  "name": "1688 搜索-旺旺-聊天接力",
  "description": "预登录 → GBK关键词搜索 → 高亮候选旺旺 → 打开聊天页 → 输入‘你好’并发送（保留浏览器）",
  "version": "1.0.0",
  "anchor": {
    "hostFilter": "1688.com",
    "selectors": [".userAvatarLogo img", "#alisearch-keywords", "input[name='keywords']"],
    "requireVisible": true,
    "maxWaitMs": 600000,
    "pollIntervalMs": 1500,
    "highlight": true,
    "persistHighlight": true,
    "highlightColor": "#34c759",
    "highlightLabel": "ANCHOR"
  },
  "preflows": [
    "1688-login-preflow"
  ],
  "nodes": [
    {
      "id": "start",
      "type": "StartNode",
      "name": "开始",
      "next": [
        "attach"
      ]
    },
    {
      "id": "attach",
      "type": "AttachSessionNode",
      "name": "会话接力",
      "config": {},
      "next": [
        "navigate_home"
      ]
    },
    {
      "id": "navigate_home",
      "type": "NavigationNode",
      "name": "进入1688主页",
      "config": {
        "url": "https://www.1688.com/",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "stabilize_home"
      ]
    },
    {
      "id": "stabilize_home",
      "type": "WaitNode",
      "name": "主页稳定等待",
      "config": {
        "minMs": 1200,
        "maxMs": 2200
      },
      "next": [
        "antibot_home"
      ]
    },
    {
      "id": "antibot_home",
      "type": "AntiBotMitigationNode",
      "name": "主页轻量反风控",
      "config": {
        "mouseMoves": 3,
        "scroll": true,
        "jitterMinMs": 800,
        "jitterMaxMs": 1600
      },
      "next": [
        "dismiss_home_modals"
      ]
    },
    {
      "id": "dismiss_home_modals",
      "type": "ModalDismissNode",
      "name": "关闭主页弹层",
      "config": {
        "maxAttempts": 5,
        "retryDelay": 400
      },
      "next": [
        "verify_home_login"
      ]
    },
    {
      "id": "verify_home_login",
      "type": "LoginVerificationNode",
      "name": "主页快速登录确认",
      "config": {
        "loginSelectors": [
          ".userAvatarLogo img",
          "[class*=userAvatarLogo] img",
          "img[src*=\\\"alicdn.com/img/ibank/\\\"]"
        ],
        "requireVisible": true,
        "maxRetries": 20,
        "retryDelay": 1500
      },
      "next": [
        "save_cookies_after_home"
      ],
      "error": [
        "halt_on_login_fail"
      ]
    },
    {
      "id": "save_cookies_after_home",
      "type": "CookieSaverNode",
      "name": "登录后保存Cookie",
      "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" },
      "next": ["build_gbk_url"]
    },
    {
      "id": "halt_on_login_fail",
      "type": "HaltNode",
      "name": "登录失败停止",
      "config": {
        "message": "主页登录确认失败，停止执行以避免风控"
      }
    },
    {
      "id": "build_gbk_url",
      "type": "GBKURLBuilderNode",
      "name": "GBK编码搜索URL",
      "config": {
        "baseUrl": "https://s.1688.com/selloffer/offer_search.htm",
        "paramName": "keywords",
        "keywordVar": "keyword",
        "extraParams": {
          "n": "y"
        }
      },
      "next": [
        "navigate_search"
      ]
    },
    {
      "id": "navigate_search",
      "type": "NavigationNode",
      "name": "导航到搜索页",
      "config": {
        "url": "{targetUrl}",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "prefer_web_variant"
      ]
    },
    {
      "id": "prefer_web_variant",
      "type": "EventDrivenOptionalClickNode",
      "name": "优先使用网页版(事件驱动)",
      "config": {
        "selectors": [".next-btn","button","[role=button]","a"],
        "textIncludes": ["优先使用网页","使用网页版","继续使用网页版","仍使用网页","留在网页","仅使用网页版"],
        "excludeTexts": ["下载","客户端","安装"],
        "maxWaitMs": 15000,
        "pollIntervalMs": 400,
        "highlight": true,
        "persistHighlight": true,
        "highlightColor": "#ff2d55",
        "click": true,
        "method": "mouse",
        "mouseMoveSteps": 12,
        "hoverMs": 60
      },
      "next": [
        "wait_search"
      ]
    },
    {
      "id": "wait_search",
      "type": "WaitNode",
      "name": "等待搜索结果加载",
      "config": {
        "minMs": 2500,
        "maxMs": 4000
      },
      "next": [
        "search_anchor"
      ]
    },
    { "id": "search_anchor", "type": "AnchorPointNode", "name": "搜索结果锚点", "config": { "selectors": [".sm-offer-list", ".sm-offer" , "#offer-list"], "requireVisible": true, "highlight": true, "persistHighlight": true }, "next": ["highlight_candidates"] },
    {
      "id": "highlight_candidates",
      "type": "JavaScriptExecutionNode",
      "name": "高亮旺旺候选(预跑,不消失)",
      "config": {
        "script": "(function(){\n  function vis(el){ var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>8 && r.height>8; }\n  var list = Array.from(document.querySelectorAll('button,[role=\"button\"],.im-chat-send-btn,.next-btn,.send-btn,a'));\n  var scored=[];\n  for (var i=0;i<list.length;i++){ try{ var el=list[i]; if(!vis(el)) continue; var r=el.getBoundingClientRect(); var score=(r.width*r.height)+((r.y>(innerHeight-160))?5000:0)+((r.x>(innerWidth*0.5))?2500:0); scored.push({el:el,score:score}); }catch(e){} }\n  if(!scored.length){ return { success:false, error:'no candidate' }; }\n  scored.sort(function(a,b){ return b.score-a.score; });\n  var el=scored[0].el;\n  el.setAttribute('data-webauto-send','1');\n  el.scrollIntoView({behavior:'instant',block:'center'});\n  return { success:true, selector:\"[data-webauto-send='1']\" };\n})();",
        "saveScreenshots": false
      },
      "next": [
        "open_chat"
      ]
    },
    {
      "id": "open_chat",
      "type": "PopupTokenCaptureNode",
      "name": "打开聊天(捕获token)",
      "config": {
        "containerSelector": "body",
        "clickSelectors": [
          ".offer-shop-row .ww-link.ww-online",
          "span.J_WangWang .ww-link.ww-online",
          "a.ww-link.ww-inline",
          "span.J_WangWang a.ww-link",
          "a[href*=air.1688.com/app/]"
        ],
        "hostFilter": "air.1688.com",
        "maxItems": 1,
        "minClickDelay": 600,
        "maxClickDelay": 1500,
        "afterPopupWaitMs": 1200,
        "closePopup": false,
        "popupClickSelectors": [
          "body > div:nth-child(23)"
        ],
        "dryMode": false,
        "enforceWebPreference": true,
        "startIndex": 0
      },
      "next": [
        "wait_chat"
      ]
    },
    {
      "id": "wait_chat",
      "type": "WaitNode",
      "name": "等待聊天页加载",
      "config": {
        "minMs": 2000,
        "maxMs": 3000
      },
      "next": [
        "attach_chat"
      ]
    },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "air\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["chat_anchor"] },
    { "id": "chat_anchor", "type": "AnchorPointNode", "name": "聊天页锚点", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "selectors": [".im-chat-input", "div[contenteditable]"], "requireVisible": true, "highlight": true, "persistHighlight": true }, "next": ["save_cookies_after_attach"] },
    { "id": "save_cookies_after_attach", "type": "CookieSaverNode", "name": "聊天域保存Cookie", "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" }, "next": ["compose"] },
    {
      "id": "compose",
      "type": "ChatComposeNode",
      "name": "输入并发送‘你好’",
      "config": {
        "hostFilter": "air.1688.com",
        "message": "你好",
        "send": false,
        "sendViaEnter": false,
        "stabilizeMs": 2000,
        "highlightMs": 8000,
        "persistSendHighlight": true,
        "sendHighlightColor": "#ff2d55",
        "sendHighlightLabel": "SEND",
        "inputSelectors": [
          "pre.edit[contenteditable=true]",
          ".im-chat-input [contenteditable]",
          ".msg-input [contenteditable]",
          "div[contenteditable=true]",
          "div[contenteditable]",
          "textarea",
          "[role=textbox]"
        ],
        "sendSelectors": [
          ".next-btn",
          ".im-chat-send-btn",
          ".send-btn",
          "button:has-text(发送)",
          "a:has-text(发送)",
          "[role=button]",
          "button[type=submit]"
        ]
      },
      "next": [
        "probe_send_button"
      ]
    },
    {
      "id": "probe_send_button",
      "type": "JavaScriptExecutionNode",
      "name": "probe send button",
      "config": {
        "frame": { "urlPattern": "air\\.1688\\.com/.*" },
        "script": "(function(){\n  function vis(el){ try{var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>8 && r.height>8;}catch(e){return false;} }\n  // 1) 如果 ChatCompose 已标记则直接使用\n  var pre = document.querySelector(\"[data-webauto-send='1']\");\n  if (pre && vis(pre)) { pre.scrollIntoView({behavior:'instant',block:'center'}); return { success:true, selector:\"[data-webauto-send='1']\", via:'pretag' }; }\n  // 2) 以输入框为锚点，限定附近区域查找\n  var input = document.querySelector(\"pre.edit[contenteditable=true], .im-chat-input [contenteditable], .msg-input [contenteditable], div[contenteditable=true], textarea\");\n  var scope = input ? (input.closest(\".im-chat-input, .msg-input, .im-chat, .chat, .footer, .ft, .toolbar, .opt, form\") || document) : document;\n  var excludeTexts = ['下载','安装','客户端','打开客户端','继续在客户端中打开'];\n  var cands = [];\n  var nodes = Array.from(scope.querySelectorAll(\".im-chat-send-btn, .send-btn, .next-btn, [class*='send' i], button, [role='button'], a\"));\n  for (var i=0;i<nodes.length;i++){ var el = nodes[i]; if(!vis(el)) continue; var t=(el.innerText||el.textContent||'').trim(); var cls=String(el.className||''); var title=el.getAttribute? (el.getAttribute('title')||''):''; var looks = (t && (t.includes('发送')||t==='发'||t==='发送')) || /send/i.test(cls) || /send/i.test(title) || el.getAttribute('atype')==='send' || ((el.getAttribute('data-spm')||'').toLowerCase().includes('send')); if(!looks) continue; if(excludeTexts.some(function(x){return t.includes(x);})){continue;} var r=el.getBoundingClientRect(); var score=(r.width*r.height)+((r.y>(innerHeight-220))?5000:0)+((r.x>(innerWidth*0.5))?2500:0); cands.push({el:el,score:score}); }\n  if(!cands.length){ return { success:false, error:'no candidate near input' }; }\n  cands.sort(function(a,b){ return b.score-a.score; });\n  var target = cands[0].el;\n  var clickable = target.closest(\".im-chat-send-btn, .send-btn, .next-btn, button, [role='button']\") || target;\n  try{ clickable.setAttribute('data-webauto-send','1'); }catch(e){}\n  try{ clickable.scrollIntoView({behavior:'instant',block:'center'}); }catch(e){}\n  return { success:true, selector:\"[data-webauto-send='1']\", via:'probe' };\n})();",
        "saveScreenshots": false
      },
      "next": ["click_send"]
    },
    {
      "id": "click_send",
      "type": "AdvancedClickNode",
      "name": "点击发送按钮",
      "config": {
        "preset": "1688",
        "strategy": "prefer_mouse",
        "selector": "[data-webauto-send='1'], .im-chat-send-btn, .send-btn, .next-btn, button[atype='send'], button[type='submit']",
        "frame": { "urlPattern": "air\\.1688\\.com/.*" },
        "scrollIntoView": true,
        "verifyVisibility": true,
        "waitAfter": 1200,
        "verifyNavigation": false,
        "clickMethods": ["mouse_coordinates","event_simulation","playwright_click","javascript_click"],
        "preferChildTarget": true,
        "childSelectors": ["button[atype=send]",".im-chat-send-btn",".send-btn",".next-btn","button","[role=button]","a"],
        "childTextIncludes": ["发送","发","send"],
        "mouseMoveSteps": 12,
        "hoverMs": 60,
        "clickOffsetX": 0,
        "clickOffsetY": 0,
        "showCursorOverlay": true,
        "cursorColor": "#ff2d55",
        "highlightElement": false
      },
      "next": ["post_send_gate"]
    },
    {
      "id": "post_send_gate",
      "type": "GateOverlayNode",
      "name": "发送后人工确认",
      "config": {
        "title": "✅ 已尝试发送‘你好’",
        "message": "请检查聊天窗口中是否出现消息，如确认无误，点击‘下一步’保存结果。",
        "block": true
      },
      "next": ["save"]
    },
    {
      "id": "save",
      "type": "ResultSaverNode",
      "name": "保存结果",
      "config": {
        "outputDir": "workflows/records",
        "filenameTemplate": "1688-search-wangwang-chat-{timestamp}.json",
        "includeMetadata": true,
        "mergeData": true
      },
      "next": [
        "end"
      ]
    },
    {
      "id": "end",
      "type": "EndNode",
      "name": "结束",
      "config": {
        "cleanup": false,
        "saveLogs": true
      }
    }
  ],
  "globalConfig": {
    "logLevel": "info",
    "timeout": 600000,
    "keyword": "冲锋衣"
  }
}
