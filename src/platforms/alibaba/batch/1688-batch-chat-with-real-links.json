{
  "name": "1688æ‰¹é‡èŠå¤©ï¼ˆçœŸå®æ—ºæ—ºé“¾æ¥ï¼‰",
  "description": "ä½¿ç”¨çœŸå®çš„æ—ºæ—ºé“¾æ¥è¿›è¡Œæ‰¹é‡èŠå¤©ï¼Œæ”¯æŒå»é‡å’Œå†å²è®°å½•",
  "version": "1.0.0",
  "preflows": ["1688-login-preflow"],
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "å¼€å§‹", "next": ["attach"] },
    {
      "id": "attach",
      "type": "AttachSessionNode",
      "name": "ä¼šè¯æ¥åŠ›",
      "config": {},
      "next": ["load_history"]
    },
    {
      "id": "load_history",
      "type": "PageSnapshotNode",
      "name": "åˆå§‹åŒ–å†å²è®°å½•",
      "config": {
        "script": "console.log('ğŸ“ åˆå§‹åŒ–å†å²è®°å½•...'); const historyData = localStorage.getItem('1688_sent_history') || '{}'; const sentHistory = JSON.parse(historyData); console.log('å·²åŠ è½½å†å²è®°å½•ï¼Œè®°å½•æ•°é‡:', Object.keys(sentHistory).length); return { success: true, sentHistory: sentHistory, historyCount: Object.keys(sentHistory).length, timestamp: new Date().toISOString() };",
        "saveScreenshots": false
      },
      "next": ["search_keyword"]
    },
    {
      "id": "search_keyword",
      "type": "NavigationNode",
      "name": "æœç´¢å…³é”®å­—(GBKç¼–ç )",
      "config": {
        "url": "https://s.1688.com/selloffer/offer_search.htm?keywords=%B7%FE%D7%B0",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": ["wait_search"]
    },
    {
      "id": "wait_search",
      "type": "WaitNode",
      "name": "ç­‰å¾…æœç´¢ç»“æœåŠ è½½",
      "config": { "minMs": 3000, "maxMs": 5000 },
      "next": ["extract_merchants_with_links"]
    },
    {
      "id": "extract_merchants_with_links",
      "type": "PageSnapshotNode",
      "name": "æå–å•†å®¶ä¿¡æ¯å’ŒçœŸå®æ—ºæ—ºé“¾æ¥",
      "config": {
        "script": "console.log('ğŸ” æå–å•†å®¶ä¿¡æ¯å’ŒçœŸå®æ—ºæ—ºé“¾æ¥...'); const merchants = []; const offerItems = document.querySelectorAll('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]'); console.log('æ‰¾åˆ° ' + offerItems.length + ' ä¸ªå•†å®¶'); const sentHistory = arguments[0] ? arguments[0].sentHistory || {} : {}; const processedIds = new Set(); offerItems.forEach(function(item, index) { if (index < 10) { const title = item.querySelector('h4, [class*=title], a[title]'); const link = item.querySelector('a[href*=\"1688.com\"]'); const price = item.querySelector('[class*=price], [data-price]'); const image = item.querySelector('img[src]'); const merchantName = item.querySelector('[class*=company], [class*=name], [class*=shop]'); // ä¼˜å…ˆå¯»æ‰¾æ‚¨å‘ç°çš„æ—ºæ—ºå…ƒç´  const wangwangSpan = item.querySelector('span.J_WangWang, span[class*=\"WangWang\"]'); const wangwangLink = wangwangSpan ? wangwangSpan.querySelector('a.ww-link') : null; const oldContactButton = item.querySelector('[class*=contact], [class*=chat], [class*=im], .sm-im, .s-im'); const merchantLink = link ? link.href : null; let merchantId = null; if (merchantLink) { const idMatch = merchantLink.match(/member_id=([\\d]+)/); if (idMatch) merchantId = idMatch[1]; else { const pathMatch = merchantLink.match(/\\/(\\d+)\\.htm/); if (pathMatch) merchantId = pathMatch[1]; } } if (merchantId && !processedIds.has(merchantId) && !sentHistory[merchantId]) { processedIds.add(merchantId); // æå–çœŸå®æ—ºæ—ºé“¾æ¥URL let realChatUrl = null; if (wangwangLink && wangwangLink.href) { realChatUrl = wangwangLink.href; console.log('æ‰¾åˆ°çœŸå®æ—ºæ—ºé“¾æ¥:', realChatUrl); } // å¦‚æœæ²¡æœ‰çœŸå®æ—ºæ—ºé“¾æ¥ï¼Œå°è¯•æ„é€ åŸºæœ¬URL else if (merchantId) { realChatUrl = `https://air.1688.com/app/ocms-fusion-components-1688/def_cbu_web_im_core/index.html?uid=${encodeURIComponent(merchantName ? merchantName.textContent.trim() : '')}&site=cnalichn&fromid=cnalichnviridite`; console.log('æ„é€ åŸºç¡€èŠå¤©é“¾æ¥:', realChatUrl); } merchants.push({ index: index, merchantId: merchantId, title: title ? title.textContent.trim() : '', merchantName: merchantName ? merchantName.textContent.trim() : '', price: price ? price.textContent.trim() : '', merchantLink: merchantLink, realChatUrl: realChatUrl, hasWangWang: !!wangwangSpan, hasOldContact: !!oldContactButton, image: image ? image.src : null, isNew: true }); } else if (merchantId) { console.log('å•†å®¶å·²å¤„ç†è¿‡æˆ–å­˜åœ¨äºå†å²è®°å½•:', merchantId); } }); console.log('å»é‡åæå–åˆ° ' + merchants.length + ' ä¸ªæ–°å•†å®¶'); return { success: true, merchants: merchants, totalFound: offerItems.length, duplicatesFiltered: offerItems.length - merchants.length, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["save_batch_data"]
    },
    {
      "id": "save_batch_data",
      "type": "ResultSaverNode",
      "name": "ä¿å­˜æ‰¹é‡æ•°æ®",
      "config": {
        "outputDir": "archive/workflow-records",
        "filenameTemplate": "1688-batch-merchants-with-links-{timestamp}.json",
        "includeMetadata": true
      },
      "next": ["start_batch_processing"]
    },
    {
      "id": "start_batch_processing",
      "type": "PageSnapshotNode",
      "name": "å¼€å§‹æ‰¹é‡å¤„ç†",
      "config": {
        "script": "console.log('ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†å•†å®¶...'); const merchants = arguments[0] ? arguments[0].merchants || [] : []; console.log('å°†è¦å¤„ç† ' + merchants.length + ' ä¸ªå•†å®¶'); if (merchants.length === 0) { return { success: false, message: 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„å•†å®¶', finished: true }; } console.log('å•†å®¶åˆ—è¡¨:', merchants.map(m => `${m.index}: ${m.title.substring(0, 30)} (${m.hasWangWang ? 'æœ‰æ—ºæ—º' : 'æ— æ—ºæ—º'})`)); return { success: true, merchants: merchants, totalToProcess: merchants.length, currentIndex: 0, timestamp: new Date().toISOString() };",
        "saveScreenshots": false
      },
      "next": ["process_single_merchant"]
    },
    {
      "id": "process_single_merchant",
      "type": "PageSnapshotNode",
      "name": "å¤„ç†å•ä¸ªå•†å®¶",
      "config": {
        "script": "console.log('ğŸ”„ å¤„ç†å•ä¸ªå•†å®¶...'); const batchData = arguments[0] || {}; const merchants = batchData.merchants || []; const currentIndex = batchData.currentIndex || 0; const currentMerchant = merchants[currentIndex]; console.log(`å¤„ç†å•†å®¶ ${currentIndex + 1}/${merchants.length}: ${currentMerchant.title.substring(0, 30)}`); return { success: true, currentMerchant: currentMerchant, currentIndex: currentIndex, merchants: merchants, totalToProcess: merchants.length, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["navigate_to_chat"]
    },
    {
      "id": "navigate_to_chat",
      "type": "NavigationNode",
      "name": "å¯¼èˆªåˆ°èŠå¤©é¡µé¢",
      "config": {
        "url": "{{currentMerchant.realChatUrl || currentMerchant.merchantLink}}",
        "waitUntil": "domcontentloaded",
        "timeout": 20000
      },
      "next": ["wait_chat_ready"]
    },
    {
      "id": "wait_chat_ready",
      "type": "WaitNode",
      "name": "ç­‰å¾…èŠå¤©é¡µé¢å‡†å¤‡",
      "config": { "minMs": 3000, "maxMs": 5000 },
      "next": ["send_chat_message"]
    },
    {
      "id": "send_chat_message",
      "type": "ChatHighlightOnlyNode1688",
      "name": "å‘é€èŠå¤©æ¶ˆæ¯(MOCK)",
      "config": {
        "hostFilter": "air.1688.com",
        "message": "æ‚¨å¥½ï¼Œè¯·é—®è¿™ä¸ªäº§å“æœ‰ç°è´§å—ï¼Ÿç°åœ¨ä¸‹å•æœ‰ä¼˜æƒ å—ï¼Ÿ",
        "highlightMs": 3000,
        "mock": true
      },
      "next": ["save_to_history"]
    },
    {
      "id": "save_to_history",
      "type": "PageSnapshotNode",
      "name": "ä¿å­˜åˆ°å†å²è®°å½•",
      "config": {
        "script": "console.log('ğŸ’¾ ä¿å­˜åˆ°å†å²è®°å½•...'); const batchData = arguments[0] || {}; const currentMerchant = batchData.currentMerchant || {}; const sentHistory = JSON.parse(localStorage.getItem('1688_sent_history') || '{}'); const merchantId = currentMerchant.merchantId; if (merchantId) { sentHistory[merchantId] = { merchantId: merchantId, merchantName: currentMerchant.merchantName, title: currentMerchant.title, sentAt: new Date().toISOString(), message: 'æ‚¨å¥½ï¼Œè¯·é—®è¿™ä¸ªäº§å“æœ‰ç°è´§å—ï¼Ÿç°åœ¨ä¸‹å•æœ‰ä¼˜æƒ å—ï¼Ÿ', status: 'sent', chatUrl: currentMerchant.realChatUrl || currentMerchant.merchantLink }; localStorage.setItem('1688_sent_history', JSON.stringify(sentHistory)); console.log('å·²ä¿å­˜å•†å®¶åˆ°å†å²è®°å½•:', merchantId); } return { success: true, merchantId: merchantId, saved: !!merchantId, totalHistoryCount: Object.keys(sentHistory).length, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["wait_between_messages"]
    },
    {
      "id": "wait_between_messages",
      "type": "WaitNode",
      "name": "æ¶ˆæ¯é—´éš”ç­‰å¾…",
      "config": { "minMs": 4000, "maxMs": 6000 },
      "next": ["check_next_merchant"]
    },
    {
      "id": "check_next_merchant",
      "type": "PageSnapshotNode",
      "name": "æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªå•†å®¶",
      "config": {
        "script": "console.log('ğŸ”„ æ£€æŸ¥ä¸‹ä¸€ä¸ªå•†å®¶...'); const batchData = arguments[0] || {}; const merchants = batchData.merchants || []; const currentIndex = batchData.currentIndex || 0; const nextIndex = currentIndex + 1; if (nextIndex < merchants.length) { console.log('ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå•†å®¶:', nextIndex + '/' + merchants.length); const nextMerchant = merchants[nextIndex]; return { success: true, hasMore: true, nextIndex: nextIndex, currentMerchant: nextMerchant, merchants: merchants, processedCount: nextIndex, timestamp: new Date().toISOString() }; } else { console.log('æ‰€æœ‰å•†å®¶å¤„ç†å®Œæˆ'); return { success: true, hasMore: false, processedCount: merchants.length, finished: true, timestamp: new Date().toISOString() }; }",
        "saveScreenshots": true
      },
      "next": ["continue_processing"]
    },
    {
      "id": "continue_processing",
      "type": "NavigationNode",
      "name": "ç»§ç»­å¤„ç†æˆ–ç»“æŸ",
      "config": {
        "url": "{{hasMore ? 'javascript:history.back()' : 'https://www.1688.com/'}}",
        "waitUntil": "domcontentloaded",
        "timeout": 10000
      },
      "next": ["final_check"]
    },
    {
      "id": "final_check",
      "type": "PageSnapshotNode",
      "name": "æœ€ç»ˆæ£€æŸ¥",
      "config": {
        "script": "console.log('âœ… æœ€ç»ˆæ£€æŸ¥å¤„ç†çŠ¶æ€...'); const historyData = localStorage.getItem('1688_sent_history') || '{}'; const sentHistory = JSON.parse(historyData); console.log('æ€»å…±å‘é€æ¶ˆæ¯æ•°é‡:', Object.keys(sentHistory).length); return { success: true, totalSent: Object.keys(sentHistory).length, historyData: sentHistory, sessionCompleted: true, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["save_final_results"]
    },
    {
      "id": "save_final_results",
      "type": "ResultSaverNode",
      "name": "ä¿å­˜æœ€ç»ˆç»“æœ",
      "config": {
        "outputDir": "archive/workflow-records",
        "filenameTemplate": "1688-batch-chat-final-{timestamp}.json",
        "includeMetadata": true
      },
      "next": ["end"]
    },
    {
      "id": "end",
      "type": "EndNode",
      "name": "ç»“æŸ",
      "config": { "cleanup": false, "saveLogs": true }
    }
  ],
  "globalConfig": {
    "logLevel": "info",
    "screenshotOnError": true,
    "autoCleanup": false,
    "parallelExecution": false,
    "timeout": 900000
  }
}