// 1688ËÅäÂ§©ÁïåÈù¢DOMÂàÜÊûêÂ∑•ÂÖ∑
import { chromium } from 'playwright';

async function analyze1688ChatDOM() {
  console.log('üîç ÂºÄÂßãÂàÜÊûê1688ËÅäÂ§©ÁïåÈù¢DOMÁªìÊûÑ...');

  const browser = await chromium.launch({
    headless: false,
    slowMo: 1000
  });

  const context = await browser.newContext({
    viewport: { width: 1280, height: 900 },
    userAgent: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
  });

  // Âä†ËΩΩCookie
  try {
    const fs = require('fs');
    const cookiePath = '/Users/fanzhang/.webauto/cookies/1688-domestic.json';
    if (fs.existsSync(cookiePath)) {
      const cookies = JSON.parse(fs.readFileSync(cookiePath, 'utf8'));
      await context.addCookies(cookies);
      console.log('‚úÖ CookieÂä†ËΩΩÊàêÂäü');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è CookieÂä†ËΩΩÂ§±Ë¥•:', e.message);
  }

  const page = await context.newPage();

  // ÁõëÂê¨ÊéßÂà∂Âè∞ËæìÂá∫
  page.on('console', msg => {
    console.log(`üì¢ [${msg.type()}] ${msg.text()}`);
  });

  // ÁõëÂê¨ËØ∑Ê±Ç
  page.on('request', request => {
    if (request.url().includes('1688.com')) {
      console.log(`üåê ËØ∑Ê±Ç: ${request.method()} ${request.url()}`);
    }
  });

  try {
    // ÂØºËà™Âà∞1688‰∏ªÈ°µÂÖàÁôªÂΩï
    console.log('üöÄ ÂØºËà™Âà∞1688‰∏ªÈ°µ...');
    await page.goto('https://www.1688.com/', { waitUntil: 'domcontentloaded' });
    await page.waitForTimeout(3000);

    // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    const isLoggedIn = await page.evaluate(() => {
      return !!document.querySelector('.member-name, .member-avatar, [data-spm="member"]');
    });

    console.log(`üìã ÁôªÂΩïÁä∂ÊÄÅ: ${isLoggedIn ? 'Â∑≤ÁôªÂΩï' : 'Êú™ÁôªÂΩï'}`);

    if (!isLoggedIn) {
      console.log('‚ö†Ô∏è ÈúÄË¶ÅÊâãÂä®ÁôªÂΩïÔºåËØ∑ÂÆåÊàêÁôªÂΩïÂêéÊåâÂõûËΩ¶ÁªßÁª≠...');
      await page.waitForTimeout(10000);
    }

    // ÂØºËà™Âà∞ËÅäÂ§©È°µÈù¢
    console.log('üí¨ ÂØºËà™Âà∞ËÅäÂ§©È°µÈù¢...');
    const chatUrl = 'https://air.1688.com/app/ocms-fusion-components-1688/def_cbu_web_im/index.html?touid=cnalichn%E6%B0%B8%E5%BA%B7%E5%B8%82%E9%80%94%E6%B4%BE%E5%B7%A5%E8%B4%B8%E6%9C%89%E9%99%90%E5%85%AC%E5%8F%B8&siteid=cnalichn&status=2&portalId=&gid=&offerId=858532417224&itemsId=&spmid=a26352.13672862.offerlist#/';

    await page.goto(chatUrl, { waitUntil: 'domcontentloaded' });
    await page.waitForTimeout(5000);

    // ÂÖ≥Èó≠ÂèØËÉΩÁöÑÂÆ¢Êà∑Á´ØÊèêÁ§∫
    await page.evaluate(() => {
      const texts = ['‰ºòÂÖà‰ΩøÁî®ÁΩëÈ°µÁâà','ÁªßÁª≠‰ΩøÁî®ÁΩëÈ°µÁâà','‰ΩøÁî®ÁΩëÈ°µÁâà','‰ªç‰ΩøÁî®ÁΩëÈ°µ','ÁïôÂú®ÁΩëÈ°µ'];
      const nodes = Array.from(document.querySelectorAll('button, [role="button"], a'));
      for (const node of nodes) {
        const text = node.innerText || '';
        if (texts.some(t => text.includes(t))) {
          node.click();
          break;
        }
      }
    });

    await page.waitForTimeout(3000);

    // Ê∑±Â∫¶DOMÂàÜÊûê
    console.log('üî¨ ÂºÄÂßãÊ∑±Â∫¶DOMÂàÜÊûê...');

    const analysisResult = await page.evaluate(() => {
      const results = {
        pageUrl: window.location.href,
        pageTitle: document.title,
        timestamp: new Date().toISOString()
      };

      // 1. Âü∫Á°ÄÈ°µÈù¢‰ø°ÊÅØ
      results.basicInfo = {
        totalElements: document.querySelectorAll('*').length,
        bodyElementCount: document.body.querySelectorAll('*').length,
        hasReact: !!document.querySelector('[data-reactroot]') || !!window.React,
        hasVue: !!document.querySelector('[data-v-]') || !!window.Vue,
        scriptsCount: document.scripts.length,
        iframesCount: document.querySelectorAll('iframe').length
      };

      // 2. Êü•ÊâæÊâÄÊúâÂèØËÉΩÁöÑËæìÂÖ•ÂÖÉÁ¥†
      results.inputElements = [];

      // Ê†áÂáÜËæìÂÖ•ÂÖÉÁ¥†
      const standardInputs = [
        'textarea', 'input[type="text"]', 'input[type="search"]',
        'input[type="email"]', 'input:not([type])'
      ];

      standardInputs.forEach(selector => {
        document.querySelectorAll(selector).forEach((el, index) => {
          const rect = el.getBoundingClientRect();
          results.inputElements.push({
            type: 'standard',
            selector: selector,
            index: index,
            tag: el.tagName,
            id: el.id,
            className: el.className,
            name: el.name,
            placeholder: el.placeholder,
            visible: rect.width > 0 && rect.height > 0,
            rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
            innerHTML: el.innerHTML.substring(0, 100)
          });
        });
      });

      // contenteditableÂÖÉÁ¥†
      document.querySelectorAll('[contenteditable]').forEach((el, index) => {
        const rect = el.getBoundingClientRect();
        results.inputElements.push({
          type: 'contenteditable',
          index: index,
          tag: el.tagName,
          id: el.id,
          className: el.className,
          contentEditable: el.getAttribute('contenteditable'),
          visible: rect.width > 0 && rect.height > 0,
          rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
          innerText: el.innerText?.substring(0, 100),
          innerHTML: el.innerHTML.substring(0, 100)
        });
      });

      // ÈÄöËøáÁ±ªÂêçÊü•ÊâæÂèØËÉΩÁöÑËÅäÂ§©ËæìÂÖ•ÂÖÉÁ¥†
      const chatInputSelectors = [
        '[class*="input"]', '[class*="editor"]', '[class*="compose"]',
        '[class*="chat"]', '[class*="message"]', '[class*="text"]',
        '[data-input]', '[data-content]', '[role="textbox"]'
      ];

      chatInputSelectors.forEach(selector => {
        try {
          document.querySelectorAll(selector).forEach((el, index) => {
            const rect = el.getBoundingClientRect();
            if (rect.width > 20 && rect.height > 20) {
              results.inputElements.push({
                type: 'potential-chat',
                selector: selector,
                index: index,
                tag: el.tagName,
                id: el.id,
                className: el.className,
                visible: true,
                rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
                innerText: el.innerText?.substring(0, 100),
                innerHTML: el.innerHTML.substring(0, 200),
                events: {
                  onclick: !!el.onclick,
                  oninput: !!el.oninput,
                  onkeydown: !!el.onkeydown,
                  onkeyup: !!el.onkeyup
                }
              });
            }
          });
        } catch (e) {
          console.warn('Selector error:', selector, e.message);
        }
      });

      // 3. Êü•ÊâæÂèëÈÄÅÊåâÈíÆ
      results.sendButtons = [];

      const sendSelectors = [
        'button:has-text("ÂèëÈÄÅ")', 'button:has-text("Send")',
        '[class*="send"]', '[class*="Send"]', '[data-action="send"]',
        'button[type="submit"]', 'a:has-text("ÂèëÈÄÅ")'
      ];

      sendSelectors.forEach(selector => {
        try {
          document.querySelectorAll(selector).forEach((el, index) => {
            const rect = el.getBoundingClientRect();
            if (rect.width > 10 && rect.height > 10) {
              results.sendButtons.push({
                type: 'send-button',
                selector: selector,
                index: index,
                tag: el.tagName,
                id: el.id,
                className: el.className,
                text: el.innerText?.trim(),
                visible: true,
                rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
                innerHTML: el.innerHTML.substring(0, 100)
              });
            }
          });
        } catch (e) {
          console.warn('Send selector error:', selector, e.message);
        }
      });

      // 4. Êü•ÊâæÊâÄÊúâÊåâÈíÆÂÖÉÁ¥†ÔºàÁî®‰∫éÂ§áÁî®Ôºâ
      document.querySelectorAll('button, [role="button"]').forEach((el, index) => {
        const rect = el.getBoundingClientRect();
        const text = el.innerText?.trim();
        if (rect.width > 10 && rect.height > 10 && text) {
          results.sendButtons.push({
            type: 'generic-button',
            index: index,
            tag: el.tagName,
            id: el.id,
            className: el.className,
            text: text,
            visible: true,
            rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
            possibleSend: text.includes('ÂèëÈÄÅ') || text.includes('Send')
          });
        }
      });

      // 5. iframeÂÜÖÂÆπÂàÜÊûê
      results.iframeAnalysis = [];
      document.querySelectorAll('iframe').forEach((frame, index) => {
        try {
          const doc = frame.contentDocument || frame.contentWindow.document;
          results.iframeAnalysis.push({
            index: index,
            src: frame.src,
            accessible: true,
            elementCount: doc.querySelectorAll('*').length,
            inputElements: doc.querySelectorAll('textarea, input, [contenteditable]').length,
            buttons: doc.querySelectorAll('button').length
          });
        } catch (e) {
          results.iframeAnalysis.push({
            index: index,
            src: frame.src,
            accessible: false,
            error: e.message
          });
        }
      });

      // 6. Shadow DOMÂàÜÊûê
      results.shadowDOM = [];
      document.querySelectorAll('*').forEach(el => {
        if (el.shadowRoot) {
          results.shadowDOM.push({
            tag: el.tagName,
            className: el.className,
            shadowElementCount: el.shadowRoot.querySelectorAll('*').length,
            shadowInputs: el.shadowRoot.querySelectorAll('textarea, input, [contenteditable]').length
          });
        }
      });

      // 7. ReactÁªÑ‰ª∂ÂàÜÊûê
      results.reactAnalysis = {
        hasReactRoot: !!document.querySelector('[data-reactroot]'),
        reactComponents: []
      };

      if (results.reactAnalysis.hasReactRoot) {
        document.querySelectorAll('[data-reactroot] *').forEach((el, index) => {
          if (el._reactInternalFiber || el._reactInternalInstance) {
            const rect = el.getBoundingClientRect();
            if (rect.width > 10 && rect.height > 10) {
              results.reactAnalysis.reactComponents.push({
                index: index,
                tag: el.tagName,
                className: el.className,
                rect: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
                hasEvents: !!(el.onclick || el.oninput || el.onkeydown)
              });
            }
          }
        });
      }

      return results;
    });

    console.log('\nüìä ===== 1688ËÅäÂ§©ÁïåÈù¢DOMÂàÜÊûêÁªìÊûú =====');
    console.log('È°µÈù¢URL:', analysisResult.pageUrl);
    console.log('È°µÈù¢Ê†áÈ¢ò:', analysisResult.pageTitle);
    console.log('ÂàÜÊûêÊó∂Èó¥:', analysisResult.timestamp);

    console.log('\nüîß Âü∫Á°Ä‰ø°ÊÅØ:');
    console.log('- ÊÄªÂÖÉÁ¥†Êï∞:', analysisResult.basicInfo.totalElements);
    console.log('- BodyÂÖÉÁ¥†Êï∞:', analysisResult.basicInfo.bodyElementCount);
    console.log('- ReactÈ°µÈù¢:', analysisResult.basicInfo.hasReact);
    console.log('- VueÈ°µÈù¢:', analysisResult.basicInfo.hasVue);
    console.log('- ËÑöÊú¨Êï∞:', analysisResult.basicInfo.scriptsCount);
    console.log('- iframeÊï∞:', analysisResult.basicInfo.iframesCount);

    console.log('\nüìù ËæìÂÖ•ÂÖÉÁ¥†ÂàÜÊûê:');
    console.log(`ÊâæÂà∞ ${analysisResult.inputElements.length} ‰∏™ÊΩúÂú®ËæìÂÖ•ÂÖÉÁ¥†:`);
    analysisResult.inputElements.forEach((input, i) => {
      console.log(`  ${i+1}. ${input.type} - ${input.tag}.${input.className}`);
      console.log(`     ID: ${input.id || 'none'}, ÂèØËßÅ: ${input.visible}`);
      console.log(`     ‰ΩçÁΩÆ: (${Math.round(input.rect.x)}, ${Math.round(input.rect.y)}) ${Math.round(input.rect.width)}x${Math.round(input.rect.height)}`);
      if (input.innerText) console.log(`     ÊñáÊú¨: ${input.innerText.substring(0, 50)}...`);
      console.log('');
    });

    console.log('\nüîò ÂèëÈÄÅÊåâÈíÆÂàÜÊûê:');
    console.log(`ÊâæÂà∞ ${analysisResult.sendButtons.length} ‰∏™ÊåâÈíÆ:`);
    analysisResult.sendButtons.forEach((btn, i) => {
      if (btn.possibleSend || btn.type === 'send-button') {
        console.log(`  ‚úÖ ${i+1}. ${btn.type} - ${btn.text}`);
        console.log(`     ${btn.tag}.${btn.className}`);
        console.log(`     ‰ΩçÁΩÆ: (${Math.round(btn.rect.x)}, ${Math.round(btn.rect.y)}) ${Math.round(btn.rect.width)}x${Math.round(btn.rect.height)}`);
      }
    });

    console.log('\nüñºÔ∏è iframeÂàÜÊûê:');
    if (analysisResult.iframeAnalysis.length > 0) {
      analysisResult.iframeAnalysis.forEach(iframe => {
        console.log(`  iframe ${iframe.index}: ${iframe.accessible ? 'ÂèØËÆøÈóÆ' : 'Ë∑®ÂüüÈôêÂà∂'}`);
        if (iframe.accessible) {
          console.log(`    ÂÖÉÁ¥†Êï∞: ${iframe.elementCount}, ËæìÂÖ•ÂÖÉÁ¥†: ${iframe.inputElements}`);
        }
      });
    } else {
      console.log('  Êó†iframe');
    }

    console.log('\nüåë Shadow DOMÂàÜÊûê:');
    if (analysisResult.shadowDOM.length > 0) {
      analysisResult.shadowDOM.forEach(shadow => {
        console.log(`  ${shadow.tag}.${shadow.className}: ${shadow.shadowElementCount}‰∏™ÂÖÉÁ¥†`);
      });
    } else {
      console.log('  Êó†Shadow DOM');
    }

    console.log('\n‚öõÔ∏è ReactÁªÑ‰ª∂ÂàÜÊûê:');
    if (analysisResult.reactAnalysis.hasReactRoot) {
      console.log(`ÊâæÂà∞ ${analysisResult.reactAnalysis.reactComponents.length} ‰∏™ReactÁªÑ‰ª∂`);
      analysisResult.reactAnalysis.reactComponents.slice(0, 5).forEach(comp => {
        console.log(`  ${comp.tag}.${comp.className} - Êúâ‰∫ã‰ª∂: ${comp.hasEvents}`);
      });
    } else {
      console.log('  ÈùûReactÈ°µÈù¢');
    }

    // ‰øùÂ≠òÂàÜÊûêÁªìÊûú
    const fs = require('fs');
    const resultPath = `/Users/fanzhang/Documents/github/webauto/archive/workflow-records/1688-dom-analysis-${Date.now()}.json`;
    fs.writeFileSync(resultPath, JSON.stringify(analysisResult, null, 2));
    console.log(`\nüíæ ÂàÜÊûêÁªìÊûúÂ∑≤‰øùÂ≠òÂà∞: ${resultPath}`);

    // Êà™Âõæ
    const screenshotPath = `/Users/fanzhang/Documents/github/webauto/archive/workflow-records/1688-chat-screenshot-${Date.now()}.png`;
    await page.screenshot({ path: screenshotPath, fullPage: true });
    console.log(`üì∏ Êà™ÂõæÂ∑≤‰øùÂ≠òÂà∞: ${screenshotPath}`);

    console.log('\n‚è≥ ÊµèËßàÂô®Â∞Ü‰øùÊåÅÊâìÂºÄ30ÁßíÔºåÊÇ®ÂèØ‰ª•ÊâãÂä®Ê£ÄÊü•È°µÈù¢...');
    await page.waitForTimeout(30000);

  } catch (error) {
    console.error('‚ùå ÂàÜÊûêËøáÁ®ã‰∏≠Âá∫Èîô:', error);
  } finally {
    await browser.close();
    console.log('üèÅ ÂàÜÊûêÂÆåÊàê');
  }
}

// ËøêË°åÂàÜÊûê
analyze1688ChatDOM().catch(console.error);