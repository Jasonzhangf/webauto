{
  "name": "1688ç®€å•æ‰¹é‡èŠå¤©",
  "description": "åŸºäºç°æœ‰èŠ‚ç‚¹å®ç°å•†å®¶ä¿¡æ¯æå–å’Œæ‰¹é‡èŠå¤©ï¼ˆæ”¯æŒå»é‡å’Œå†å²è®°å½•ï¼‰",
  "version": "1.0.0",
  "preflows": ["1688-login-preflow"],
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "å¼€å§‹", "next": ["attach"] },
    {
      "id": "attach",
      "type": "AttachSessionNode",
      "name": "ä¼šè¯æ¥åŠ›",
      "config": {},
      "next": ["load_history"]
    },
    {
      "id": "load_history",
      "type": "PageSnapshotNode",
      "name": "åˆå§‹åŒ–å†å²è®°å½•",
      "config": {
        "script": "console.log('ğŸ“ åˆå§‹åŒ–å†å²è®°å½•...'); const historyData = localStorage.getItem('1688_sent_history') || '{}'; const sentHistory = JSON.parse(historyData); console.log('å·²åŠ è½½å†å²è®°å½•ï¼Œè®°å½•æ•°é‡:', Object.keys(sentHistory).length); return { success: true, sentHistory: sentHistory, historyCount: Object.keys(sentHistory).length, timestamp: new Date().toISOString() };",
        "saveScreenshots": false
      },
      "next": ["search_keyword"]
    },
    {
      "id": "search_keyword",
      "type": "NavigationNode",
      "name": "æœç´¢å…³é”®å­—(GBKç¼–ç )",
      "config": {
        "url": "https://s.1688.com/selloffer/offer_search.htm?keywords=%B7%FE%D7%B0",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": ["wait_search"]
    },
    {
      "id": "wait_search",
      "type": "WaitNode",
      "name": "ç­‰å¾…æœç´¢ç»“æœåŠ è½½",
      "config": { "minMs": 3000, "maxMs": 5000 },
      "next": ["extract_merchants"]
    },
    {
      "id": "extract_merchants",
      "type": "PageSnapshotNode",
      "name": "æå–å•†å®¶ä¿¡æ¯(å¸¦å»é‡)",
      "config": {
        "script": "console.log('ğŸ” æå–å•†å®¶ä¿¡æ¯å¹¶å»é‡...'); const merchants = []; const offerItems = document.querySelectorAll('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]'); console.log('æ‰¾åˆ° ' + offerItems.length + ' ä¸ªå•†å®¶'); const sentHistory = arguments[0] ? arguments[0].sentHistory || {} : {}; const processedIds = new Set(); offerItems.forEach(function(item, index) { if (index < 10) { const title = item.querySelector('h4, [class*=title], a[title]'); const link = item.querySelector('a[href*=\"1688.com\"]'); const price = item.querySelector('[class*=price], [data-price]'); const image = item.querySelector('img[src]'); const contactButton = item.querySelector('[class*=contact], [class*=chat], [class*=im], [class*=æ—ºæ—º], .sm-im, .s-im'); const merchantName = item.querySelector('[class*=company], [class*=name], [class*=shop]'); const merchantLink = link ? link.href : null; let merchantId = null; if (merchantLink) { const idMatch = merchantLink.match(/member_id=([\\d]+)/); if (idMatch) merchantId = idMatch[1]; else { const pathMatch = merchantLink.match(/\\/(\\d+)\\.htm/); if (pathMatch) merchantId = pathMatch[1]; } } if (merchantId && !processedIds.has(merchantId) && !sentHistory[merchantId]) { processedIds.add(merchantId); merchants.push({ index: index, merchantId: merchantId, title: title ? title.textContent.trim() : '', merchantName: merchantName ? merchantName.textContent.trim() : '', price: price ? price.textContent.trim() : '', merchantLink: merchantLink, contactLink: contactButton ? contactButton.href || contactButton.getAttribute('data-href') || contactButton.getAttribute('onclick') : null, contactButton: contactButton ? { className: contactButton.className, text: contactButton.textContent, href: contactButton.href } : null, image: image ? image.src : null, isNew: true }); } else if (merchantId) { console.log('å•†å®¶å·²å¤„ç†è¿‡æˆ–å­˜åœ¨äºå†å²è®°å½•:', merchantId); } } }); const pagination = document.querySelector('.ui-pagination, .pagination'); let paginationInfo = null; if (pagination) { const currentPage = pagination.querySelector('.ui-page-active, .active, .current'); const nextButton = pagination.querySelector('.ui-page-next, .next, [class*=next]:not(.disabled)'); paginationInfo = { hasPagination: true, currentPage: currentPage ? currentPage.textContent.trim() : '1', hasNextPage: !!nextButton && !nextButton.classList.contains('disabled') }; } else { paginationInfo = { hasPagination: false }; } console.log('å»é‡åæå–åˆ° ' + merchants.length + ' ä¸ªæ–°å•†å®¶'); return { success: true, merchants: merchants, totalFound: offerItems.length, duplicatesFiltered: offerItems.length - merchants.length, paginationInfo: paginationInfo, currentUrl: window.location.href, pageTitle: document.title, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["save_batch_data"]
    },
    {
      "id": "save_batch_data",
      "type": "ResultSaverNode",
      "name": "ä¿å­˜æ‰¹é‡æ•°æ®",
      "config": {
        "outputDir": "workflows/records",
        "filenameTemplate": "1688-batch-merchants-{timestamp}.json",
        "includeMetadata": true
      },
      "next": ["start_batch_processing"]
    },
    {
      "id": "start_batch_processing",
      "type": "PageSnapshotNode",
      "name": "å¼€å§‹æ‰¹é‡å¤„ç†",
      "config": {
        "script": "console.log('ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†å•†å®¶...'); const merchants = arguments[0] ? arguments[0].merchants || [] : []; console.log('å°†è¦å¤„ç† ' + merchants.length + ' ä¸ªå•†å®¶'); if (merchants.length === 0) { return { success: false, message: 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„å•†å®¶', finished: true }; } return { success: true, merchants: merchants, totalToProcess: merchants.length, currentIndex: 0, timestamp: new Date().toISOString() };",
        "saveScreenshots": false
      },
      "next": ["process_single_merchant"]
    },
    {
      "id": "process_single_merchant",
      "type": "NavigationNode",
      "name": "å¤„ç†å•†å®¶ - å¯¼èˆªåˆ°èŠå¤©",
      "config": {
        "url": "https://air.1688.com/app/ocms-fusion-components-1688/def_cbu_web_im_core/index.html?uid={{merchantName}}&site=cnalichn&fromid=cnalichnviridite",
        "waitUntil": "domcontentloaded",
        "timeout": 15000
      },
      "next": ["wait_chat_ready"]
    },
    {
      "id": "wait_chat_ready",
      "type": "WaitNode",
      "name": "ç­‰å¾…èŠå¤©é¡µé¢å‡†å¤‡",
      "config": { "minMs": 2000, "maxMs": 3000 },
      "next": ["send_chat_message"]
    },
    {
      "id": "send_chat_message",
      "type": "ChatHighlightOnlyNode1688",
      "name": "å‘é€èŠå¤©æ¶ˆæ¯(MOCK)",
      "config": {
        "hostFilter": "air.1688.com",
        "message": "æ‚¨å¥½ï¼Œè¯·é—®è¿™ä¸ªäº§å“æœ‰ç°è´§å—ï¼Ÿ",
        "highlightMs": 2000,
        "mock": true
      },
      "next": ["save_to_history"]
    },
    {
      "id": "save_to_history",
      "type": "PageSnapshotNode",
      "name": "ä¿å­˜åˆ°å†å²è®°å½•",
      "config": {
        "script": "console.log('ğŸ’¾ ä¿å­˜åˆ°å†å²è®°å½•...'); const merchantData = arguments[0] ? arguments[0].currentMerchant || {} : {}; const sentHistory = JSON.parse(localStorage.getItem('1688_sent_history') || '{}'); const merchantId = merchantData.merchantId; if (merchantId) { sentHistory[merchantId] = { merchantId: merchantId, merchantName: merchantData.merchantName, title: merchantData.title, sentAt: new Date().toISOString(), message: 'æ‚¨å¥½ï¼Œè¯·é—®è¿™ä¸ªäº§å“æœ‰ç°è´§å—ï¼Ÿ', status: 'sent' }; localStorage.setItem('1688_sent_history', JSON.stringify(sentHistory)); console.log('å·²ä¿å­˜å•†å®¶åˆ°å†å²è®°å½•:', merchantId); } return { success: true, merchantId: merchantId, saved: !!merchantId, totalHistoryCount: Object.keys(sentHistory).length, timestamp: new Date().toISOString() };",
        "saveScreenshots": false
      },
      "next": ["wait_between_messages"]
    },
    {
      "id": "wait_between_messages",
      "type": "WaitNode",
      "name": "æ¶ˆæ¯é—´éš”ç­‰å¾…",
      "config": { "minMs": 3000, "maxMs": 5000 },
      "next": ["check_next_merchant"]
    },
    {
      "id": "check_next_merchant",
      "type": "PageSnapshotNode",
      "name": "æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€ä¸ªå•†å®¶",
      "config": {
        "script": "console.log('ğŸ”„ æ£€æŸ¥ä¸‹ä¸€ä¸ªå•†å®¶...'); const batchData = arguments[0] ? arguments[0] : {}; const merchants = batchData.merchants || []; const currentIndex = batchData.currentIndex || 0; const nextIndex = currentIndex + 1; if (nextIndex < merchants.length) { console.log('ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªå•†å®¶:', nextIndex + '/' + merchants.length); return { success: true, hasMore: true, nextIndex: nextIndex, currentMerchant: merchants[nextIndex], merchants: merchants, processedCount: nextIndex }; } else { console.log('æ‰€æœ‰å•†å®¶å¤„ç†å®Œæˆ'); return { success: true, hasMore: false, processedCount: merchants.length, finished: true }; }",
        "saveScreenshots": false
      },
      "next": ["continue_processing"]
    },
    {
      "id": "continue_processing",
      "type": "NavigationNode",
      "name": "ç»§ç»­å¤„ç†æˆ–ç»“æŸ",
      "config": {
        "url": "{{hasMore ? 'javascript:history.back()' : 'https://www.1688.com/'}}",
        "waitUntil": "domcontentloaded",
        "timeout": 10000
      },
      "next": ["final_check"]
    },
    {
      "id": "final_check",
      "type": "PageSnapshotNode",
      "name": "æœ€ç»ˆæ£€æŸ¥",
      "config": {
        "script": "console.log('âœ… æœ€ç»ˆæ£€æŸ¥å¤„ç†çŠ¶æ€...'); const historyData = localStorage.getItem('1688_sent_history') || '{}'; const sentHistory = JSON.parse(historyData); console.log('æ€»å…±å‘é€æ¶ˆæ¯æ•°é‡:', Object.keys(sentHistory).length); return { success: true, totalSent: Object.keys(sentHistory).length, historyData: sentHistory, sessionCompleted: true, timestamp: new Date().toISOString() };",
        "saveScreenshots": true
      },
      "next": ["save_final_results"]
    },
    {
      "id": "save_final_results",
      "type": "ResultSaverNode",
      "name": "ä¿å­˜æœ€ç»ˆç»“æœ",
      "config": {
        "outputDir": "workflows/records",
        "filenameTemplate": "1688-batch-chat-final-{timestamp}.json",
        "includeMetadata": true
      },
      "next": ["end"]
    },
    {
      "id": "end",
      "type": "EndNode",
      "name": "ç»“æŸ",
      "config": { "cleanup": false, "saveLogs": true }
    }
  ],
  "globalConfig": {
    "logLevel": "info",
    "screenshotOnError": true,
    "autoCleanup": false,
    "parallelExecution": false,
    "timeout": 900000
  }
}