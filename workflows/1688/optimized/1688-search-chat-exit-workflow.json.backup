{
  "name": "1688 搜索-聊天-退出优化工作流",
  "description": "登录1688 → 搜索'手机保护膜' → 点击第二个商户聊天框 → 发送'你好' → 退出聊天关闭tab → 停留搜索页面",
  "version": "2.0.0",
  "anchor": {
    "hostFilter": "1688.com",
    "selectors": [".userAvatarLogo img", "#alisearch-keywords", "input[name='keywords']"],
    "requireVisible": true,
    "maxWaitMs": 600000,
    "pollIntervalMs": 1500,
    "highlight": true,
    "persistHighlight": true,
    "highlightColor": "#34c759",
    "highlightLabel": "ANCHOR"
  },
  "preflows": [
    "1688-login-preflow"
  ],
  "nodes": [
    {
      "id": "start",
      "type": "StartNode",
      "name": "开始",
      "next": [
        "attach"
      ]
    },
    {
      "id": "attach",
      "type": "AttachSessionNode",
      "name": "会话接力",
      "config": {},
      "next": [
        "navigate_home"
      ]
    },
    {
      "id": "navigate_home",
      "type": "NavigationNode",
      "name": "进入1688主页",
      "config": {
        "url": "https://www.1688.com/",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "stabilize_home"
      ]
    },
    {
      "id": "stabilize_home",
      "type": "WaitNode",
      "name": "主页稳定等待",
      "config": {
        "minMs": 1200,
        "maxMs": 2200
      },
      "next": [
        "antibot_home"
      ]
    },
    {
      "id": "antibot_home",
      "type": "AntiBotMitigationNode",
      "name": "主页轻量反风控",
      "config": {
        "mouseMoves": 3,
        "scroll": true,
        "jitterMinMs": 800,
        "jitterMaxMs": 1600
      },
      "next": [
        "dismiss_home_modals"
      ]
    },
    {
      "id": "dismiss_home_modals",
      "type": "ModalDismissNode",
      "name": "关闭主页弹层",
      "config": {
        "maxAttempts": 5,
        "retryDelay": 400
      },
      "next": [
        "verify_home_login"
      ]
    },
    {
      "id": "verify_home_login",
      "type": "LoginVerificationNode",
      "name": "主页快速登录确认",
      "config": {
        "loginSelectors": [
          ".userAvatarLogo img",
          "[class*=userAvatarLogo] img",
          "img[src*=\"alicdn.com/img/ibank/\"]"
        ],
        "requireVisible": true,
        "maxRetries": 20,
        "retryDelay": 1500
      },
      "next": [
        "save_cookies_after_home"
      ],
      "error": [
        "halt_on_login_fail"
      ]
    },
    {
      "id": "save_cookies_after_home",
      "type": "CookieSaverNode",
      "name": "登录后保存Cookie",
      "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" },
      "next": ["build_gbk_url"]
    },
    {
      "id": "halt_on_login_fail",
      "type": "HaltNode",
      "name": "登录失败停止",
      "config": {
        "message": "主页登录确认失败，停止执行以避免风控"
      }
    },
    {
      "id": "build_gbk_url",
      "type": "GBKURLBuilderNode",
      "name": "GBK编码搜索URL",
      "config": {
        "baseUrl": "https://s.1688.com/selloffer/offer_search.htm",
        "paramName": "keywords",
        "keywordVar": "keyword",
        "extraParams": {
          "n": "y",
          "sortType": "saturationPrice_desc"
        }
      },
      "next": [
        "navigate_search"
      ]
    },
    {
      "id": "navigate_search",
      "type": "NavigationNode",
      "name": "导航到搜索页",
      "config": {
        "url": "{targetUrl}",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "prefer_web_variant"
      ]
    },
    {
      "id": "prefer_web_variant",
      "type": "EventDrivenOptionalClickNode",
      "name": "优先使用网页版(事件驱动)",
      "config": {
        "selectors": [".next-btn","button","[role=button]","a"],
        "textIncludes": ["优先使用网页","使用网页版","继续使用网页版","仍使用网页","留在网页","仅使用网页版"],
        "excludeTexts": ["下载","客户端","安装"],
        "maxWaitMs": 15000,
        "pollIntervalMs": 400,
        "highlight": true,
        "persistHighlight": true,
        "highlightColor": "#ff2d55",
        "click": true,
        "method": "mouse",
        "mouseMoveSteps": 12,
        "hoverMs": 60
      },
      "next": [
        "wait_search"
      ]
    },
    {
      "id": "wait_search",
      "type": "WaitNode",
      "name": "等待搜索结果加载",
      "config": {
        "minMs": 2500,
        "maxMs": 4000
      },
      "next": [
        "search_anchor"
      ]
    },
    {
      "id": "search_anchor",
      "type": "AnchorPointNode",
      "name": "搜索结果锚点",
      "config": {
        "selectors": [".sm-offer-list", "#offer-list", ".offer-list"],
        "requireVisible": true,
        "highlight": true,
        "persistHighlight": true
      },
      "next": [
        "highlight_second_merchant"
      ]
    },
    {
      "id": "highlight_second_merchant",
      "type": "JavaScriptExecutionNode",
      "name": "定位第二个商户旺旺",
      "config": {
        "script": "(function(){\n  function vis(el){ var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>8 && r.height>8; }\n  \n  // 查找所有商品项\n  var offerItems = Array.from(document.querySelectorAll('.sm-offer-item, .offer-item, .sm-offer, .offer-card'));\n  if (offerItems.length < 2) {\n    return { success: false, error: '商品项数量不足，需要至少2个商品' };\n  }\n  \n  // 定位第二个商品项\n  var secondItem = offerItems[1];\n  \n  // 在第二个商品项内查找旺旺链接\n  var wwLinks = Array.from(secondItem.querySelectorAll('.ww-link.ww-online, a[href*=air.1688.com], span.J_WangWang a, .offer-shop-row .ww-link'));\n  \n  if (wwLinks.length === 0) {\n    return { success: false, error: '第二个商品项中未找到旺旺链接' };\n  }\n  \n  var targetLink = wwLinks[0];\n  targetLink.setAttribute('data-webauto-target', 'second-merchant');\n  targetLink.scrollIntoView({behavior:'instant',block:'center'});\n  \n  // 高亮效果\n  targetLink.style.border = '3px solid #ff2d55';\n  targetLink.style.backgroundColor = 'rgba(255,45,85,0.1)';\n  \n  return { \n    success: true, \n    selector: \"[data-webauto-target='second-merchant']\",\n    merchantIndex: 2,\n    totalMerchants: offerItems.length\n  };\n})();",
        "saveScreenshots": false
      },
      "next": [
        "open_second_chat"
      ]
    },
    {
      "id": "open_second_chat",
      "type": "PopupTokenCaptureNode",
      "name": "打开第二个商户聊天",
      "config": {
        "containerSelector": "body",
        "clickSelectors": [
          "[data-webauto-target='second-merchant']"
        ],
        "hostFilter": "air.1688.com",
        "maxItems": 1,
        "minClickDelay": 600,
        "maxClickDelay": 1500,
        "afterPopupWaitMs": 1200,
        "closePopup": false,
        "popupClickSelectors": [
          "body > div:nth-child(23)"
        ],
        "dryMode": false,
        "enforceWebPreference": true,
        "startIndex": 0
      },
      "next": [
        "wait_chat"
      ]
    },
    {
      "id": "wait_chat",
      "type": "WaitNode",
      "name": "等待聊天页加载",
      "config": {
        "minMs": 2000,
        "maxMs": 3000
      },
      "next": [
        "attach_chat"
      ]
    },
    {
      "id": "attach_chat",
      "type": "AttachHostPageNode",
      "name": "附着聊天页",
      "config": {
        "urlPattern": "air\\.1688\\.com/.*",
        "bringToFront": true,
        "waitUntil": "domcontentloaded",
        "timeout": 15000
      },
      "next": [
        "chat_anchor"
      ]
    },
    {
      "id": "chat_anchor",
      "type": "AnchorPointNode",
      "name": "聊天页锚点",
      "config": {
        "frame": { "urlPattern": "def_cbu_web_im_core" },
        "selectors": [".im-chat-input", "div[contenteditable]"],
        "requireVisible": true,
        "highlight": true,
        "persistHighlight": true
      },
      "next": [
        "save_cookies_after_attach"
      ]
    },
    {
      "id": "save_cookies_after_attach",
      "type": "CookieSaverNode",
      "name": "聊天域保存Cookie",
      "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" },
      "next": ["compose"]
    },
    {
      "id": "compose",
      "type": "ChatComposeNode",
      "name": "输入并发送'你好'",
      "config": {
        "hostFilter": "air.1688.com",
        "message": "你好",
        "send": false,
        "sendViaEnter": false,
        "stabilizeMs": 2000,
        "highlightMs": 8000,
        "persistSendHighlight": true,
        "sendHighlightColor": "#ff2d55",
        "sendHighlightLabel": "SEND",
        "inputSelectors": [
          "pre.edit[contenteditable=true]",
          ".im-chat-input [contenteditable]",
          ".msg-input [contenteditable]",
          "div[contenteditable=true]",
          "div[contenteditable]",
          "textarea",
          "[role=textbox]"
        ],
        "sendSelectors": [
          ".next-btn",
          ".im-chat-send-btn",
          ".send-btn",
          "button:has-text(发送)",
          "a:has-text(发送)",
          "[role=button]",
          "button[type=submit]"
        ]
      },
      "next": [
        "probe_send_button"
      ]
    },
    {
      "id": "probe_send_button",
      "type": "JavaScriptExecutionNode",
      "name": "probe send button",
      "config": {
        "frame": { "urlPattern": "air\\.1688\\.com/.*" },
        "script": "(function(){\n  function vis(el){ try{var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>8 && r.height>8;}catch(e){return false;} }\n  // 1) 如果 ChatCompose 已标记则直接使用\n  var pre = document.querySelector(\"[data-webauto-send='1']\");\n  if (pre && vis(pre)) { pre.scrollIntoView({behavior:'instant',block:'center'}); return { success:true, selector:\"[data-webauto-send='1']\", via:'pretag' }; }\n  // 2) 以输入框为锚点，限定附近区域查找\n  var input = document.querySelector(\"pre.edit[contenteditable=true], .im-chat-input [contenteditable], .msg-input [contenteditable], div[contenteditable=true], textarea\");\n  var scope = input ? (input.closest(\".im-chat-input, .msg-input, .im-chat, .chat, .footer, .ft, .toolbar, .opt, form\") || document) : document;\n  var excludeTexts = ['下载','安装','客户端','打开客户端','继续在客户端中打开'];\n  var cands = [];\n  var nodes = Array.from(scope.querySelectorAll(\".im-chat-send-btn, .send-btn, .next-btn, [class*='send' i], button, [role='button'], a\"));\n  for (var i=0;i<nodes.length;i++){ var el = nodes[i]; if(!vis(el)) continue; var t=(el.innerText||el.textContent||'').trim(); var cls=String(el.className||''); var title=el.getAttribute? (el.getAttribute('title')||''):''; var looks = (t && (t.includes('发送')||t==='发'||t==='发送')) || /send/i.test(cls) || /send/i.test(title) || el.getAttribute('atype')==='send' || ((el.getAttribute('data-spm')||'').toLowerCase().includes('send')); if(!looks) continue; if(excludeTexts.some(function(x){return t.includes(x);})){continue;} var r=el.getBoundingClientRect(); var score=(r.width*r.height)+((r.y>(innerHeight-220))?5000:0)+((r.x>(innerWidth*0.5))?2500:0); cands.push({el:el,score:score}); }\n  if(!cands.length){ return { success:false, error:'no candidate near input' }; }\n  cands.sort(function(a,b){ return b.score-a.score; });\n  var target = cands[0].el;\n  var clickable = target.closest(\".im-chat-send-btn, .send-btn, .next-btn, button, [role='button']\");\n  var finalTarget = clickable || target;\n  finalTarget.setAttribute('data-webauto-send','1');\n  finalTarget.scrollIntoView({behavior:'instant',block:'center'});\n  return { success:true, selector:\"[data-webauto-send='1']\", via:'probe', candidates: cands.length };\n})();",
        "saveScreenshots": false
      },
      "next": [
        "click_send"
      ]
    },
    {
      "id": "click_send",
      "type": "AdvancedClickNode",
      "name": "点击发送按钮",
      "config": {
        "preset": "1688",
        "strategy": "prefer_mouse",
        "selector": "[data-webauto-send='1'], .im-chat-send-btn, .send-btn, .next-btn, button[atype='send'], button[type='submit']",
        "frame": { "urlPattern": "air\\.1688\\.com/.*" },
        "scrollIntoView": true,
        "verifyVisibility": true,
        "waitAfter": 1200,
        "verifyNavigation": false,
        "clickMethods": ["mouse_coordinates","event_simulation","playwright_click","javascript_click"],
        "preferChildTarget": true,
        "childSelectors": ["button[atype=send]",".im-chat-send-btn",".send-btn",".next-btn","button","[role=button]","a"],
        "childTextIncludes": ["发送","发","send"],
        "mouseMoveSteps": 12,
        "hoverMs": 60,
        "clickOffsetX": 0,
        "clickOffsetY": 0,
        "showCursorOverlay": true,
        "cursorColor": "#ff2d55",
        "highlightElement": false
      },
      "next": [
        "wait_send_complete"
      ]
    },
    {
      "id": "wait_send_complete",
      "type": "WaitNode",
      "name": "等待发送完成",
      "config": {
        "minMs": 1500,
        "maxMs": 2500
      },
      "next": [
        "close_chat_tab"
      ]
    },
    {
      "id": "close_chat_tab",
      "type": "TabManagementNode",
      "name": "关闭聊天标签页",
      "config": {
        "action": "close",
        "hostFilter": "air.1688.com",
        "confirmClose": true,
        "waitAfterClose": 1000
      },
      "next": [
        "return_to_search"
      ]
    },
    {
      "id": "return_to_search",
      "type": "AttachHostPageNode",
      "name": "返回搜索页面",
      "config": {
        "urlPattern": "s\\.1688\\.com/.*offer_search",
        "bringToFront": true,
        "waitUntil": "domcontentloaded",
        "timeout": 10000
      },
      "next": [
        "verify_search_page"
      ]
    },
    {
      "id": "verify_search_page",
      "type": "AnchorPointNode",
      "name": "验证搜索页面状态",
      "config": {
        "selectors": [".sm-offer-list", "#offer-list", "#alisearch-keywords"],
        "requireVisible": true,
        "highlight": false,
        "maxWaitMs": 10000
      },
      "next": [
        "final_wait"
      ]
    },
    {
      "id": "final_wait",
      "type": "WaitNode",
      "name": "最终稳定等待",
      "config": {
        "minMs": 1000,
        "maxMs": 2000
      },
      "next": [
        "save"
      ]
    },
    {
      "id": "save",
      "type": "ResultSaverNode",
      "name": "保存结果",
      "config": {
        "outputDir": "workflows/records",
        "filenameTemplate": "1688-search-chat-exit-{timestamp}.json",
        "includeMetadata": true,
        "mergeData": true,
        "customData": {
          "workflowType": "search-chat-exit",
          "targetMerchant": "second",
          "keyword": "手机保护膜",
          "message": "你好"
        }
      },
      "next": [
        "end"
      ]
    },
    {
      "id": "end",
      "type": "EndNode",
      "name": "结束",
      "config": {
        "cleanup": false,
        "saveLogs": true,
        "keepBrowserOpen": true
      }
    }
  ],
  "globalConfig": {
    "logLevel": "info",
    "timeout": 600000,
    "keyword": "手机保护膜"
  }
}