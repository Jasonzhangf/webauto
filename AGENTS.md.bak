# WebAuto 架构设计原则与模块职责

## 设计原则

### 1. 扁平化架构
- 无层级依赖，所有模块独立 CLI
- 模块间仅通过统一状态总线交互
- 启动顺序：并行启动，无硬编码依赖

### 2. 状态驱动
- 统一状态总线（Core 模块）实时广播状态变化
- 所有模块状态变化 <1 秒同步
- 状态缓存支持断点恢复

### 3. 功能分割
- 脚本：仅负责服务启动编排（orchestrator）
- 模块：独立 CLI，提供 start/stop/status/health 接口
- 通信：通过统一 HTTP/WebSocket 接口

### 4. 通信协议
- 状态总线：WebSocket 广播（端口 8790）
- 服务通信：HTTP REST API（各模块独立端口）
- 事件格式：{ timestamp, event, data, module }

## 模块职责

### Core 模块（modules/core/）
**职责**：统一状态总线、配置管理、错误处理
- **CLI**：`node modules/core/cli.mjs status|health|config`
- **状态总线**：实时广播模块状态变化
- **配置中心**：集中管理端口、路径、模块配置
- **错误处理**：统一日志聚合与统计

### Browser 模块（modules/browser/）
**职责**：浏览器会话管理、健康验证、通信验证
- **CLI**：`node modules/browser/cli.mjs start|stop|status|health`
- **BrowserService**：HTTP 通信封装
- **BrowserHealthHandshake**：健康握手验证
- **BrowserHealthCommunicator**：双向通信验证
- **BrowserHealthValidator**：完整健康验证

### Workflow 模块（modules/workflow/）
**职责**：工作流引擎管理
- **CLI**：`node modules/workflow/cli.mjs start|stop|status|health`
- **API Gateway**：HTTP 服务（端口 7701）

### Controller 模块（modules/controller/）
**职责**：容器操作与 DOM 交互
- **CLI**：`node modules/controller/cli.mjs start|stop|status|health`
- **WebSocket 服务**：端口 8970

### UI 模块（modules/ui/）
**职责**：浮窗控制台与状态展示
- **CLI**：`node modules/ui/cli.mjs`
- **状态订阅**：连接状态总线实时展示

## 状态报告机制

### 状态总线事件
```json
{
  "timestamp": 1234567890,
  "event": "state:changed",
  "data": {
    "module": "browser",
    "prev": { "status": "stopped" },
    "now": { "status": "running", "sessionId": "weibo_fresh" }
  }
}
```

### 模块状态格式
```json
{
  "status": "running|stopped|error",
  "port": 7704,
  "healthy": true,
  "communicationOk": true,
  "sessionId": "weibo_fresh",
  "lastUpdate": 1234567890
}
```

## 功能调用方式

### 模块间调用
- 通过统一 HTTP API 接口
- 不直接调用其他模块内部函数
- 通过状态总线订阅状态变化

### 脚本调用模块
- 通过模块 CLI 接口
- 通过 HTTP API 接口
- 通过状态总线获取状态

### 健康验证流程
1. **健康握手**：验证服务响应
2. **通信验证**：验证命令接口
3. **状态验证**：验证状态一致性
4. **业务验证**：验证具体功能

## 测试策略

### 单元测试
- 每个模块独立测试
- 测试通信、健康、状态功能
- 无外部依赖，可独立运行

### 集成测试
- 测试模块间交互
- 测试状态总线广播
- 测试完整启动流程

### 验收测试
- 测试 weibo_fresh 全流程
- 测试容器匹配功能
- 测试健康检查闭环

## 当前进度

### 已完成模块
- ✅ **Core 模块**：状态总线、配置、错误处理
- ✅ **Browser 模块**：通信、健康握手、通信验证、完整验证
- ✅ **Workflow 模块**：占位 CLI
- ✅ **Controller 模块**：占位 CLI
- ✅ **UI 模块**：占位 CLI

### 已完成测试
- ✅ **BrowserService**：HTTP 通信测试
- ✅ **BrowserHealthHandshake**：健康握手测试
- ✅ **BrowserHealthCommunicator**：通信验证测试
- ✅ **BrowserHealthValidator**：完整验证测试

### 已完成脚本
- ✅ **launch-core.mjs**：核心服务编排
- ✅ **orchestrator.mjs**：完整服务编排
- ✅ **launch-final.mjs**：最终统一启动

### 待完成
- 容器匹配功能集成
- 完整启动流程验证
- weibo_fresh 全流程测试

## 使用示例

```bash
# 启动核心服务
node scripts/launch-core.mjs --profile weibo_fresh --url https://weibo.com

# 查看状态
node modules/core/cli.mjs status

# 健康检查
node modules/core/cli.mjs health

# 模块测试
node modules/browser/tests/validator.test.mjs
```
