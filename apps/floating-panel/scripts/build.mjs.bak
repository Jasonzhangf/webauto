import { execSync } from 'node:child_process';
import fs from 'node:fs';
import path from 'node:path';

const pkgPath = path.resolve(process.cwd(), 'package.json');
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
const [major, minor, patch = '0'] = String(pkg.version || '0.1.0').split('.');
const patchNum = Number(patch) || 0;
const nextVersion = `${major}.${minor}.${String(patchNum + 1).padStart(3, '0')}`;

const distDir = path.resolve(process.cwd(), 'dist');
const srcRendererHtml = path.resolve(process.cwd(), 'src/renderer/index.html');
const srcRendererJs = path.resolve(process.cwd(), 'src/renderer/index.js');
const distRendererDir = path.join(distDir, 'renderer');
const distRendererHtml = path.join(distRendererDir, 'index.html');
const distRendererJs = path.join(distRendererDir, 'index.js');

console.log('[floating-panel] cleaning dist...');
execSync('rm -rf dist', { stdio: 'inherit' });

console.log('[floating-panel] building TypeScript...');
execSync('tsc', { stdio: 'inherit' });

console.log('[floating-panel] copying renderer assets...');
fs.mkdirSync(distRendererDir, { recursive: true });
fs.copyFileSync(srcRendererHtml, distRendererHtml);
fs.copyFileSync(srcRendererJs, distRendererJs);

pkg.version = nextVersion;
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
console.log(`[floating-panel] bump version to ${pkg.version}`);
console.log('[floating-panel] build complete');
