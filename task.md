# WebAuto 系统修复与验证计划（2026-01-02更新）

## 当前状态总览

### 已完成的修复
- ✅ CI 类型检查问题修复（container-operations.mjs.d.ts）
- ✅ 识别并修复 CI 盲区（缺少端到端启动测试）
- ✅ 修复 PROJECT_ROOT 路径问题（使用 import.meta.url）
- ✅ 添加浮窗启动测试到 CI（test:floating-startup）
- ✅ 基本浮窗启动验证通过

### 待完善：系统健康检查层次

当前测试只验证了**浮窗进程启动**，但完整的系统健康应包含：

1. **服务层健康**
   - Unified API (7701) 启动并响应
   - Browser Service (7704) 启动并响应
   - Controller (8970) 启动并响应

2. **连接层健康**
   - WebSocket 总线连接 (ws://127.0.0.1:7701/bus)
   - 浮窗 UI 与总线成功握手
   - 各服务间消息传递正常

3. **功能层健康**
   - 页面信息获取成功
   - 容器匹配功能正常（有匹配锚点，即使为空）
   - DOM 树拉取功能正常
   - UI 元素正确初始化（图谱、详情面板等）

4. **数据层健康**
   - Session/Profile 管理正常
   - 容器库读写正常
   - 操作配置读写正常

## 执行计划

### 阶段 1：完善健康检查基础设施 ✅
- [x] 1.1 修复 PROJECT_ROOT 路径问题
- [x] 1.2 添加基本启动测试
- [ ] 1.3 扩展健康检查到多层次验证

### 阶段 2：服务层健康验证
- [ ] 2.1 添加 Unified API 健康检查端点测试
- [ ] 2.2 添加 Browser Service 健康检查端点测试
- [ ] 2.3 添加 Controller 健康检查端点测试
- [ ] 2.4 验证服务间依赖关系

### 阶段 3：连接层健康验证
- [ ] 3.1 验证 WebSocket 总线连接
- [ ] 3.2 验证浮窗 ping/pong 机制
- [ ] 3.3 验证消息传递完整性
- [ ] 3.4 验证事件订阅机制

### 阶段 4：功能层健康验证
- [ ] 4.1 验证容器匹配功能（有匹配锚点）
- [ ] 4.2 验证 DOM 树获取功能
- [ ] 4.3 验证 UI 初始化完整性
- [ ] 4.4 验证操作配置读写

### 阶段 5：集成测试
- [ ] 5.1 实现端到端健康检查脚本
- [ ] 5.2 将完整健康检查集成到 CI
- [ ] 5.3 验证完整工作流（启动 → 匹配 → 操作）

## 技术债务记录

### 已修复
- ✅ 2026-01-02: 修复 PROJECT_ROOT 使用 process.cwd() 导致路径错误
- ✅ 2026-01-02: 修复 server.ts import 路径错误（.js → .mjs）
- ✅ 2026-01-02: 添加 container-operations.mjs 类型声明
- ✅ 2026-01-02: 实现 flushPendingMessages 安全检查避免 "Render frame disposed"

### 待修复
- ⚠️  浮窗 UI 初始化验证不完整（只检查日志，未验证功能）
- ⚠️  缺少服务依赖关系验证
- ⚠️  缺少数据层健康检查
- ⚠️  缺少端到端功能测试

## 执行记录
- 2026-01-02 13:00: 识别 CI 盲区，启动测试缺失导致路径问题未被发现
- 2026-01-02 13:30: 修复 PROJECT_ROOT 路径问题，使用 import.meta.url
- 2026-01-02 13:45: 实现浮窗启动测试脚本，验证基本启动成功
- 2026-01-02 13:50: 将 test:floating-startup 添加到 CI 测试链
