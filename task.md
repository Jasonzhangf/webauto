# WebAuto 浮窗 UI 完善实施计划

## 背景

已成功恢复到稳定版本（commit 91c1ebb），系统可以正常启动，容器匹配功能正常。
现在的目标是完善浮窗 UI 的绘制、用户交互和容器编辑功能。

## 当前状态

- ✅ Unified API 服务正常运行 (7701)
- ✅ Browser Service 服务正常运行 (7704)  
- ✅ 容器匹配功能正常
- ✅ 浮窗 UI 已启动并连接
- ✅ 系统可以创建容器并进行编辑
- ✅ DOM-DOM 图形显示正常
- ✅ 容器-DOM 关联正常
- ⚠️  容器编辑功能基础可用，但需要完善

## 实施计划

### 阶段 1: 基础功能验证（MVP）

#### 1.1 完善容器编辑界面（当前重点）

**目标：** 创建完整的 operation CRUD 界面

**需求分析（根据用户要求）：**

a. **Operation 列表显示**
   - [ ] 显示已有的 operations 列表（按执行顺序）
   - [ ] 每个 operation 显示：类型、触发事件、配置预览
   - [ ] 支持拖拽调整顺序
   - [ ] 空状态提示（无 operations 时）

b. **Operation CRUD 操作**
   - [ ] **Create**: 列表下方显示 + 按钮，点击后显示可添加的操作类型菜单
   - [ ] **Read**: 点击 operation 显示详细配置
   - [ ] **Update**: 内联编辑 operation 配置
   - [ ] **Delete**: 删除 operation（带确认）

c. **Operation 测试功能**
   - [ ] 每个 operation 旁边显示"测试"按钮
   - [ ] 点击测试按钮，实际在浏览器中执行该操作
   - [ ] 显示测试结果（成功/失败）

d. **事件触发机制**
   - [ ] 支持基本事件：`appear`（出现）、`click`（点击）、`change`（变化）
   - [ ] 支持自定义事件：允许用户输入自定义事件名
   - [ ] 事件选择器：下拉菜单 + 自定义输入框

e. **根容器特殊操作**
   - [ ] 页面级操作挂在根容器：scroll（滚动）、wait（等待）、navigate（导航）
   - [ ] 根容器 UI 显示不同的操作类型选项

**实施步骤：**

1. [ ] 重构 `renderContainerDetails` 函数
   - 分离 operation 列表渲染逻辑
   - 添加拖拽排序支持
   - 改进空状态显示

2. [ ] 创建 Operation 编辑组件
   - 创建独立的 operation 编辑器
   - 支持内联编辑和弹窗编辑两种模式
   - 添加操作类型选择器

3. [ ] 实现测试功能
   - 通过 unified-api 发送测试请求
   - 在浏览器中实际执行 operation
   - 返回执行结果并显示

4. [ ] 实现事件触发选择
   - 创建事件选择器组件
   - 支持预定义事件 + 自定义事件
   - 更新 operation 数据结构

5. [ ] 特殊处理根容器
   - 检测是否为根容器
   - 显示不同的操作类型选项
   - 添加页面级操作支持

#### 1.2 完善旧容器显示问题
- [ ] 验证没有 operation 的容器是否正确显示内容
- [ ] 添加默认 operation 生成机制
- [ ] 确保 UI 能正确渲染空状态

#### 1.3 完善 UI 组件功能
- [ ] 测试 CapturePanel 组件是否正常工作
- [ ] 测试 ContainerTree 组件是否正常工作
- [ ] 验证容器详情面板的交互

### 阶段 2: 功能完善

#### 2.1 UI 绘制增强
- [ ] 优化 DOM 树的渲染性能
- [ ] 改进容器-DOM 连线的显示效果
- [ ] 添加选中高亮效果

#### 2.2 用户交互优化
- [ ] 添加快捷键支持
- [ ] 优化拖拽体验
- [ ] 添加撤销/重做功能

#### 2.3 容器编辑完善
- [ ] 添加 operation 模板库
- [ ] 支持 operation 的复制粘贴
- [ ] 添加批量编辑功能

### 阶段 3: 高级功能

#### 3.1 自动化增强
- [ ] 添加智能 operation 推荐
- [ ] 自动生成默认 operations
- [ ] AI 辅助编辑

#### 3.2 数据持久化
- [ ] 优化保存机制
- [ ] 添加版本历史
- [ ] 支持导入导出

#### 3.3 调试工具
- [ ] 添加 operation 执行调试
- [ ] 实时预览功能
- [ ] 性能分析工具

## 当前重点

### 立即执行任务（阶段 1.1）

**当前任务：完善容器编辑界面**

1. **第一步：重构 operation 列表显示**
   - 创建独立的 operation 列表渲染函数
   - 添加空状态提示
   - 支持按事件分组显示

2. **第二步：实现 CRUD 操作** （进行中）
   - 添加新 operation
   - 编辑现有 operation
   - 删除 operation
   - 调整顺序

3. **第三步：实现测试功能**
   - 添加测试按钮
   - 实现测试 API 调用
   - 显示测试结果

4. **第四步：完善事件触发**
   - 实现事件选择器
   - 支持自定义事件
   - 更新 UI 显示

5. **第五步：优化根容器**
   - 识别根容器
   - 显示页面级操作
   - 测试完整流程

## 进度跟踪

- [x] 恢复到稳定版本（91c1ebb）
- [x] 系统基础功能验证
- [ ] 阶段 1.1: 完善容器编辑界面（**当前重点**）
  - [x] 分析需求
  - [x] 制定实施计划
  - [ ] 重构 operation 列表显示
  - [ ] 实现 CRUD 操作
  - [ ] 实现测试功能
  - [ ] 完善事件触发
  - [ ] 优化根容器
- [ ] 阶段 1.2: 完善旧容器显示问题
- [ ] 阶段 1.3: 完善 UI 组件功能
- [ ] 阶段 2.1: UI 绘制增强
- [ ] 阶段 2.2: 用户交互优化
- [ ] 阶段 2.3: 容器编辑完善
- [ ] 阶段 3.1: 自动化增强
- [ ] 阶段 3.2: 数据持久化
- [ ] 阶段 3.3: 调试工具

## 注意事项

- 所有修改使用 TypeScript/TS
- 禁止使用 Python 自动化脚本
- 禁止使用模糊匹配的进程终止命令
- 保持 ESM 架构一致性

## 技术要点

### Operation 数据结构

```typescript
interface Operation {
  id: string;
  type: 'highlight' | 'click' | 'scroll' | 'extract' | 'wait' | ...;
  triggers: string[]; // 事件列表：['appear', 'click', 'custom:myevent']
  enabled: boolean;
  config: Record<string, any>;
}
```

### 事件类型

**基本事件：**
- `appear`: 容器出现时触发
- `click`: 用户点击容器时触发
- `change`: 容器内容变化时触发

**页面级事件（仅根容器）：**
- `page:load`: 页面加载完成
- `page:scroll`: 页面滚动
- `page:navigate`: 页面导航

**自定义事件：**
- 格式：`custom:eventName`
- 用户可自由定义事件名

### Operation 类型

**通用操作：**
- `highlight`: 高亮显示
- `click`: 点击操作
- `extract`: 提取数据
- `wait`: 等待

**根容器专属操作：**
- `scroll`: 页面滚动
- `navigate`: 页面导航
- `screenshot`: 截图

## 完成标准

### 阶段 1.1 完成标准

1. **UI 呈现**
   - [ ] operation 列表清晰显示，包含类型、事件、配置
   - [ ] 支持拖拽调整顺序
   - [ ] 空状态有友好提示

2. **功能完整**
   - [ ] 可以添加/编辑/删除 operation
   - [ ] 测试按钮可以实际执行操作
   - [ ] 事件选择器支持预定义 + 自定义

3. **代码质量**
   - [ ] TypeScript 类型完整
   - [ ] 代码结构清晰，易于维护
   - [ ] 有必要的注释和文档
