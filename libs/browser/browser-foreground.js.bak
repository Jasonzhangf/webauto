/**
 * 前台浏览器服务
 * 在前台模式下运行浏览器，可以通过远程API控制
 */

import http from 'http';
import { spawn } from 'child_process';
import { CamoufoxBrowserNonHeadless } from './camoufox-nonheadless.js';
import { ensureDefaultProfile } from './default-profile.js';

let browserInstance = null;

function json(res, status, body) {
    const data = JSON.stringify(body);
    res.writeHead(status, {
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(data)
    });
    res.end(data);
}

// 清理函数
async function cleanup() {
    if (browserInstance) {
        try {
            await browserInstance.close();
            console.log('✅ 前台浏览器已关闭');
        } catch (error) {
            console.warn('⚠️  关闭浏览器时出错:', error.message);
        }
        browserInstance = null;
    }
}

// 优雅关闭
process.on('SIGINT', async () => {
    console.log('\\n收到SIGINT信号，正在关闭浏览器...');
    await cleanup();
    process.exit(0);
});

process.on('SIGTERM', async () => {
    console.log('\\n收到SIGTERM信号，正在关闭浏览器...');
    await cleanup();
    process.exit(0);
});

// 确保默认配置存在
ensureDefaultProfile();

