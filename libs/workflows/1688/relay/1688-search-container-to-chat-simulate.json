{
  "name": "1688 搜索容器→聊天(模拟输入/不发送)",
  "version": "1.0.0",
  "variables": { "keyword": "钢化膜", "startIndex": 0, "chatMessage": "你好" },
  "preflows": ["1688-login-preflow"],
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "开始", "next": ["attach"] },
    { "id": "attach", "type": "AttachSessionNode", "name": "会话接力", "config": {}, "next": ["anchor_list"] },

    { "id": "anchor_list", "type": "ContainerAnchorNode", "name": "列表容器锚点", "config": { "containerName": "search.listContainer", "highlight": true, "label": "LIST", "durationMs": 3000, "outScopeVar": "activeScope" }, "next": ["select_item"] },
    { "id": "select_item", "type": "ContainerSelectNode", "name": "选择第N个结果项", "config": { "containerName": "search.item", "parentScopeVar": "activeScope", "indexVar": "startIndex", "outScopeVar": "activeScope", "highlight": true, "label": "ITEM", "durationMs": 3000 }, "next": ["anchor_ww"] },
    { "id": "anchor_ww", "type": "ContainerAnchorNode", "name": "锚定旺旺链接", "config": { "containerName": "search.item.wangwangLink", "scopeVar": "activeScope", "outScopeVar": "wwScope", "highlight": true, "label": "WW LINK", "durationMs": 3000 }, "next": ["extract_company"] },

    { "id": "extract_company", "type": "JavaScriptExecutionNode", "name": "读取公司名(.desc-text)", "config": { "script": "(function(){ try{ var scopeSel='{activeScope}'; var root=scopeSel?document.querySelector(scopeSel):document; var cname=''; if(root){ var el=root.querySelector('.desc-text'); if(el) cname=(el.innerText||el.textContent||'').trim(); } return { success:true, variables:{ companyName:cname } }; }catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["check_history"] },
    { "id": "check_history", "type": "ContactHistoryNode", "name": "历史去重检查", "config": { "action": "check", "site": "1688", "keyVarName": "companyName" }, "next": ["dedup_condition"] },
    { "id": "dedup_condition", "type": "ConditionNode", "name": "是否已发送", "config": { "mode": "variable", "varName": "alreadySent", "operator": "==", "value": true }, "next": ["skip_open"], "error": ["pre_close_before_open"] },
    { "id": "pre_close_before_open", "type": "CloseHostPageNode", "name": "预关闭历史聊天Tab", "config": { "urlPattern": "(air|im)\\.1688\\.com/.*", "closeAll": true }, "next": ["open"] },
    { "id": "skip_open", "type": "GateOverlayNode", "name": "跳过已发送对象", "config": { "title": "跳过已发", "message": "{companyName}", "block": false }, "next": ["end"] },

    { "id": "open", "type": "ContainerActionNode", "name": "点击旺旺链接", "config": { "containerName": "search.item.wangwangLink", "scopeVar": "activeScope", "action": "click" }, "next": ["wait_chat"] },
    { "id": "wait_chat", "type": "WaitNode", "name": "等待聊天页", "config": { "minMs": 1500, "maxMs": 2500 }, "next": ["attach_chat"] },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "(air|im)\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 20000 }, "next": ["pause_chat_1"] },
    { "id": "pause_chat_1", "type": "WaitNode", "name": "间隔(打开聊天)", "config": { "minMs": 3000, "maxMs": 3000 }, "next": ["chat_root"] },
    { "id": "chat_root", "type": "ContainerAnchorNode", "name": "锚定聊天根容器", "config": { "containerName": "chat.root", "frame": { "urlPattern": "def_cbu_web_im_core" }, "outScopeVar": "activeChatScope", "highlight": true, "label": "CHAT ROOT", "durationMs": 3000 }, "next": ["pause_chat_2"] },
    { "id": "pause_chat_2", "type": "WaitNode", "name": "间隔(定位根容器)", "config": { "minMs": 3000, "maxMs": 3000 }, "next": ["chat_input"] },
    { "id": "chat_input", "type": "ContainerAnchorNode", "name": "锚定输入区域", "config": { "containerName": "chat.inputBox", "frame": { "urlPattern": "def_cbu_web_im_core" }, "scopeVar": "activeChatScope", "outScopeVar": "activeInputScope", "highlight": true, "label": "INPUT", "durationMs": 3000 }, "next": ["pause_chat_3"] },
    { "id": "pause_chat_3", "type": "WaitNode", "name": "间隔(定位输入)", "config": { "minMs": 3000, "maxMs": 3000 }, "next": ["chat_type"] },
    { "id": "chat_type", "type": "ContainerActionNode", "name": "输入消息(容器op)", "config": { "containerName": "chat.inputBox", "frame": { "urlPattern": "def_cbu_web_im_core" }, "scopeVar": "activeChatScope", "action": "type", "textVar": "chatMessage", "clear": true, "targetChildSelectors": ["[contenteditable][role='textbox']","[contenteditable=true]","[contenteditable]","pre.edit"] }, "next": ["pause_chat_4"] },
    { "id": "pause_chat_4", "type": "WaitNode", "name": "间隔(输入完成)", "config": { "minMs": 3000, "maxMs": 3000 }, "next": ["chat_send_anchor"] },
    { "id": "chat_send_anchor", "type": "ContainerAnchorNode", "name": "锚定发送按钮", "config": { "containerName": "chat.sendButton", "frame": { "urlPattern": "def_cbu_web_im_core" }, "scopeVar": "activeChatScope", "outScopeVar": "chatSend", "highlight": true, "label": "SEND", "durationMs": 3000 }, "next": ["pause_chat_5"] },
    { "id": "pause_chat_5", "type": "WaitNode", "name": "间隔(定位发送按钮)", "config": { "minMs": 3000, "maxMs": 3000 }, "next": ["record_contact"] },
    { "id": "record_contact", "type": "ContactHistoryNode", "name": "记录发送对象(仅记录)", "config": { "action": "add", "site": "1688", "keyVarName": "companyName" }, "next": ["close_chat_tab"] },
    { "id": "close_chat_tab", "type": "CloseHostPageNode", "name": "关闭聊天Tab", "config": { "urlPattern": "(air|im)\\.1688\\.com/.*", "closeAll": true }, "next": ["attach_back_search"] },
    { "id": "attach_back_search", "type": "AttachHostPageNode", "name": "切回搜索页", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 10000 }, "next": ["end"] },
    { "id": "end", "type": "EndNode", "name": "结束", "config": { "cleanup": false, "saveLogs": true } }
  ],
  "globalConfig": { "timeout": 600000, "logLevel": "info" }
}
