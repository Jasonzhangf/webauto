{
  "name": "1688 搜索-旺旺-聊天接力",
  "description": "预登录 → GBK关键词搜索 → 高亮候选旺旺 → 打开聊天页 → 输入‘你好’并发送（保留浏览器）",
  "version": "1.0.0",
  "variables": {
    "keyword": "冲锋衣"
  },
  "anchor": {
    "hostFilter": "1688.com",
    "selectors": [
      ".userAvatarLogo img",
      "#alisearch-keywords",
      "input[name='keywords']",
      "a[data-spm=dnick]",
      "a[href*=\\/\\/work.1688.com/]"
    ],
    "requireVisible": true,
    "maxWaitMs": 600000,
    "pollIntervalMs": 1500,
    "highlight": true,
    "persistHighlight": true,
    "highlightColor": "#34c759",
    "highlightLabel": "ANCHOR"
  },
  "preflows": [
    "1688-login-preflow"
  ],
  "nodes": [
    {
      "id": "start",
      "type": "StartNode",
      "name": "开始",
      "next": [
        "attach"
      ]
    },
    {
      "id": "attach",
      "type": "AttachSessionNode",
      "name": "会话接力",
      "config": {},
      "next": [
        "navigate_home"
      ]
    },
    {
      "id": "navigate_home",
      "type": "NavigationNode",
      "name": "进入1688主页",
      "config": {
        "url": "https://www.1688.com/",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "stabilize_home"
      ]
    },
    {
      "id": "stabilize_home",
      "type": "WaitNode",
      "name": "主页稳定等待",
      "config": {
        "minMs": 1200,
        "maxMs": 2200
      },
      "next": [
        "antibot_home"
      ]
    },
    {
      "id": "antibot_home",
      "type": "AntiBotMitigationNode",
      "name": "主页轻量反风控",
      "config": {
        "mouseMoves": 3,
        "scroll": true,
        "jitterMinMs": 800,
        "jitterMaxMs": 1600
      },
      "next": [
        "dismiss_home_modals"
      ]
    },
    {
      "id": "dismiss_home_modals",
      "type": "ModalDismissNode",
      "name": "关闭主页弹层",
      "config": {
        "maxAttempts": 5,
        "retryDelay": 400
      },
      "next": [
        "verify_home_login"
      ]
    },
    {
      "id": "verify_home_login",
      "type": "LoginVerificationNode",
      "name": "主页快速登录确认",
      "config": {
        "loginSelectors": [
          ".userAvatarLogo img",
          "[class*=userAvatarLogo] img",
          "img[src*=\\\"alicdn.com/img/ibank/\\\"]",
          "a[data-spm=dnick]",
          "a[data-spm=dlevel]",
          "a[data-spm=dcart]",
          "a[data-spm=dcollection]",
          "a[data-spm=dshop]",
          "a[data-spm=dhistory]",
          "a[href*=\\/\\/work.1688.com/]",
          "a[href*=purchase.1688.com/favorites]",
          "a[href*=cart.1688.com]"
        ],
        "requireVisible": true,
        "maxRetries": 20,
        "retryDelay": 1500
      },
      "next": [
        "save_cookies_after_home"
      ],
      "error": [
        "halt_on_login_fail"
      ]
    },
    {
      "id": "save_cookies_after_home",
      "type": "CookieSaverNode",
      "name": "登录后保存Cookie",
      "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" },
      "next": ["snapshot_home"]
    },
    { "id": "snapshot_home", "type": "PageSnapshotNode", "name": "首页快照(已登录)", "config": { "maxHtmlLength": 400000 }, "next": ["build_gbk_url"] },
    {
      "id": "halt_on_login_fail",
      "type": "HaltNode",
      "name": "登录失败停止",
      "config": {
        "message": "主页登录确认失败，停止执行以避免风控"
      }
    },
    {
      "id": "build_gbk_url",
      "type": "GBKURLBuilderNode",
      "name": "GBK编码搜索URL",
      "config": {
        "baseUrl": "https://s.1688.com/selloffer/offer_search.htm",
        "paramName": "keywords",
        "keywordVar": "keyword",
        "extraParams": {
          "n": "y"
        }
      },
      "next": [
        "navigate_search"
      ]
    },
    {
      "id": "navigate_search",
      "type": "NavigationNode",
      "name": "导航到搜索页",
      "config": {
        "url": "{targetUrl}",
        "waitUntil": "domcontentloaded",
        "timeout": 30000
      },
      "next": [
        "prefer_web_variant"
      ]
    },
    {
      "id": "prefer_web_variant",
      "type": "EventDrivenOptionalClickNode",
      "name": "优先使用网页版(事件驱动)",
      "config": {
        "selectors": [".next-btn","button","[role=button]","a"],
        "textIncludes": ["优先使用网页","使用网页版","继续使用网页版","仍使用网页","留在网页","仅使用网页版"],
        "excludeTexts": ["下载","客户端","安装"],
        "maxWaitMs": 15000,
        "pollIntervalMs": 400,
        "highlight": true,
        "persistHighlight": true,
        "highlightColor": "#ff2d55",
        "click": true,
        "method": "mouse",
        "mouseMoveSteps": 12,
        "hoverMs": 60
      },
      "next": [
        "wait_search"
      ]
    },
    {
      "id": "wait_search",
      "type": "WaitNode",
      "name": "等待搜索结果加载",
      "config": {
        "minMs": 2500,
        "maxMs": 4000
      },
      "next": [
        "snapshot_search_results"
      ]
    },
    { "id": "snapshot_search_results", "type": "PageSnapshotNode", "name": "搜索结果快照", "config": { "maxHtmlLength": 500000 }, "next": ["log_after_search"] },
    { "id": "log_after_search", "type": "BehaviorLogNode", "name": "搜索阶段行为日志", "config": { "outputDir": "archive/workflow-records" }, "next": ["search_anchor"] },
    { "id": "search_anchor", "type": "AnchorPointNode", "name": "搜索结果锚点", "config": {
        "selectors": [
          ".sm-offer-list",
          ".sm-offer",
          "#offer-list",
          ".offer-list",
          ".sm-offer-item",
          ".input-button .input-button-text",
          "span.input-button-text",
          "#img-search-upload",
          "input#img-search-upload"
        ],
        "requireVisible": true,
        "maxWaitMs": 5000,
        "pollIntervalMs": 500,
        "highlight": true,
        "persistHighlight": true
      }, "next": ["highlight_candidates"], "error": ["highlight_candidates"] },
    {
      "id": "highlight_candidates",
      "type": "JavaScriptExecutionNode",
      "name": "高亮旺旺候选(预跑,不消失)",
      "config": {
        "script": "(function(){\n  function vis(el){ var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>8 && r.height>8; }\n  var list = Array.from(document.querySelectorAll('a.ww-link, span.J_WangWang a.ww-link, a[href*=\\\"im.1688.com\\\"], a[href*=\\\"air.1688.com\\\"], button,[role=\\\"button\\\"],.next-btn,.send-btn'));\n  var scored=[];\n  for (var i=0;i<list.length;i++){ try{ var el=list[i]; if(!vis(el)) continue; var r=el.getBoundingClientRect(); var score=(r.width*r.height)+((r.y>(innerHeight-160))?5000:0)+((r.x>(innerWidth*0.5))?2500:0); scored.push({el:el,score:score}); }catch(e){} }\n  if(!scored.length){ return { success:true, info:'no candidate' }; }\n  scored.sort(function(a,b){ return b.score-a.score; });\n  var el=scored[0].el;\n  try{ el.setAttribute('data-webauto-send','1'); }catch(e){}\n  try{ el.scrollIntoView({behavior:'instant',block:'center'}); }catch(e){}\n  return { success:true, selector:\"[data-webauto-send='1']\" };\n})();",
        "saveScreenshots": false
      },
      "next": [
        "resolve_contact_key"
      ]
    },
    { "id": "resolve_contact_key", "type": "JavaScriptExecutionNode", "name": "解析候选身份", "config": { "script": "(function(){ try{\n  function pickAnchor(){\n    var mark=document.querySelector('[data-webauto-send=\\\"1\\\"]');\n    var list=Array.from(document.querySelectorAll('span.J_WangWang a.ww-link, a.ww-link[href*=\\\"air.1688.com\\\"], a.ww-link[href*=\\\"im.1688.com\\\"]'));\n    if(!list.length) return null;\n    if(mark){ var card = mark.closest('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]'); if(card){ var inCard=list.find(function(a){return card.contains(a);}); if(inCard) return inCard; } }\n    return list[0];\n  }\n  var a = pickAnchor();\n  if(!a) return {success:false,error:'no a.ww-link'};\n  var href=a.href||a.getAttribute('href')||'';\n  var uid='', offerId=null, fromid='';\n  try{ var u=new URL(href, location.href); var q=u.searchParams; uid = q.get('uid')||q.get('touid')||''; offerId = q.get('offerId')||q.get('offerid')||null; fromid = q.get('fromid')||''; }catch(e){}\n  if(!uid){ try{ var span=(a.closest('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]')||document).querySelector('span.J_WangWang, span[class*=WangWang]'); uid=span?(span.getAttribute('data-nick')||''):''; }catch(e){} }\n  var key=(uid||'')+':'+(offerId||'');\n  // 搜索卡片中的公司名（如 .desc-text）\n  var card = a.closest('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]') || document;\n  var cname='';\n  try{ var candSel=['.desc-text','.company-name','.shop-name','[data-spm*=company]']; for(var i=0;i<candSel.length;i++){ var el=card.querySelector(candSel[i]); if(el){ cname=(el.innerText||el.textContent||'').trim(); if(cname) break; } } }catch(e){}\n  return { success:true, variables:{ contactUid: uid, contactOfferId: offerId, contactKey: key, chatUrl: href, companyName: cname } };\n}catch(e){ return { success:false, error:String(e) }; } )();", "saveScreenshots": false }, "next": ["check_history"] },
    { "id": "check_history", "type": "ContactHistoryNode", "name": "历史去重检查", "config": { "action": "check", "site": "1688", "keyVarName": "companyName" }, "next": ["dedup_condition"] },
    { "id": "dedup_condition", "type": "ConditionNode", "name": "是否已发送", "config": { "mode": "variable", "varName": "alreadySent", "operator": "==", "value": true }, "next": ["skip_open"], "error": ["snapshot_before_open_chat"] },
    { "id": "skip_open", "type": "GateOverlayNode", "name": "跳过已发送对象", "config": { "title": "跳过已发送", "message": "该公司已发送过，跳过打开：{companyName}", "block": false }, "next": ["save"] },
    { "id": "snapshot_before_open_chat", "type": "PageSnapshotNode", "name": "打开聊天前快照", "config": { "maxHtmlLength": 500000 }, "next": ["log_before_open_chat"] },
    { "id": "log_before_open_chat", "type": "BehaviorLogNode", "name": "打开聊天前行为日志", "config": { "outputDir": "archive/workflow-records" }, "next": ["has_chat_url"] },
    { "id": "has_chat_url", "type": "ConditionNode", "name": "是否已有chatUrl", "config": { "mode": "variable", "varName": "chatUrl", "operator": "includes", "value": "air.1688.com" }, "next": ["navigate_chat"], "error": ["open_chat"] },
    { "id": "navigate_chat", "type": "NavigationNode", "name": "直接导航到聊天页", "config": { "url": "{chatUrl}", "waitUntil": "domcontentloaded", "timeout": 30000 }, "next": ["wait_chat"] },
    {
      "id": "open_chat",
      "type": "JavaScriptExecutionNode",
      "name": "直接打开旺旺聊天链接",
      "config": {
        "script": "(function(){ try{\n  var a = document.querySelector('[data-webauto-send=\\\"1\\\"]') || document.querySelector('span.J_WangWang a.ww-link, a.ww-link[href*=\\\"air.1688.com\\\"], a.ww-link[href*=\\\"im.1688.com\\\"]');\n  if(!a) return { success:false, error:'no chat link' };\n  try { a.click(); } catch(e) { try{ var href=a.href||a.getAttribute('href'); if(href) window.open(href, '_blank'); }catch(e2){} }\n  return { success:true };\n}catch(e){ return { success:false, error:String(e) }; } })();",
        "saveScreenshots": false
      },
      "next": [
        "wait_chat"
      ],
      "error": [
        "wait_chat"
      ]
    },
    {
      "id": "wait_chat",
      "type": "WaitNode",
      "name": "等待聊天页加载",
      "config": {
        "minMs": 2000,
        "maxMs": 3000
      },
      "next": [
        "attach_chat"
      ]
    },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "air\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["pause_for_anchor"], "error": ["compose"] },
    { "id": "pause_for_anchor", "type": "GateOverlayNode", "name": "等待锚点交互确认", "config": { "title": "自动注入锚点探针", "message": "已自动标记输入/发送整块，继续执行。", "block": false }, "next": ["dev_probe"] },
    { "id": "dev_probe", "type": "DevEvalNode", "name": "Dev 注入(整块标记)", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "filePath": "local-dev/chat-anchors-probe.js", "continueOnError": true }, "next": ["chat_anchor"] },
    { "id": "chat_anchor", "type": "AnchorPointNode", "name": "聊天页锚点", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "selectors": ["[data-webauto-input-area='1']", ".im-chat-input", "div[contenteditable]"], "requireVisible": true, "highlight": true, "persistHighlight": true }, "next": ["extract_company_chat"] },
    { "id": "extract_company_chat", "type": "JavaScriptExecutionNode", "name": "提取聊天公司名", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "script": "(function(){ try{ var el=document.querySelector('.companyName'); var name=el? (el.innerText||el.textContent||'').trim():''; return { success:true, variables:{ companyNameChat: name } }; }catch(e){ return { success:false, error:String(e) }; } })();", "saveScreenshots": false }, "next": ["snapshot_chat"] },
    { "id": "snapshot_chat", "type": "PageSnapshotNode", "name": "聊天页快照", "config": { "maxHtmlLength": 500000 }, "next": ["save_cookies_after_attach"] },
    { "id": "save_cookies_after_attach", "type": "CookieSaverNode", "name": "聊天域保存Cookie", "config": { "cookiePath": "~/.webauto/cookies/1688-domestic.json" }, "next": ["compose"] },
    {
      "id": "compose",
      "type": "ChatComposeNode",
      "name": "输入并发送‘你好’",
      "config": {
        "hostFilter": "air.1688.com",
        "message": "你好",
        "send": false,
        "sendViaEnter": false,
        "stabilizeMs": 2000,
        "highlightMs": 8000,
        "persistSendHighlight": true,
        "sendHighlightColor": "#ff2d55",
        "sendHighlightLabel": "SEND",
        "inputSelectors": [
          "[data-webauto-input='1']",
          "pre.edit[contenteditable=true]",
          ".im-chat-input [contenteditable]",
          ".msg-input [contenteditable]",
          "div[contenteditable=true]",
          "div[contenteditable]",
          "textarea",
          "[role=textbox]"
        ],
        "sendSelectors": [
          "[data-webauto-send='1']",
          ".im-chat-send-btn",
          ".send-btn",
          ".next-btn",
          "button:has-text(发送)",
          "a:has-text(发送)",
          "[role=button]",
          "button[type=submit]"
        ]
      },
      "next": [
        "record_contact"
      ]
    },
    
    { "id": "record_contact", "type": "ContactHistoryNode", "name": "记录发送对象", "config": { "action": "add", "site": "1688", "keyVarName": "companyName" }, "next": ["post_send_gate"] },
    {
      "id": "post_send_gate",
      "type": "GateOverlayNode",
      "name": "发送后人工确认",
      "config": {
        "title": "✅ 已尝试发送‘你好’",
        "message": "请检查聊天窗口中是否出现消息，如确认无误，点击‘下一步’保存结果。",
        "block": false
      },
      "next": ["save"]
    },
    { "id": "log_before_save", "type": "BehaviorLogNode", "name": "保存前行为日志", "config": { "outputDir": "archive/workflow-records" }, "next": ["save"] },
    {
      "id": "save",
      "type": "ResultSaverNode",
      "name": "保存结果",
      "config": {
        "outputDir": "archive/workflow-records",
        "filenameTemplate": "1688-search-wangwang-chat-{timestamp}.json",
        "includeMetadata": true,
        "mergeData": true
      },
      "next": [
        "close_chat_tab"
      ]
    },
    { "id": "close_chat_tab", "type": "CloseHostPageNode", "name": "关闭聊天Tab", "config": { "hostIncludes": "air.1688.com", "closeAll": false }, "next": ["attach_back_search"] },
    { "id": "attach_back_search", "type": "AttachHostPageNode", "name": "切回搜索结果", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 10000 }, "next": ["end"] },
    {
      "id": "end",
      "type": "EndNode",
      "name": "结束",
      "config": {
        "cleanup": false,
        "saveLogs": true
      }
    }
  ],
  "globalConfig": {
    "logLevel": "info",
    "timeout": 600000,
    "keyword": "冲锋衣"
  }
}
