{
  "name": "1688 搜索页接力-只输入不发送(公司名去重)",
  "description": "在已打开的搜索结果页内去重并逐个打开聊天页，输入“你好”但不发送，保存历史并关闭Tab。",
  "version": "1.0.0",
  "variables": { "keyword": "钢化膜" },
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "开始", "next": ["attach"] },
    { "id": "attach", "type": "AttachSessionNode", "name": "会话接力", "config": {}, "next": ["set_idx"] },
    { "id": "set_idx", "type": "JavaScriptExecutionNode", "name": "设置候选索引", "config": { "script": "(function(){ try{ var idx=Number(arguments[0]&&arguments[0].startIndex||0)||0; window.__wwClickIndex=idx; return { success:true, idx:idx }; }catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["search_anchor"] },
    { "id": "search_anchor", "type": "AnchorPointNode", "name": "搜索结果锚点", "config": {
      "selectors": [ ".sm-offer-list", ".sm-offer", "#offer-list", ".offer-list", ".sm-offer-item", ".input-button .input-button-text", "span.input-button-text", "#img-search-upload", "input#img-search-upload" ],
      "requireVisible": true, "highlight": true, "persistHighlight": true
    }, "next": ["resolve_contact_key"] },
    { "id": "resolve_contact_key", "type": "JavaScriptExecutionNode", "name": "解析候选身份与公司名", "config": { "script": " (function(){ try{
  var idx = Number(window.__wwClickIndex||0)||0;
  function vis(el){ try{ var s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||Number(s.opacity)===0) return false; var r=el.getBoundingClientRect(); return r.width>18&&r.height>18&&r.y<innerHeight; }catch(e){ return false; } }
  function listCards(){ return Array.from(document.querySelectorAll(\".sm-offer-item, .offer-item, .sm-offer, [class*=offer]\")); }
  function pickCard(){ var cs=listCards(); return cs[idx]||cs[0]||document; }
  var card = pickCard();
  var a = card.querySelector(\"span.J_WangWang a.ww-link, a.ww-link[href*=air.1688.com], a.ww-link[href*=im.1688.com]\");
  var href = a ? (a.getAttribute('href')||a.href||'') : '';
  var uid='', offerId=null; try{ var u=new URL(href, location.href); var q=u.searchParams; uid=q.get('uid')||q.get('touid')||''; offerId=q.get('offerId')||q.get('offerid')||null; }catch(e){}
  var cname=''; try{ var sel=['.desc-text','.company-name','.shop-name','[data-spm*=company]']; for(var i=0;i<sel.length;i++){ var el=card.querySelector(sel[i]); if(el){ cname=(el.innerText||el.textContent||'').trim(); if(cname) break; } } }catch(e){}
  var key=(cname||uid||'')+':' + (offerId||'');
  if (a && vis(a)) a.setAttribute('data-webauto-send','1');
  return { success:true, variables:{ companyName:cname, contactUid:uid, contactOfferId:offerId, contactKey:key, chatUrl:href } };
}catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["check_history"] },
    { "id": "check_history", "type": "ContactHistoryNode", "name": "历史去重检查", "config": { "action": "check", "site": "1688", "keyVarName": "companyName" }, "next": ["dedup_condition"] },
    { "id": "dedup_condition", "type": "ConditionNode", "name": "是否已发送", "config": { "mode": "variable", "varName": "alreadySent", "operator": "==", "value": true }, "next": ["skip_open"], "error": ["open_chat"] },
    { "id": "skip_open", "type": "GateOverlayNode", "name": "跳过已发送对象", "config": { "title": "跳过已发送", "message": "该公司已发送过：{companyName}", "block": false }, "next": ["save"] },
    { "id": "open_chat", "type": "AdvancedClickNode", "name": "点击旺旺链接(只点)", "config": {
      "preset": "1688", "strategy": "prefer_mouse",
      "selector": "[data-webauto-send='1'], span.J_WangWang a.ww-link, a.ww-link.ww-inline, a.ww-link[href*=air.1688.com], a.ww-link[href*=im.1688.com]",
      "containerSelector": "body", "scrollIntoView": true, "verifyVisibility": true, "waitAfter": 1200,
      "verifyNavigation": false, "clickMethods": ["mouse_coordinates","playwright_click","event_simulation","javascript_click"],
      "preferChildTarget": false, "mouseMoveSteps": 18, "hoverMs": 120, "showCursorOverlay": true, "cursorColor": "#34c759", "highlightElement": true
    }, "next": ["wait_chat"] },
    { "id": "wait_chat", "type": "WaitNode", "name": "等待聊天页加载", "config": { "minMs": 1500, "maxMs": 2500 }, "next": ["attach_chat"] },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "air\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["dev_probe"] },
    { "id": "dev_probe", "type": "DevEvalNode", "name": "Dev 注入(整块标记)", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "filePath": "local-dev/chat-anchors-probe.js", "continueOnError": true }, "next": ["chat_anchor"] },
    { "id": "chat_anchor", "type": "AnchorPointNode", "name": "聊天页锚点", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "selectors": ["[data-webauto-input-area='1']", ".im-chat-input", "div[contenteditable]"], "requireVisible": true, "highlight": true, "persistHighlight": true }, "next": ["extract_company_chat"] },
    { "id": "extract_company_chat", "type": "JavaScriptExecutionNode", "name": "提取聊天公司名", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "script": "(function(){ try{ var el=document.querySelector('.companyName'); var name=el? (el.innerText||el.textContent||'').trim():''; return { success:true, variables:{ companyNameChat: name } }; }catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["compose"] },
    { "id": "compose", "type": "ChatComposeNode", "name": "输入‘你好’(不发送)", "config": { "hostFilter": "air.1688.com", "message": "你好", "send": false, "sendViaEnter": false, "stabilizeMs": 1200 }, "next": ["record_contact"] },
    { "id": "record_contact", "type": "ContactHistoryNode", "name": "记录发送对象", "config": { "action": "add", "site": "1688", "keyVarName": "companyName" }, "next": ["save"] },
    { "id": "save", "type": "ResultSaverNode", "name": "保存结果", "config": { "outputDir": "archive/workflow-records", "filenameTemplate": "1688-search-existing-chat-{timestamp}.json", "includeMetadata": true, "mergeData": true }, "next": ["close_chat"] },
    { "id": "close_chat", "type": "CloseHostPageNode", "name": "关闭聊天Tab", "config": { "hostIncludes": "air.1688.com", "closeAll": false }, "next": ["attach_back_search"] },
    { "id": "attach_back_search", "type": "AttachHostPageNode", "name": "切回搜索结果", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 10000 }, "next": ["end"] },
    { "id": "end", "type": "EndNode", "name": "结束", "config": { "cleanup": false, "saveLogs": true } }
  ],
  "globalConfig": { "logLevel": "info", "timeout": 600000 }
}

{
  "name": "1688 搜索页接力-只输入不发送(公司名去重)",
  "description": "在已打开的搜索结果页内去重并逐个打开聊天页，输入“你好”但不发送，保存历史并关闭Tab。",
  "version": "1.0.0",
  "variables": { "keyword": "钢化膜" },
  "nodes": [
    { "id": "start", "type": "StartNode", "name": "开始", "next": ["attach"] },
    { "id": "attach", "type": "AttachSessionNode", "name": "会话接力", "config": {}, "next": ["set_idx"] },
    { "id": "set_idx", "type": "JavaScriptExecutionNode", "name": "设置候选索引", "config": { "script": "(function(){ try{ var idx=Number(arguments[0]&&arguments[0].startIndex||0)||0; window.__wwClickIndex=idx; return { success:true, idx:idx }; }catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["search_anchor"] },
    { "id": "search_anchor", "type": "AnchorPointNode", "name": "搜索结果锚点", "config": {
      "selectors": [ ".sm-offer-list", ".sm-offer", "#offer-list", ".offer-list", ".sm-offer-item", ".input-button .input-button-text", "span.input-button-text", "#img-search-upload", "input#img-search-upload" ],
      "requireVisible": true, "highlight": true, "persistHighlight": true
    }, "next": ["resolve_contact_key"] },
    { "id": "resolve_contact_key", "type": "JavaScriptExecutionNode", "name": "解析候选身份与公司名", "config": { "script": "(function(){ try{\n  var idx=Number(window.__wwClickIndex||0)||0;\n  function vis(el){try{const s=getComputedStyle(el); if(s.display==='none'||s.visibility==='hidden'||+s.opacity===0) return false; const r=el.getBoundingClientRect(); return r.width>18&&r.height>18&&r.y<innerHeight;}catch{return false}}\n  function listCards(){return Array.from(document.querySelectorAll('.sm-offer-item, .offer-item, .sm-offer, [class*=offer]'));}\n  function pickCard(){var cs=listCards(); return cs[idx]||cs[0]||document;}\n  var card=pickCard();\n  var a=card.querySelector('span.J_WangWang a.ww-link, a.ww-link[href*=\\"air.1688.com\\"], a.ww-link[href*=\\"im.1688.com\\"]');\n  var href=a?(a.getAttribute('href')||a.href||''):'';\n  var uid='', offerId=null; try{ var u=new URL(href, location.href); var q=u.searchParams; uid=q.get('uid')||q.get('touid')||''; offerId=q.get('offerId')||q.get('offerid')||null; }catch(e){}\n  var cname=''; try{ var sel=['.desc-text','.company-name','.shop-name','[data-spm*=company]']; for(var i=0;i<sel.length;i++){ var el=card.querySelector(sel[i]); if(el){ cname=(el.innerText||el.textContent||'').trim(); if(cname) break; } } }catch(e){}\n  var key=(cname||uid||'')+':' + (offerId||'');\n  if (a && vis(a)) a.setAttribute('data-webauto-send','1');\n  return { success:true, variables:{ companyName:cname, contactUid:uid, contactOfferId:offerId, contactKey:key, chatUrl:href } };\n}catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["check_history"] },
    { "id": "check_history", "type": "ContactHistoryNode", "name": "历史去重检查", "config": { "action": "check", "site": "1688", "keyVarName": "companyName" }, "next": ["dedup_condition"] },
    { "id": "dedup_condition", "type": "ConditionNode", "name": "是否已发送", "config": { "mode": "variable", "varName": "alreadySent", "operator": "==", "value": true }, "next": ["skip_open"], "error": ["open_chat"] },
    { "id": "skip_open", "type": "GateOverlayNode", "name": "跳过已发送对象", "config": { "title": "跳过已发送", "message": "该公司已发送过：{companyName}", "block": false }, "next": ["save"] },
    { "id": "open_chat", "type": "AdvancedClickNode", "name": "点击旺旺链接(只点)", "config": {
      "preset": "1688", "strategy": "prefer_mouse",
      "selector": "[data-webauto-send='1'], span.J_WangWang a.ww-link, a.ww-link.ww-inline, a.ww-link[href*=air.1688.com], a.ww-link[href*=im.1688.com]",
      "containerSelector": "body", "scrollIntoView": true, "verifyVisibility": true, "waitAfter": 1200,
      "verifyNavigation": false, "clickMethods": ["mouse_coordinates","playwright_click","event_simulation","javascript_click"],
      "preferChildTarget": false, "mouseMoveSteps": 18, "hoverMs": 120, "showCursorOverlay": true, "cursorColor": "#34c759", "highlightElement": true
    }, "next": ["wait_chat"] },
    { "id": "wait_chat", "type": "WaitNode", "name": "等待聊天页加载", "config": { "minMs": 1500, "maxMs": 2500 }, "next": ["attach_chat"] },
    { "id": "attach_chat", "type": "AttachHostPageNode", "name": "附着聊天页", "config": { "urlPattern": "air\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 15000 }, "next": ["dev_probe"] },
    { "id": "dev_probe", "type": "DevEvalNode", "name": "Dev 注入(整块标记)", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "filePath": "local-dev/chat-anchors-probe.js", "continueOnError": true }, "next": ["chat_anchor"] },
    { "id": "chat_anchor", "type": "AnchorPointNode", "name": "聊天页锚点", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "selectors": ["[data-webauto-input-area='1']", ".im-chat-input", "div[contenteditable]"], "requireVisible": true, "highlight": true, "persistHighlight": true }, "next": ["extract_company_chat"] },
    { "id": "extract_company_chat", "type": "JavaScriptExecutionNode", "name": "提取聊天公司名", "config": { "frame": { "urlPattern": "def_cbu_web_im_core" }, "script": "(function(){ try{ var el=document.querySelector('.companyName'); var name=el? (el.innerText||el.textContent||'').trim():''; return { success:true, variables:{ companyNameChat: name } }; }catch(e){ return { success:false, error:String(e) }; } })();" }, "next": ["compose"] },
    { "id": "compose", "type": "ChatComposeNode", "name": "输入‘你好’(不发送)", "config": { "hostFilter": "air.1688.com", "message": "你好", "send": false, "sendViaEnter": false, "stabilizeMs": 1200 }, "next": ["record_contact"] },
    { "id": "record_contact", "type": "ContactHistoryNode", "name": "记录发送对象", "config": { "action": "add", "site": "1688", "keyVarName": "companyName" }, "next": ["save"] },
    { "id": "save", "type": "ResultSaverNode", "name": "保存结果", "config": { "outputDir": "archive/workflow-records", "filenameTemplate": "1688-search-existing-chat-{timestamp}.json", "includeMetadata": true, "mergeData": true }, "next": ["close_chat"] },
    { "id": "close_chat", "type": "CloseHostPageNode", "name": "关闭聊天Tab", "config": { "hostIncludes": "air.1688.com", "closeAll": false }, "next": ["attach_back_search"] },
    { "id": "attach_back_search", "type": "AttachHostPageNode", "name": "切回搜索结果", "config": { "urlPattern": "s\\.1688\\.com/.*", "bringToFront": true, "waitUntil": "domcontentloaded", "timeout": 10000 }, "next": ["end"] },
    { "id": "end", "type": "EndNode", "name": "结束", "config": { "cleanup": false, "saveLogs": true } }
  ],
  "globalConfig": { "logLevel": "info", "timeout": 600000 }
}

