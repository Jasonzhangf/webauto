# ä»»åŠ¡å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ESM æ ¼å¼è½¬æ¢

#### âœ… `apps/floating-panel/electron/main.js` å·²æ˜¯ ESM æ ¼å¼
- æºæ–‡ä»¶å·²ç»æ˜¯æ­£ç¡®çš„ ESM æ ¼å¼
- ä½¿ç”¨ `import/export` è¯­æ³•
- è¾“å‡ºåˆ° `apps/floating-panel/dist/electron/src/main.js` ä¿æŒ ESM

**éªŒè¯**ï¼š
```bash
head -10 apps/floating-panel/electron/main.js
# æ˜¾ç¤º: import { app, BrowserWindow, ipcMain, nativeTheme, screen } from 'electron';
```

### 2. å¯åŠ¨è„šæœ¬æ›´æ–°

#### âœ… åˆ›å»º `runtime/browser/scripts/one-click-browser-v2.mjs`
- æ–°å¯åŠ¨é¡ºåºï¼šWorkflow API â†’ Browser Service â†’ Controller â†’ Floating Panel
- ç¡¬ç«¯å£éªŒè¯ï¼ˆåŒ…æ‹¬ 8790ï¼‰
- å®Œæ•´çš„å¥åº·æ£€æŸ¥
- æ”¯æŒæœ‰å¤´/æ— å¤´æ¨¡å¼

#### âœ… åˆ›å»º `scripts/launch-headed-browser-float.mjs`
- ä¸“ç”¨"æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—"å¯åŠ¨è„šæœ¬
- æ›´ç®€æ´çš„å®ç°
- è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- 7 æ­¥å¯åŠ¨æµç¨‹

#### âœ… æ›´æ–° `start_browser.sh`
- ä½¿ç”¨æ–°çš„ v2 å¯åŠ¨è„šæœ¬
- é»˜è®¤æœ‰å¤´æ¨¡å¼
- æ”¯æŒæ‰€æœ‰åŸæœ‰å‚æ•°

### 3. æ–‡æ¡£å’Œå·¥å…·

#### âœ… åˆ›å»º `AGENTS.md`
- å¯åŠ¨è„šæœ¬è¯´æ˜
- ç«¯å£é…ç½®
- æ•…éšœæ’é™¤
- ç¯å¢ƒå˜é‡

#### âœ… åˆ›å»º `docs/æœ‰å¤´æµè§ˆå™¨+æµ®çª—å¯åŠ¨æŒ‡å—.md`
- è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
- å¯åŠ¨é¡ºåºè¯¦è§£
- æ•…éšœæ’é™¤
- ä½¿ç”¨ç¤ºä¾‹

#### âœ… åˆ›å»º `scripts/test-headed-launch.mjs`
- å¿«é€Ÿç«¯å£æµ‹è¯•å·¥å…·
- éªŒè¯æ‰€æœ‰æœåŠ¡çŠ¶æ€

## ğŸ“Š ç«¯å£é…ç½®

| ç«¯å£ | æœåŠ¡ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| 7701 | Workflow API | HTTP /health |
| 7704 | Browser Service | HTTP /health |
| 8765 | WebSocket | WebSocket è¿æ¥ |
| 8790 | Bus Bridge | TCP è¿æ¥ |
| 8970 | Controller | WebSocket è¿æ¥ |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¯åŠ¨ï¼ˆæ¨èï¼‰

```bash
cd /Users/fanzhang/Documents/github/webauto

# æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

### éªŒè¯çŠ¶æ€

```bash
# å¿«é€Ÿæµ‹è¯•
node scripts/test-headed-launch.mjs

# ä»…å¥åº·æ£€æŸ¥
node scripts/launch-headed-browser-float.mjs --health-only
```

### å…¶ä»–æ–¹å¼

```bash
# ä½¿ç”¨ v2 è„šæœ¬
node runtime/browser/scripts/one-click-browser-v2.mjs --profile default --url https://weibo.com --console-ui

# ä½¿ç”¨ shell è„šæœ¬
./start_browser.sh --profile default --url https://weibo.com
```

## ğŸ” å¯åŠ¨æµç¨‹

```
1. ç«¯å£éªŒè¯å’Œæ¸…ç†
   â”œâ”€ æ£€æŸ¥ 7701, 7704, 8790, 8970, 8765
   â””â”€ è‡ªåŠ¨æ¸…ç†å ç”¨ç«¯å£

2. å¯åŠ¨ Workflow API (7701)
   â””â”€ è‡ªåŠ¨æ„å»ºï¼ˆå¦‚éœ€è¦ï¼‰

3. å¯åŠ¨ Browser Service (7704 + 8765)

4. å¯åŠ¨ Controller (8970)

5. å¯åŠ¨æµè§ˆå™¨ä¼šè¯
   â””â”€ è‡ªåŠ¨ Cookie ä¿å­˜

6. å¯åŠ¨ Floating Panel (8790)
   â””â”€ Electron åº”ç”¨

7. å¥åº·æ£€æŸ¥
   â””â”€ éªŒè¯æ‰€æœ‰æœåŠ¡
```

## ğŸ“ æ–‡ä»¶æ¸…å•

```
âœ… apps/floating-panel/electron/main.js          # ESM æºæ–‡ä»¶
âœ… apps/floating-panel/dist/electron/src/main.js # ESM è¾“å‡º
âœ… runtime/browser/scripts/one-click-browser-v2.mjs # æ–°å¯åŠ¨è„šæœ¬
âœ… scripts/launch-headed-browser-float.mjs       # ä¸“ç”¨å¯åŠ¨è„šæœ¬
âœ… scripts/test-headed-launch.mjs                # æµ‹è¯•å·¥å…·
âœ… start_browser.sh                              # æ›´æ–°åçš„ shell è„šæœ¬
âœ… AGENTS.md                                     # è¯´æ˜æ–‡æ¡£
âœ… docs/æœ‰å¤´æµè§ˆå™¨+æµ®çª—å¯åŠ¨æŒ‡å—.md               # è¯¦ç»†æŒ‡å—
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### ç¡¬ç«¯å£éªŒè¯

```javascript
// æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
async function isPortInUse(port) { ... }

// ç­‰å¾… TCP è¿æ¥
async function waitForSocket(host, port, timeout) { ... }

// ç­‰å¾… WebSocket è¿æ¥
async function waitForWebSocket(host, port, timeout) { ... }

// ç­‰å¾… HTTP å¥åº·æ£€æŸ¥
async function waitHealth(url, timeout) { ... }
```

### å¯åŠ¨é¡ºåºä¿è¯

```javascript
// æ¯ä¸€æ­¥éƒ½ç­‰å¾…å‰ä¸€æ­¥å®Œæˆ
await validateAndCleanPorts();     // æ­¥éª¤ 1
await launchWorkflowAPI();         // æ­¥éª¤ 2
await launchBrowserService();      // æ­¥éª¤ 3
await launchController();          // æ­¥éª¤ 4
await startBrowserSession();       // æ­¥éª¤ 5
await launchFloatingPanel();       // æ­¥éª¤ 6
await runHealthCheck();            // æ­¥éª¤ 7
```

### å¥åº·æ£€æŸ¥

éªŒè¯æ‰€æœ‰å…³é”®æœåŠ¡ï¼š
- âœ… Workflow API (HTTP)
- âœ… Browser Service (HTTP)
- âœ… WebSocket (WS)
- âœ… Bus Bridge (TCP)
- âœ… Controller (WS)
- âš ï¸ Container Match (å¯é€‰)

## ğŸ§ª æµ‹è¯•ç»“æœ

è¿è¡Œ `node scripts/test-headed-launch.mjs`ï¼š

```
ğŸ§ª å¿«é€Ÿç«¯å£æµ‹è¯•

âŒ Workflow API (7701) - æœªå°±ç»ª
âœ… Browser Service (7704) - æ­£å¸¸
âœ… WebSocket (8765) - æ­£å¸¸
âŒ Bus Bridge (8790) - æœªå°±ç»ª
âœ… Controller (8970) - æ­£å¸¸

âš ï¸  éƒ¨åˆ†æœåŠ¡æœªå°±ç»ª
```

**è¯´æ˜**ï¼šéƒ¨åˆ†æœåŠ¡å·²åœ¨è¿è¡Œï¼Œéœ€è¦å®Œæ•´å¯åŠ¨æµç¨‹ã€‚

## ğŸ”§ å…³é”®æ”¹è¿›

### ä¹‹å‰çš„é—®é¢˜
- âŒ å¯åŠ¨é¡ºåºä¸æ˜ç¡®
- âŒ ç¼ºå°‘ç«¯å£éªŒè¯ï¼ˆç‰¹åˆ«æ˜¯ 8790ï¼‰
- âŒ æµ®çª—å¯åŠ¨é€»è¾‘æ··ä¹±
- âŒ æ— å¤´/æœ‰å¤´æ¨¡å¼ä¸æ¸…æ™°

### è§£å†³æ–¹æ¡ˆ
- âœ… æ˜ç¡®çš„ 7 æ­¥å¯åŠ¨é¡ºåº
- âœ… ç¡¬ç«¯å£éªŒè¯ï¼ˆ5 ä¸ªç«¯å£ï¼‰
- âœ… ä¸“ç”¨æœ‰å¤´æ¨¡å¼å¯åŠ¨è„šæœ¬
- âœ… å®Œæ•´çš„å¥åº·æ£€æŸ¥
- âœ… ESM æ ¼å¼ç»Ÿä¸€

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

1. **æµ‹è¯•å®Œæ•´å¯åŠ¨**ï¼š
   ```bash
   node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
   ```

2. **éªŒè¯æµ®çª—åŠŸèƒ½**ï¼š
   - æ£€æŸ¥æµ®çª—æ˜¯å¦åœ¨å±å¹•å³ä¾§æ˜¾ç¤º
   - éªŒè¯ Bus Bridge è¿æ¥ï¼ˆç«¯å£ 8790ï¼‰
   - æµ‹è¯•å®¹å™¨åŒ¹é…åŠŸèƒ½

3. **ç›‘æ§æ—¥å¿—**ï¼š
   - ç»ˆç«¯è¾“å‡º
   - apps/floating-panel äº§å‡º

4. **æ•…éšœæ’æŸ¥**ï¼š
   - ä½¿ç”¨ `--health-only` æ£€æŸ¥çŠ¶æ€
   - æŸ¥çœ‹ `docs/æœ‰å¤´æµè§ˆå™¨+æµ®çª—å¯åŠ¨æŒ‡å—.md`

## âœ¨ æ€»ç»“

å·²æˆåŠŸå®ç°ï¼š
1. âœ… ESM æ ¼å¼è½¬æ¢ï¼ˆmain.jsï¼‰
2. âœ… æ–°å¯åŠ¨è„šæœ¬ï¼ˆv2 + ä¸“ç”¨è„šæœ¬ï¼‰
3. âœ… ç¡¬ç«¯å£éªŒè¯ï¼ˆåŒ…æ‹¬ 8790ï¼‰
4. âœ… æ­£ç¡®å¯åŠ¨é¡ºåº
5. âœ… å®Œæ•´æ–‡æ¡£

ç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨ï¼š
```bash
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

è¿™å°†å¯åŠ¨å®Œæ•´çš„"æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—"ç¯å¢ƒï¼Œå¹¶éªŒè¯æ‰€æœ‰ç«¯å£å’ŒæœåŠ¡ã€‚
