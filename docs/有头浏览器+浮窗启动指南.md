# æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—å¯åŠ¨æŒ‡å—

## ğŸ¯ ç›®æ ‡

å®ç°å®Œæ•´çš„"æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—"å¯åŠ¨æµç¨‹ï¼ŒåŒ…å«ï¼š
- âœ… å¯åŠ¨é¡ºåºï¼šWorkflow API â†’ Browser Service â†’ Controller â†’ Floating Panel
- âœ… ç¡¬ç«¯å£éªŒè¯ï¼ˆåŒ…æ‹¬ 8790ï¼‰
- âœ… ESM æ ¼å¼æ”¯æŒ
- âœ… è‡ªåŠ¨å¥åº·æ£€æŸ¥

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä¸“ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /Users/fanzhang/Documents/github/webauto

# æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—ï¼ˆé»˜è®¤ï¼‰
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com

# æ— å¤´æ¨¡å¼
node scripts/launch-headed-browser-float.mjs --headless --profile default --url https://weibo.com

# ä»…å¥åº·æ£€æŸ¥
node scripts/launch-headed-browser-float.mjs --health-only
```

### æ–¹å¼äºŒï¼šæ›´æ–°åçš„ start_browser.sh

```bash
./start_browser.sh --profile default --url https://weibo.com
```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ v2 å¯åŠ¨è„šæœ¬

```bash
node runtime/browser/scripts/one-click-browser-v2.mjs --profile default --url https://weibo.com --console-ui
```

## ğŸ“‹ å¯åŠ¨é¡ºåºè¯¦è§£

```
ç¬¬1æ­¥: ç«¯å£éªŒè¯å’Œæ¸…ç†
   â”œâ”€ æ£€æŸ¥ç«¯å£ 7701 (Workflow API)
   â”œâ”€ æ£€æŸ¥ç«¯å£ 7704 (Browser Service)
   â”œâ”€ æ£€æŸ¥ç«¯å£ 8790 (Bus Bridge - æµ®çª—å…³é”®ç«¯å£)
   â”œâ”€ æ£€æŸ¥ç«¯å£ 8970 (Controller)
   â””â”€ æ£€æŸ¥ç«¯å£ 8765 (WebSocket)
   
ç¬¬2æ­¥: å¯åŠ¨ Workflow API (ç«¯å£ 7701)
   â””â”€ è·¯å¾„: dist/sharedmodule/engines/api-gateway/server.js
   â””â”€ å¦‚æœç¼ºå¤±ä¼šè‡ªåŠ¨æ‰§è¡Œ npm run build:services
   
ç¬¬3æ­¥: å¯åŠ¨ Browser Service (ç«¯å£ 7704)
   â””â”€ è·¯å¾„: libs/browser/remote-service.js
   â””â”€ WebSocket æœåŠ¡ (ç«¯å£ 8765)
   
ç¬¬4æ­¥: å¯åŠ¨ Controller (ç«¯å£ 8970)
   â””â”€ è·¯å¾„: runtime/infra/controller/controller.mjs
   â””â”€ è´Ÿè´£å®¹å™¨ç®¡ç†å’Œ DOM æ“ä½œ
   
ç¬¬5æ­¥: å¯åŠ¨æµè§ˆå™¨ä¼šè¯
   â””â”€ åˆ›å»ºæµè§ˆå™¨å®ä¾‹
   â””â”€ å¯ç”¨è‡ªåŠ¨ Cookie ä¿å­˜
   
ç¬¬6æ­¥: å¯åŠ¨ Floating Panel
   â””â”€ Electron åº”ç”¨: apps/floating-panel
   â””â”€ Bus Bridge: ç«¯å£ 8790
   
ç¬¬7æ­¥: å¥åº·æ£€æŸ¥
   â””â”€ éªŒè¯æ‰€æœ‰æœåŠ¡çŠ¶æ€
   â””â”€ æµ‹è¯•å®¹å™¨åŒ¹é…èƒ½åŠ›
```

## ğŸ” ç«¯å£è¯´æ˜

| ç«¯å£ | æœåŠ¡ | ç”¨é€” | çŠ¶æ€æ£€æŸ¥ |
|------|------|------|----------|
| 7701 | Workflow API | å·¥ä½œæµ API æœåŠ¡ | HTTP /health |
| 7704 | Browser Service | æµè§ˆå™¨æœåŠ¡ HTTP æ¥å£ | HTTP /health |
| 8765 | WebSocket | æµè§ˆå™¨ WebSocket æœåŠ¡ | WebSocket è¿æ¥ |
| **8790** | **Bus Bridge** | **æµ®çª—ä¸å¤–éƒ¨é€šä¿¡æ¡¥** | **TCP è¿æ¥** |
| 8970 | Controller | å®¹å™¨ç®¡ç†å’Œ DOM æ“ä½œ | WebSocket è¿æ¥ |

**å…³é”®ç«¯å£ 8790**ï¼šè¿™æ˜¯æµ®çª—ä¸å¤–éƒ¨é€šä¿¡çš„ WebSocket æ¡¥ï¼Œå¦‚æœæ­¤ç«¯å£æ— æ³•è¿æ¥ï¼Œæµ®çª—ä¼šå¡æ­»ã€‚

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: æ ‡å‡†å¯åŠ¨ï¼ˆæœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—ï¼‰

```bash
node scripts/launch-headed-browser-float.mjs \
  --profile default \
  --url https://weibo.com
```

**è¾“å‡º**ï¼š
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  WebAuto å¯åŠ¨å™¨ (æœ‰å¤´æµè§ˆå™¨ + æœ‰å¤´æµ®çª—)               â•‘
â•‘  å¯åŠ¨é¡ºåº: Workflow â†’ Browser â†’ Controller â†’ Float   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[1/6] éªŒè¯ç«¯å£çŠ¶æ€...
âœ… ç«¯å£ 7701 (Workflow API) ç©ºé—²
âœ… ç«¯å£ 7704 (Browser Service) ç©ºé—²
âœ… ç«¯å£ 8790 (Bus Bridge) ç©ºé—²
âœ… ç«¯å£ 8970 (Controller) ç©ºé—²
âœ… ç«¯å£ 8765 (WebSocket) ç©ºé—²

[2/6] å¯åŠ¨ Workflow API...
âœ… Workflow API å¯åŠ¨æˆåŠŸ

[3/6] å¯åŠ¨ Browser Service...
âœ… Browser Service å¯åŠ¨æˆåŠŸ

[4/6] å¯åŠ¨ Controller...
âœ… Controller å¯åŠ¨æˆåŠŸ

[5/6] å¯åŠ¨æµè§ˆå™¨ä¼šè¯ (profile=default, headless=false)...
âœ… æµè§ˆå™¨å·²å¯åŠ¨ (session=default)

[6/6] å¯åŠ¨ Floating Panel (æœ‰å¤´æ¨¡å¼: true)...
âœ… Floating Panel åå°è¿è¡Œ (PID: 12345)
âœ… Bus Bridge ç«¯å£ 8790 å¯ç”¨

ğŸ” è¿è¡Œå¥åº·æ£€æŸ¥...
âœ… Workflow API
âœ… Browser Service
âœ… WebSocket
âœ… Bus Bridge
âœ… Controller

ğŸ‰ æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œï¼
```

### ç¤ºä¾‹ 2: å¼€å‘æ¨¡å¼

```bash
# å¼€å‘æ¨¡å¼ï¼ˆå¼ºåˆ¶ headlessï¼‰
node scripts/launch-headed-browser-float.mjs \
  --dev-mode \
  --profile test \
  --url https://weibo.com
```

### ç¤ºä¾‹ 3: å¥åº·æ£€æŸ¥

```bash
# ä»…è¿è¡Œå¥åº·æ£€æŸ¥
node scripts/launch-headed-browser-float.mjs --health-only

# æˆ–ä½¿ç”¨ v2 è„šæœ¬
node runtime/browser/scripts/one-click-browser-v2.mjs --health-only
```

## âš™ï¸ ç¯å¢ƒå˜é‡

è‡ªå®šä¹‰ç«¯å£ï¼š

```bash
export WEBAUTO_FLOATING_BUS_PORT=8790
export WEBAUTO_WS_PORT=8765
export WORKFLOW_API_PORT=7701

node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜ 1: ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹å ç”¨
lsof -i :8790

# æ‰‹åŠ¨æ¸…ç†
lsof -ti :7701 :7704 :8790 :8970 :8765 | xargs kill -9

# æˆ–é‡æ–°è¿è¡Œè„šæœ¬ï¼ˆä¼šè‡ªåŠ¨æ¸…ç†ï¼‰
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

### é—®é¢˜ 2: Workflow API å¯åŠ¨å¤±è´¥

```bash
# æ£€æŸ¥æ„å»ºäº§ç‰©
ls -la dist/sharedmodule/engines/api-gateway/server.js

# æ‰‹åŠ¨æ„å»º
npm run build:services

# å†æ¬¡å¯åŠ¨
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

### é—®é¢˜ 3: æµ®çª—æ— æ³•è¿æ¥ï¼ˆå¡æ­»ï¼‰

æ£€æŸ¥ä»¥ä¸‹ç«¯å£ï¼š
```bash
# æ£€æŸ¥ Bus Bridge (å…³é”®ï¼)
lsof -i :8790

# æ£€æŸ¥ WebSocket
lsof -i :8765

# æ£€æŸ¥ Controller
lsof -i :8970
```

### é—®é¢˜ 4: æµ®çª—ä¸æ˜¾ç¤º

```bash
# ç¡®ä¿ä½¿ç”¨æœ‰å¤´æ¨¡å¼
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
# æ³¨æ„ï¼šæ²¡æœ‰ --headless å‚æ•°

# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $WEBAUTO_FLOATING_HEADLESS  # åº”è¯¥æ˜¯ 0 æˆ–æœªè®¾ç½®
```

## ğŸ“Š å¥åº·æ£€æŸ¥è¯¦è§£

å¥åº·æ£€æŸ¥ä¼šéªŒè¯ï¼š

1. âœ… **Workflow API** - HTTP /health ç«¯ç‚¹
2. âœ… **Browser Service** - HTTP /health ç«¯ç‚¹
3. âœ… **WebSocket** - ws://127.0.0.1:8765 è¿æ¥
4. âœ… **Bus Bridge** - TCP 127.0.0.1:8790 è¿æ¥
5. âœ… **Controller** - ws://127.0.0.1:8970 è¿æ¥
6. âš ï¸ **Container Match** - å®¹å™¨åŒ¹é…æµ‹è¯•ï¼ˆéœ€è¦ URLï¼‰

## ğŸ“ æ–‡ä»¶ç»“æ„

```
webauto/
â”œâ”€â”€ apps/floating-panel/
â”‚   â”œâ”€â”€ electron/
â”‚   â”‚   â””â”€â”€ main.js              # ESM æºæ–‡ä»¶
â”‚   â””â”€â”€ dist/electron/src/
â”‚       â””â”€â”€ main.js              # ESM è¾“å‡ºæ–‡ä»¶
â”œâ”€â”€ runtime/browser/scripts/
â”‚   â”œâ”€â”€ one-click-browser.mjs    # åŸå§‹è„šæœ¬
â”‚   â””â”€â”€ one-click-browser-v2.mjs # æ–°ç‰ˆè„šæœ¬ï¼ˆå¸¦ç¡¬éªŒè¯ï¼‰
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ launch-headed-browser-float.mjs  # ä¸“ç”¨å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ test-headed-launch.mjs   # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ start_browser.sh             # æ›´æ–°åçš„ shell è„šæœ¬
â””â”€â”€ AGENTS.md                    # è¯´æ˜æ–‡æ¡£
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ESM æ ¼å¼

æ‰€æœ‰è„šæœ¬ä½¿ç”¨ ESM (ECMAScript Modules)ï¼š
```javascript
import { app, BrowserWindow } from 'electron';
import path from 'node:path';
import fs from 'node:fs';
```

### ç¡¬ç«¯å£éªŒè¯

ä½¿ç”¨ `net.createConnection` å’Œ WebSocket è¿›è¡Œå®æ—¶éªŒè¯ï¼š
- TCP è¿æ¥æµ‹è¯•ï¼ˆBus Bridgeï¼‰
- WebSocket è¿æ¥æµ‹è¯•ï¼ˆController, WSï¼‰
- HTTP å¥åº·æ£€æŸ¥ï¼ˆWorkflow, Browser Serviceï¼‰

### å¯åŠ¨é¡ºåºä¿è¯

æ¯ä¸ªæ­¥éª¤éƒ½ä¼šç­‰å¾…å‰ä¸€æ­¥å®Œæˆï¼š
```javascript
await launchWorkflowAPI();
await launchBrowserService();
await launchController();
await startBrowserSession();
await launchFloatingPanel();
```

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•å¯åŠ¨**ï¼š
   ```bash
   node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
   ```

2. **éªŒè¯è¿è¡Œ**ï¼š
   ```bash
   node scripts/test-headed-launch.mjs
   ```

3. **æŸ¥çœ‹æ—¥å¿—**ï¼š
   - ç»ˆç«¯è¾“å‡º
   - apps/floating-panel ç›®å½•

4. **æ£€æŸ¥æµ®çª—**ï¼š
   - åº”è¯¥åœ¨å±å¹•å³ä¾§æ˜¾ç¤º
   - å¯ä»¥ä¸æµè§ˆå™¨äº¤äº’

## âœ… æˆåŠŸæ ‡å¿—

å¯åŠ¨æˆåŠŸåä½ åº”è¯¥çœ‹åˆ°ï¼š

- [ ] ç»ˆç«¯æ˜¾ç¤ºæ‰€æœ‰ âœ… ç»¿è‰²æˆåŠŸæ¶ˆæ¯
- [ ] æµè§ˆå™¨çª—å£æ‰“å¼€ï¼ˆæœ‰å¤´æ¨¡å¼ï¼‰
- [ ] æµ®çª—çª—å£åœ¨å±å¹•å³ä¾§æ˜¾ç¤º
- [ ] ç«¯å£ 8790 å¯ç”¨ï¼ˆ`lsof -i :8790`ï¼‰
- [ ] å¥åº·æ£€æŸ¥å…¨éƒ¨é€šè¿‡

å¦‚æœé‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ AGENTS.md æˆ–è¿è¡Œ `--health-only` è¿›è¡Œè¯Šæ–­ã€‚
