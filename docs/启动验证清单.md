# 有头浏览器启动验证清单

## ✅ 已实现功能

### 1. **完整启动流程** (7步)
```
第1步: 端口验证和清理
第2步: 启动 Workflow API (7701)
第3步: 启动 Browser Service (7704)
第4步: 启动 Controller (8970)
第5步: 启动浏览器会话
第6步: 启动 Floating Panel (8790)
第7步: 模块健康检查
```

### 2. **模块健康检查**
- ✅ Workflow API (HTTP /health)
- ✅ Browser Service (HTTP /health)
- ✅ WebSocket (8765)
- ✅ Bus Bridge (8790) - 浮窗关键端口
- ✅ Controller (8970)

### 3. **根容器匹配验证**
- ✅ 自动检测 URL (仅对 weibo.com)
- ✅ WebSocket 调用容器匹配
- ✅ 显示容器名称和 ID
- ✅ 验证匹配成功率

### 4. **DOM 树验证**
- ✅ Controller 调用容器检查
- ✅ 显示容器数量
- ✅ 验证 DOM 结构

### 5. **浮窗连接验证**
- ✅ Bus Bridge 端口可连接性
- ✅ WebSocket 通信测试

## 📊 验证流程

### 完整启动验证

```bash
# 方式 1: 专用启动脚本（推荐）
node scripts/launch-headed-browser-float.mjs \
  --profile default \
  --url https://weibo.com

# 预期输出：
# ╔════════════════════════════════════════════════════════╗
# ║  WebAuto 启动器 (有头浏览器 + 有头浮窗)               ║
# ║  启动顺序: Workflow → Browser → Controller → Float   ║
# ╚════════════════════════════════════════════════════════╝
# 
# [1/6] 验证端口状态...
# ✅ 端口 7701 (Workflow API) 空闲
# ✅ 端口 7704 (Browser Service) 空闲
# ✅ 端口 8790 (Bus Bridge) 空闲
# ✅ 端口 8970 (Controller) 空闲
# ✅ 端口 8765 (WebSocket) 空闲
# 
# [2/6] 启动 Workflow API...
# ✅ Workflow API 启动成功
# 
# [3/6] 启动 Browser Service...
# ✅ Browser Service 启动成功
# 
# [4/6] 启动 Controller...
# ✅ Controller 启动成功
# 
# [5/6] 启动浏览器会话 (profile=default, headless=false)...
# ✅ 浏览器已启动 (session=default)
# 
# [6/6] 启动 Floating Panel (有头模式: true)...
# ✅ Floating Panel 后台运行 (PID: 12345)
# ✅ Bus Bridge 端口 8790 可用
# 
# ============================================================
# 【第 7 步】模块健康检查
# ============================================================
# 🔍 运行模块健康检查...
# ✅ Workflow API
# ✅ Browser Service
# ✅ WebSocket
# ✅ Bus Bridge
# ✅ Controller
# ✅ 所有模块健康检查通过！
# 
# ============================================================
# 【第 8 步】根容器匹配验证
# ============================================================
# 🧪 验证根容器匹配...
# ✅ 根容器匹配成功
#    - 容器名称: 微博首页
#    - 容器ID: weibo-homepage
# 
# ============================================================
# 【第 9 步】DOM 树结构验证
# ============================================================
# 🧪 验证 DOM 树结构...
# ✅ DOM 树验证通过 (5 个容器)
# 
# ============================================================
# 【第 10 步】浮窗连接验证
# ============================================================
# 🧪 验证浮窗连接...
# ✅ Bus Bridge (端口 8790) 可连接
# 
# ============================================================
# 【最终结果】
# ============================================================
# 🎉 启动成功！所有模块健康，根容器匹配正常！
# 
# ✅ 验证通过项:
#    - 模块健康检查
#    - 根容器匹配 (微博首页)
#    - DOM 树结构
#    - 浮窗连接
#    - WebSocket 通信
```

### 快速验证（已启动后）

```bash
# 检查当前服务状态
node scripts/verify-headed-launch.mjs --profile default --url https://weibo.com

# 预期输出：
# ╔════════════════════════════════════════════════════════╗
# ║  快速验证：模块健康 + 根容器匹配                      ║
# ╚════════════════════════════════════════════════════════╝
# 
# [1] 检查端口...
#   ✅ Workflow API (7701) - 运行中
#   ✅ Browser Service (7704) - 运行中
#   ✅ Bus Bridge (8790) - 运行中
#   ✅ Controller (8970) - 运行中
#   ✅ WebSocket (8765) - 运行中
# 
# [2] 检查 HTTP 服务...
#   ✅ Workflow API - 健康
#   ✅ Browser Service - 健康
# 
# [3] 检查 WebSocket...
#   ✅ WebSocket (端口 8765) - 连接正常
# 
# [4] 检查 Bus Bridge (浮窗关键端口)...
#   ✅ Bus Bridge (端口 8790) - 可连接
# 
# [5] 检查 Controller...
#   ✅ Controller (端口 8970) - 连接正常
# 
# [6] 根容器匹配验证...
#   ✅ 根容器匹配成功: 微博首页
# 
# [7] DOM 树结构验证...
#   ✅ DOM 树验证通过 (5 个容器)
# 
# ============================================================
# 【验证总结】
# ============================================================
# 🎉 全部通过 (7/7)
# 
# ✅ 有头浏览器 + 有头浮窗运行正常！
```

### 仅健康检查

```bash
# 使用 v2 脚本
node runtime/browser/scripts/one-click-browser-v2.mjs \
  --profile default \
  --url https://weibo.com \
  --health-only

# 或使用专用脚本
node scripts/launch-headed-browser-float.mjs \
  --profile default \
  --url https://weibo.com
```

## 🔍 关键端口说明

| 端口 | 服务 | 验证方式 | 重要性 |
|------|------|----------|--------|
| 7701 | Workflow API | HTTP /health | ⭐⭐⭐ |
| 7704 | Browser Service | HTTP /health | ⭐⭐⭐ |
| 8765 | WebSocket | WebSocket 连接 | ⭐⭐⭐ |
| **8790** | **Bus Bridge** | **TCP 连接** | **⭐⭐⭐⭐⭐** |
| 8970 | Controller | WebSocket 连接 | ⭐⭐⭐ |

**Bus Bridge (8790)** 是浮窗与外部通信的关键端口，如果无法连接，浮窗会卡死。

## 📋 验证项目清单

### ✅ 启动后自动检查

- [ ] 所有端口可连接
- [ ] HTTP 服务健康
- [ ] WebSocket 连接正常
- [ ] Bus Bridge 可连接
- [ ] Controller 响应正常
- [ ] 浏览器会话活跃
- [ ] 浮窗进程存在
- [ ] 根容器匹配成功（微博 URL）
- [ ] DOM 树结构完整

### ✅ 功能验证

- [ ] 浏览器窗口打开（有头模式）
- [ ] 浮窗窗口显示
- [ ] WebSocket 通信正常
- [ ] 容器匹配正确
- [ ] DOM 操作可用
- [ ] Cookie 自动保存

## 🛠️ 故障排查

### 问题：端口占用

```bash
# 查看占用
lsof -i :8790

# 清理端口
lsof -ti :7701 :7704 :8790 :8970 :8765 | xargs kill -9

# 重新启动
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

### 问题：根容器匹配失败

```bash
# 1. 检查浏览器是否正常
curl http://127.0.0.1:7704/health

# 2. 检查 WebSocket
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Host: 127.0.0.1:8765" -H "Origin: http://127.0.0.1:8765" http://127.0.0.1:8765/

# 3. 手动测试匹配
node scripts/verify-headed-launch.mjs --profile default --url https://weibo.com
```

### 问题：浮窗不显示

```bash
# 检查 Bus Bridge
lsof -i :8790

# 检查浮窗进程
ps aux | grep floating-panel

# 重新启动浮窗
cd apps/floating-panel
WEBAUTO_FLOATING_HEADLESS=0 npm run dev
```

## 🎯 成功标志

启动成功后你应该看到：

1. **终端输出**：
   - ✅ 所有步骤显示绿色成功
   - ✅ 模块健康检查全部通过
   - ✅ 根容器匹配成功
   - ✅ DOM 树验证通过

2. **系统状态**：
   - ✅ 浏览器窗口打开
   - ✅ 浮窗窗口在屏幕右侧
   - ✅ 端口 8790 可用
   - ✅ WebSocket 连接正常

3. **功能测试**：
   - ✅ 可以在浮窗中操作
   - ✅ 容器树正确显示
   - ✅ DOM 操作响应正常

## 📝 使用建议

### 日常开发

```bash
# 完整启动（推荐）
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com

# 验证状态
node scripts/verify-headed-launch.mjs --profile default --url https://weibo.com
```

### 调试

```bash
# 查看详细日志
export DEBUG=1
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com

# 仅检查端口
lsof -i :7701,7704,8790,8970,8765
```

## ✨ 总结

现在启动"有头浏览器 + 有头浮窗"会自动：

1. ✅ **启动所有服务**（7步流程）
2. ✅ **验证模块健康**（5个模块）
3. ✅ **验证根容器匹配**（自动检测）
4. ✅ **验证 DOM 树**（容器结构）
5. ✅ **验证浮窗连接**（Bus Bridge）

使用命令：
```bash
node scripts/launch-headed-browser-float.mjs --profile default --url https://weibo.com
```

这将启动完整的有头环境，并自动执行所有健康检查和容器匹配验证。
