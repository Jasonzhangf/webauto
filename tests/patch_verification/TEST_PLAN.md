# apply_patch 工具完整测试计划

## 测试目标

验证 `apply_patch` 工具在各种场景下的正确性和鲁棒性，确保其在正常和边界情况下都能正确应用补丁。

## 测试环境

- 工作目录：`/Users/fanzhang/Documents/github/webauto/tests/patch_verification/`
- 源文件目录：`test_files/`
- 预期输出目录：`expected/`
- 实际输出目录：`actual/`

## 测试用例分类

### 阶段 1：基础功能测试

#### T1.1 简单文本替换
**目标**：验证最基本的单行文本替换
- **操作**：将文件中的 "hello" 替换为 "world"
- **验证点**：
  - 目标文本被正确替换
  - 文件其他部分保持不变
  - 无多余内容插入

#### T1.2 多行文本替换
**目标**：验证连续多行文本的替换
- **操作**：将 3-5 行连续文本替换为新的多行内容
- **验证点**：
  - 所有目标行被替换
  - 保持原有缩进
  - 行尾换行符正确

#### T1.3 单行插入（行首）
**目标**：验证在文件开头插入新内容
- **操作**：在第一行之前插入新行
- **验证点**：
  - 新内容正确插入
  - 原有内容顺序保持

#### T1.4 单行插入（行尾）
**目标**：验证在文件末尾追加新内容
- **操作**：在最后一行之后添加新行
- **验证点**：
  - 新内容正确追加
  - 不影响原有内容

#### T1.5 单行插入（中间）
**目标**：验证在文件中间位置插入新行
- **操作**：在指定行后插入新内容
- **验证点**：
  - 插入位置准确
  - 前后内容保持不变

#### T1.6 单行删除
**目标**：验证删除指定行
- **操作**：删除文件中的某一行
- **验证点**：
  - 目标行被删除
  - 前后内容正确连接
  - 无多余空行

### 阶段 2：代码编辑测试

#### T2.1 函数内容替换
**目标**：验证替换函数体内的代码块
- **操作**：替换一个完整函数的实现
- **验证点**：
  - 函数签名保持不变
  - 函数体被完整替换
  - 缩进格式正确

#### T2.2 添加新函数
**目标**：验证在现有代码中添加新函数
- **操作**：在文件末尾添加一个新的完整函数
- **验证点**：
  - 新函数格式正确
  - 不影响原有函数
  - 符合语言语法

#### T2.3 修改配置文件
**目标**：验证对 JSON/YAML 配置文件的修改
- **操作**：修改配置项的值
- **验证点**：
  - 配置项被正确更新
  - JSON/YAML 语法有效
  - 其他配置项保持不变

#### T2.4 导入语句添加
**目标**：验证在文件头部添加 import 语句
- **操作**：在现有 import 语句后添加新的 import
- **验证点**：
  - 新 import 语句位置正确
  - 符合语言规范
  - 不破坏现有导入

#### T2.5 注释修改
**目标**：验证对注释内容的修改
- **操作**：修改文件中的多行注释
- **验证点**：
  - 注释内容正确更新
  - 注释格式保持

### 阶段 3：边界条件测试

#### T3.1 空文件操作
**目标**：验证对空文件的编辑
- **操作**：向空文件中添加内容
- **验证点**：
  - 内容正确添加
  - 文件结构有效

#### T3.2 大文件操作
**目标**：验证对较大文件的处理能力
- **操作**：修改 1000+ 行文件中的内容
- **验证点**：
  - 修改位置准确
  - 文件其他部分不受影响
  - 性能可接受

#### T3.3 特殊字符处理
**目标**：验证对特殊字符的处理
- **操作**：包含以下字符的文本替换
  - 引号（单引号、双引号、反引号）
  - 反斜杠
  - 正则表达式模式
  - Unicode 字符
  - HTML 标签
- **验证点**：
  - 特殊字符正确保留
  - 转义符正确处理

#### T3.4 重复文本处理
**目标**：验证当文件中存在多个相同文本时的处理
- **操作**：替换文件中出现多次的相同文本
- **验证点**：
  - 只替换指定的那一个
  - 其他重复文本保持不变

#### T3.5 缩进处理
**目标**：验证对各种缩进格式的处理
- **操作**：修改带有不同缩进层次的代码
  - 2 空格缩进
  - 4 空格缩进
  - Tab 缩进
  - 混合缩进
- **验证点**：
  - 缩进格式保持一致
  - 新内容缩进正确

#### T3.6 换行符处理
**目标**：验证对不同换行符的处理
- **操作**：
  - LF (Unix) 文件编辑
  - CRLF (Windows) 文件编辑
  - 混合换行符文件编辑
- **验证点**：
  - 换行符正确处理
  - 不引入不一致的换行符

### 阶段 4：复杂场景测试

#### T4.1 多处修改
**目标**：验证在同一文件中进行多处修改
- **操作**：在一个补丁中修改文件的多个不同位置
- **验证点**：
  - 所有修改都正确应用
  - 修改之间不相互干扰

#### T4.2 跨行块操作
**目标**：验证跨越多个非连续行的块操作
- **操作**：选择并替换不连续的多行（如第 10-12 行和第 20-22 行）
- **验证点**：
  - 所有目标行都被处理
  - 中间行保持不变

#### T4.3 代码重构场景
**目标**：模拟真实的代码重构操作
- **操作**：将一个函数拆分成多个小函数
- **验证点**：
  - 代码结构正确
  - 功能等价
  - 格式规范

#### T4.4 文档字符串修改
**目标**：验证对多行文档字符串的修改
- **操作**：修改 JSDoc/Python docstring 类型的文档注释
- **验证点**：
  - 文档内容正确更新
  - 格式保持

#### T4.5 条件编译指令
**目标**：验证对预处理指令的修改
- **操作**：修改 #ifdef/#ifndef 等条件编译块
- **验证点**：
  - 指令正确更新
  - 块结构保持

### 阶段 5：错误处理测试

#### T5.1 文件不存在
**目标**：验证当目标文件不存在时的处理
- **操作**：尝试对不存在的文件应用补丁
- **预期结果**：返回清晰的错误信息

#### T5.2 内容不匹配
**目标**：验证当待替换内容在文件中不存在时的处理
- **操作**：替换一个不存在的文本
- **预期结果**：返回清晰的错误信息

#### T5.3 权限错误
**目标**：验证当无文件写入权限时的处理
- **操作**：尝试修改只读文件
- **预期结果**：返回清晰的错误信息

#### T5.4 语法破坏
**目标**：验证补丁可能导致语法错误时的处理
- **操作**：应用一个会导致语法错误的补丁
- **预期结果**：工具应能应用但给出警告

#### T5.5 并发修改
**目标**：验证文件已被其他进程修改时的处理
- **操作**：在文件被外部修改后应用补丁
- **预期结果**：检测到冲突并报错

## 测试执行流程

### 准备阶段
1. 创建测试目录结构
2. 为每个测试用例生成：
   - 原始测试文件（test_files/）
   - 预期结果文件（expected/）
   - 补丁定义文件（patches/）

### 执行阶段
对每个测试用例：
1. 复制原始文件到工作区
2. 记录文件初始状态
3. 应用补丁
4. 记录文件结果状态
5. 比较实际结果与预期结果
6. 记录测试结果

### 验证阶段
对每个测试用例验证：
- 文件内容是否与预期完全一致
- 文件编码是否正确
- 换行符是否一致
- 文件权限是否合理
- 是否有意外的副作用

### 报告阶段
生成测试报告包含：
- 每个测试用例的执行状态（通过/失败）
- 失败测试用例的详细差异
- 性能指标（执行时间）
- 错误日志
- 总体统计（通过率、失败率）

## 测试数据示例

### T1.1 测试数据
**原始文件** (test_files/simple_replace.txt):
```
hello world
this is a test
hello again
```

**补丁**:
```
hello -> world
```

**预期结果** (expected/simple_replace_result.txt):
```
world world
this is a test
world again
```

### T2.1 测试数据
**原始文件** (test_files/function_replace.ts):
```typescript
function greet(name: string) {
  console.log("Hello, " + name);
  return name;
}
```

**补丁**:
```
function greet(name: string) {
  console.log("Hello, " + name);
  return name;
} ->
function greet(name: string) {
  const message = `Hello, ${name}`;
  console.log(message);
  return message;
}
```

**预期结果** (expected/function_replace_result.ts):
```typescript
function greet(name: string) {
  const message = `Hello, ${name}`;
  console.log(message);
  return message;
}
```

## 成功标准

- ✅ 所有阶段 1 测试用例 100% 通过
- ✅ 所有阶段 2 测试用例 100% 通过
- ✅ 阶段 3 测试用例至少 90% 通过
- ✅ 阶段 4 测试用例至少 80% 通过
- ✅ 阶段 5 错误处理测试能够正确识别和报告错误

## 测试工具

建议实现以下辅助工具：
1. `test_runner.mjs` - 自动化测试执行器
2. `file_comparator.mjs` - 文件内容对比工具
3. `patch_generator.mjs` - 根据差异自动生成补丁定义
4. `report_generator.mjs` - 测试报告生成器

