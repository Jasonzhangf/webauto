# Codex apply_patch 工具验证方案

## 目标
验证 Codex 的 `functions.apply_patch` 能够可靠地修改代码文件

## 测试策略
每个测试独立执行，按顺序验证不同场景

---

## 测试执行计划

### Phase 1: 基础操作 (必须100%通过)

**TEST-01: 创建新文件**
- 操作: 创建一个新的空文件并添加内容
- 验证: 文件存在且内容正确

**TEST-02: 单行替换**
- 操作: 替换文件中的一行文本
- 验证: 目标行被替换，其他行不变

**TEST-03: 多行替换**
- 操作: 替换连续的多行文本
- 验证: 所有目标行被替换，前后行不变

**TEST-04: 文件中间插入**
- 操作: 在文件中间位置插入新内容
- 验证: 新内容插入正确位置，原有内容完整

**TEST-05: 文件末尾追加**
- 操作: 在文件末尾添加新行
- 验证: 新内容追加成功

---

### Phase 2: 代码场景 (必须100%通过)

**TEST-06: 替换函数实现**
- 操作: 替换整个函数体
- 验证: 函数被完整替换，语法正确

**TEST-07: 添加 import 语句**
- 操作: 在现有 import 后添加新 import
- 验证: import 顺序正确

**TEST-08: 修改对象属性**
- 操作: 修改 JSON/对象中的某个属性值
- 验证: 目标属性被修改，其他属性不变

**TEST-09: 添加类方法**
- 操作: 在类中添加新方法
- 验证: 新方法添加成功，类结构完整

---

### Phase 3: 边界场景 (≥90%通过)

**TEST-10: 特殊字符**
- 操作: 处理包含 `"` `'` `\` `/` 等特殊字符的内容
- 验证: 特殊字符不被破坏

**TEST-11: 保持缩进**
- 操作: 修改带缩进的代码
- 验证: 缩进格式保持一致

**TEST-12: 大块内容替换**
- 操作: 替换超过10行的大块代码
- 验证: 替换准确，性能可接受

---

### Phase 4: 错误处理 (必须正确报错)

**TEST-13: 文件不存在**
- 操作: 尝试修改不存在的文件
- 验证: 返回清晰错误信息

**TEST-14: 内容不匹配**
- 操作: 尝试替换不存在的内容
- 验证: 返回清晰错误信息

---

## 执行方式

我会逐个测试执行：
1. 准备测试文件（通过 shell）
2. 应用补丁（调用 apply_patch）
3. 验证结果（读取文件内容）
4. 报告状态（✓ PASS / ✗ FAIL）
5. 继续下一个测试

所有测试文件在 `tests/patch_verification/temp_test_files/` 目录下

## 成功标准
- Phase 1: 5/5 通过
- Phase 2: 4/4 通过
- Phase 3: ≥3/3 通过
- Phase 4: 2/2 正确报错

**总计: ≥13/14 通过**

